;********************************************************************
;******      ER550.s03 ASM SOURCE FILE   ASM VER 2.1         ******
;******      ER-550   startup 1996.06           1996.06.24     ******
;********************************************************************
;********************************************************************
              NAME       CSTARTUP            ;
$DEFMB.INC                                   ;
$ER1TABLE                                    ;
;********************************************;
REAL_ROM   equ 1
              public          pkr_cpy
              $DEFFN          pkr_cpy(0,0,0,0,0,0,0,0)
              public          pkr_cpyc
              $DEFFN          pkr_cpyc(0,0,0,0,0,0,0,0)
              public          clr_lcd
              $DEFFN          clr_lcd(0,0,0,0,0,0,0,0)
              public          lcdwrt1
              $DEFFN          lcdwrt1(0,0,0,0,0,0,0,0)
              public          lcdwrt2
              $DEFFN          lcdwrt2(0,0,0,0,0,0,0,0)
              ;  public          dsp_logo1
              ;  $DEFFN          dsp_logo1(0,0,0,0,0,0,0,0)
              ;  public          dsp_logo2
              ;  $DEFFN          dsp_logo2(0,0,0,0,0,0,0,0)
              public     clr_num             ;
              $DEFFN     clr_num(0,0,0,0,0,0,0,0)
              public     init_mdchg          ;
              $DEFFN     init_mdchg(0,0,0,0,0,0,0,0)
              public     init_omode          ;
              $DEFFN     init_omode(0,0,0,0,0,0,0,0)
              public     compdchk            ;drawer opn check
              $DEFFN     compdchk(0,0,0,0,0,0,0,0)
              public     endclr              ;
              $DEFFN     endclr(0,0,0,0,0,0,0,0)
              public     exramclr            ;
              $DEFFN     exramclr(0,0,0,0,0,0,0,0)
              public     modescan            ;
              $DEFFN     modescan(0,0,0,0,0,0,0,0)
;              public     testmscan           ;
;              $DEFFN     testmscan(0,0,0,0,0,0,0,0)
              public     erroron             ;
              $DEFFN     erroron(0,0,0,0,0,0,0,0)
              public     keyscan             ;
              $DEFFN     keyscan(0,0,0,0,0,0,0,0)
              public     feedkscan             ;
              $DEFFN     feedkscan(0,0,0,0,0,0,0,0)
              public     feeding
              $DEFFN     feeding(0,0,0,0,0,0,0,0)
              public     feeding1
              $DEFFN     feeding1(0,0,0,0,0,0,0,0)
              public     rtc_read            ;
              $DEFFN     rtc_read(0,0,0,0,0,0,0,0)
              public     rtc_write           ;
              $DEFFN     rtc_write(0,0,0,0,0,0,0,0)
              public     outdtx              ;
              $DEFFN     outdtx(0,0,0,0,0,0,0,0)
              public     inidtx              ;
              $DEFFN     inidtx(0,0,0,0,0,0,0,0)
              public     r232chk                 ;
              $DEFFN     r232chk(0,0,0,0,0,0,0,0)
              public     prn                 ;
              $DEFFN     prn(0,0,0,0,0,0,0,0)
              public     initky              ;
              $DEFFN     initky(0,0,0,0,0,0,0,0)
              public     initseq             ;
              $DEFFN     initseq(0,0,0,0,0,0,0,0)
              public     loadseq             ;
              $DEFFN     loadseq(0,0,0,0,0,0,0,0)
              public     saveseq             ;
              $DEFFN     saveseq(0,0,0,0,0,0,0,0)
              public     drawopn             ;
              $DEFFN     drawopn(0,0,0,0,0,0,0,0)
              public     cnbclr              ;
              $DEFFN     cnbclr(0,0,0,0,0,0,0,0)
              public     pend_chk            ;
              $DEFFN     pend_chk(0,0,0,0,0,0,0,0)
              public     sumchk              ;
              $DEFFN     sumchk(0,0,0,0,0,0,0,0)
              ;                              ;
;              public     sep_long            ;
;              $DEFFN     sep_long(0,0,0,0,0,0,0,0)
;              public     com_long            ;
;              $DEFFN     com_long(0,0,0,0,0,0,0,0)
;              public     sep_int             ;
;              $DEFFN     sep_int(0,0,0,0,0,0,0,0)
;              public     com_int             ;
;              $DEFFN     com_int(0,0,0,0,0,0,0,0)
              public     clr_ex0             ;
              $DEFFN     clr_ex0(0,0,0,0,0,0,0,0)
              public     set_ex0             ;
              $DEFFN     set_ex0(0,0,0,0,0,0,0,0)
              ;                              ;
              public     rflg_init           ;
              $DEFFN     rflg_init(0,0,0,0,0,0,0,0)
              public     sio_trans           ;
              $DEFFN     sio_trans(0,0,0,0,0,0,0,0)
              public     sio_trans1           ;
              $DEFFN     sio_trans1(0,0,0,0,0,0,0,0)
              public     sio_rvlp            ;
              $DEFFN     sio_rvlp(0,0,0,0,0,0,0,0)
              public     slip_trans          ;
              $DEFFN     slip_trans(0,0,0,0,0,0,0,0)
              public     modem_trans          ;
              $DEFFN     modem_trans(0,0,0,0,0,0,0,0)
              public     scale_trans          ;
              $DEFFN     scale_trans(0,0,0,0,0,0,0,0)
;              public     test_chk          ;
;              $DEFFN     test_chk(0,0,0,0,0,0,0,0)
;              public     sp_trans452         ;
;              $DEFFN     sp_trans452(0,0,0,0,0,0,0,0)
;              public     sc_trans452          ;
;              $DEFFN     sc_trans452(0,0,0,0,0,0,0,0)
;              public     pc_trans452          ;
;              $DEFFN     pc_trans452(0,0,0,0,0,0,0,0)
              ;                              ;
              public     rd_clear             ;
              $DEFFN     rd_clear(0,0,0,0,0,0,0,0)
              public     fs_read             ;
              $DEFFN     fs_read(0,0,0,0,0,0,0,0)
              public     fst_write           ;
              $DEFFN     fst_write(0,0,0,0,0,0,0,0)
;              public     write_0             ;
;              $DEFFN     write_0(0,0,0,0,0,0,0,0)
;              public     read_0             ;
;              $DEFFN     read_0(0,0,0,0,0,0,0,0)
;              public     write_1             ;
;              $DEFFN     write_1(0,0,0,0,0,0,0,0)
;              public     read_1             ;
;              $DEFFN     read_1(0,0,0,0,0,0,0,0)
              ;
              public     exit                ;
              $DEFFN     exit(0,0,0,0,0,0,0,0)
              public     fnt_tbll            ;
              $DEFFN     fnt_tbll(0,0,0,0,0,0,0,0)
;;              public     dsp_scr             ;
;;              $DEFFN     dsp_scr(0,0,0,0,0,0,0,0)

              PUBLIC     ?X_CALL_L18         ; PKR0624

              extern     _r                  ;
              extern     main                ;
              extern     liq_cpy             ;
              extern     sv_lcd1             ;
;*********************************************
; stack define                               *
;*********************************************
;---------------------------------------------------------------;
; The C stack segment. Should be mapped into internal data RAM  ;
;---------------------------------------------------------------;
; The C stack is used for LCALL's and temporary storage for     ;
; code generator help-routines (math etc).  The stack will be   ;
; located after all other internal RAM variables if the stan-   ;
; dard linking procedure is followed.  Note that C interrupt    ;
; routines can double stack size demands.                       ;
;---------------------------------------------------------------;
              RSEG    CSTACK                 ;
stack_begin:                                 ;
              ds         135                 ;
                                             ;
;*********************************************
; intr vecter table                          *
;*********************************************
;---------------------------------------------------------------;
; C interrupt routines with defined [vectors] will reserve      ;
; space in this area.  So will handlers written in assembler if ;
; they follow the recommended format.                           ;
;---------------------------------------------------------------;
                COMMON  INTVEC                  ; Should be at location zero
startup:                                        ;
                ljmp    initial                 ;
                org     startup+03h             ;ex interrupt 0
                ljmp    p_fail                  ;
                org     startup+0bh             ;timer 0
                ljmp    timer0i                 ;
                org     startup+013h            ;ex interrupt 1
                ljmp    print_ser               ;
                org     startup+01bh            ;timer 1
                reti                            ;
;;;             ljmp    timer1i                 ;
                org     startup+023h            ;sio interrupt
                ljmp    int_sio                 ;
;;;             org     startup+02bh            ;timer 2
;;;             reti                            ;not use
;************************************************
; < initializer >                               *
;************************************************
                org     startup+030h            ;
                                                ;
                RSEG    RCODE                   ; Should be loaded after INTVEC
                                                ;
initial:                                        ;
;************************************************
;       wait power stable and init cpu          ;
;************************************************
                mov     a,#_r                   ;set register bank 0
                mov     c,acc.3                 ;
                mov     psw.3,c                 ;
                mov     c,acc.4                 ;
                mov     psw.4,c                 ;
                mov     sp,#stack_begin         ;stack initial 30H -
                ;                               ;
                mov     a,#00h                  ;
                mov     r0,a                    ;
                mov     r1,a                    ;
                mov     r2,a                    ;
                mov     r3,a                    ;
                mov     r4,a                    ;
                mov     r5,a                    ;
                mov     r6,a                    ;
                mov     r7,a                    ;
;               mov     p0,a                    ;port 0 clear (address low)
;               mov     p2,a                    ;port 2 clear (address high)
                ;                               ;
                mov     p1,#019h                ;port 1
                mov     p3,#0efh                ;port 3
                ;                               ;
                mov     tmod,#00h               ;timer/count mode control register
                mov     tcon,#00h               ;timer/count control register
                mov     ie,#00h                 ;interrupt enable register (exceipt int 0 pf)
                mov     ip,#00h                 ;interrupt priority register
                mov     scon,#00h               ;serial port control register
                mov     dptr,#ptr_font           ;printer dot1-8 clear
                mov     a,#0ffh
                movx    @dptr,a
                mov     a,#10000000b            ;dot9,dispaly etc. initial
                mov     dptr,#ptr_stat
                movx    @dptr,a
                mov     dptr,#ram_stat
                movx    @dptr,a
;-----------------------------------------------;
;               INITIAL DISP/PRINTER            ;
;-----------------------------------------------;
                mov     r2,#05h                 ;(6x6+2)=38us
port_init:      lcall   pport_init              ;
                lcall   dport_init              ;
                djnz    r2,port_init            ;
;-----------------------------------------------;
;-----------------------------------------------;
;             internal ram clear                ;for use 8032a CPU
;-----------------------------------------------;
                mov     r1,#0ffh                ;except reg bank 0
int_ramc:       mov     a,#0h                   ;
                mov     @r1,a                   ;
                dec     r1                      ;
                cjne    r1,#07h,int_ramc        ;internal ram clear 8h - ffh
;-----------------------------------------------;
;              initial cpu                      ;Fosc=22.1184
;-----------------------------------------------;test0
                mov     r1,#05h                 ;timer 0 ==> 16 bit counter
in_cpu:         mov     th0,#0fdh               ;count rate about 1uS
                mov     tl0,#0e1h               ;timer 0=1ms :(921uS + service routine)
                mov     th1,#0fch               ;baud rate
                mov     tl1,#0fah               ;buzzer sound test
                mov     tmod,#021h              ;timer 1 ==> 8 bit counter
                djnz    r1,in_cpu               ;
;-----------------------------------------------;
;             wait power stable                 ;
;-----------------------------------------------;
                 mov    r3,#04h                 ;dummy instruction
inlop0:          mov    r2,#0ffh                ;dummy instruction
inlop1:          mov    r1,#0ffh                ;9ffffhx5 = 1.5 sec
in_lop:          nop                            ;ffff
                 nop                            ;
                 nop                            ;
                 djnz   r1,in_lop               ;
                 djnz   r2,inlop1               ;
                 djnz   r3,inlop0               ;
                 ;------------------------------;
                 ;after power on                ;
                 ;power stable wait total time  ;
                 ;about 1 secs                  ;
;************************************************
;       ram enable & extenal stack set          ;
;************************************************
;               RAM select late ...             ;
;               BASIC 64 KBytes                 ;
;-----------------------------------------------;
                mov     dptr,#ram_stat          ;TEMPPPP
                mov     a,#80h                  ;
                movx    @dptr,a                 ;
                ;
;;;; change to latch(ptr_stat bit0) for 2M eprom 96.10.6
;                clr     p1.3                    ;ram enable
                mov     dptr,#ptr_stat
                mov     a,#00h
                movx    @dptr,a
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     r2,#20h                 ;dummy instruction
inp1:           mov     r1,#0ffh                ;about 90 ms
inp:            nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
                djnz    r1,inp                  ;
                djnz    r2,inp1                 ;
                ;-------------------------------;
                ;after  enable ram              ;
                ;ram  stable wait total time    ;
                ;-------------------------------;
                lcall   C_INIT                  ;
                nop                             ;
                nop                             ;
                nop                             ;
                setb    p1.2                    ;
                nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
                lcall   C_INIT                  ;
                nop                             ;
                nop                             ;
                nop                             ;
                clr     p1.2                    ;
                nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
;-----------------------------------------------;
;            external ram clear (work)          ;
;-----------------------------------------------;
;********** work ram clear routine *************;
                mov     dptr,#work_end          ;
                mov     dph_add,dph             ;
                mov     dpl_add,dpl             ;
                mov     dptr,#0h                ;
ext_ramc1:      mov     a,#0h                   ;
                movx    @dptr,a                 ;
                inc     dptr                    ;
                mov     a,dph                   ;
                cjne    a,dph_add,ext_ramc1     ;
                mov     a,dpl                   ;
                cjne    a,dpl_add,ext_ramc1     ;
;-----------------------------------------------;
;          set timer and enable intr            ;
;-----------------------------------------------;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;   0  1  0  1  0  0  0  0;;;;;;
                ;   mode1   enable              ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     scon,#050h              ;serial port control register
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MODE 1
                ;;   0  1  0  1  0  1  0  0;;;;;;/t1/t0 run/int1 edge
                ;       t1    t0   int1         ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;timer 1 run (BAUD RATE generator)
                mov     tcon,#054h              ;timer 0 run and(1 EXCEPT) edge flg int1
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;   TIMER 2 not use1  0  0;;;;;;timer2 baud rate generation mode
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     ip,#08h                 ;ex int1 (print) high priority
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;   1  X  0  0  0  1  1  1;;;;;;
                ;         t2 sio                ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;PKR0515                mov     ie,#087h                ;all int enable
                mov     ie,#097h                ;all int enable
                mov     pfail_flg,#01h          ;power on bit
                setb    pover_bit               ;
;-----------------------------------------------;
;           ram all clear routine               ;
;-----------------------------------------------;
                lcall   clr_lcd1
                clr     ie.1                    ;mask timer0
;;;; change to latch(ptr_stat bit0) for 2M eprom 96.10.6
                mov     dptr,#ptr_stat
                mov     a,#00h
                movx    @dptr,a                 ;ram enable
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     dptr,#kmod_addr         ;0FE00H
                clr     p1.0                    ;
                nop                             ;
                movx    a,@dptr                 ;output rt data
                setb    p1.0                    ;
                nop                             ;
;;;; change to latch(ptr_stat bit0) for 2M eprom 96.10.6
;                clr     p1.3                    ;ram enable
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                xrl     a,#0ffh                 ;read data conversion
                anl     a,#7fh
IF REAL_ROM
                cjne    a,#MMODE,pm_chk         ;
                sjmp    m_init                  ;
pm_chk:         cjne    a,#PMODE,nomclr1        ;
                lcall   p_temp_clr              ;PMODE -> SUBT
nomclr1:        ljmp    nomclr                  ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;all clear routine
m_init:         mov     r4,#0h                  ;-grand clear      (CASH = 30)
                mov     r3,#0h                  ;-report area clear(CHEK = 22)
                mov     r2,#0h                  ;-all clear        ('00' = 36)
                mov     r1,#0h                  ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;; all clear key check       ;;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
dz_scan:        lcall   fky_scan                ;low key check
                cjne    r1,#DZSCAN_LINE,ck_chk  ;
                mov     r2,a                    ;
                sjmp    inc_scnd                ;
;ck_csh:         cjne    r1,#CSSCAN_LINE,ck_chk  ;
;                mov     r4,a                    ;
;                sjmp    inc_scnd                ;
;                ;                               ;
ck_chk:         cjne    r1,#CKSCAN_LINE,dz_chk  ;
                mov     r3,a                    ;
                sjmp    inc_scnd                ;
                ;                               ;
dz_chk:         cjne    a,#00h,nomclr           ;column mult chk
inc_scnd:       inc     r1                      ;
                cjne    r1,#KEYSCAN_NO,dz_scan  ;
                ;                               ;
                mov     a,r2                    ;DOUBLE ZERO
                cjne    a,#DZRETN_DATA,chk_check;
                mov     a,r3                    ;
                cjne    a,#0h,nomclr            ;
;                mov     a,r4                    ;
;                cjne    a,#0h,nomclr            ;
                ;                               ;
ENDIF
                lcall   exramclr                ;
                ;-------------------------------;@@@@@@@@@@@@@@@@@@@@@@@@@@@@
                lcall   CHOX_INIT               ;
                nop                             ;
                setb    p1.2                    ;
                nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
                lcall   CHOX_INIT               ;
                nop                             ;
                clr     p1.2                    ;
                nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
                ;-------------------------------;
                jb      err_bit,ram_damage      ;
                setb    allramclr_bit           ;
                sjmp    nomclr                  ;
ram_damage:     ljmp    exit                    ;
                ;                               ;
chk_check:
;                mov     a,r2                    ;
;                cjne    a,#0h,nomclr            ;other key in 00 line
;                mov     a,r3                    ;
;                cjne    a,#CKRETN_DATA,chk_csh  ;'CHECK'
;;                mov     a,r4                    ;
;;                cjne    a,#0h,nomclr            ;
;                mov     dptr,#ram_end           ;consecutive no. & zcnt
;                mov     dpl0_add,dpl            ;
;                mov     dph0_add,dph            ;
;                mov     dptr,#report_start      ;
;                lcall   zero_in                 ;
;                setb    allramclr_bit           ;
;                setb    ttlcntclr_bit           ;
;                sjmp    nomclr                  ;
;                ;                               ;
chk_csh:
;                mov     a,r4                    ;
;                cjne    a,#CSRETN_DATA,nomclr   ;'CASH'
;                mov     r0,#08h                 ;
;                mov     dptr,#grand             ;
;                mov     a,#0h                   ;
;                lcall   fill_da                 ;
;                setb    allramclr_bit           ;
;                setb    grandclr_bit            ;
;                ;-------------------------------;
nomclr:         setb    ie.1                    ; timer0 display
;-----------------------------------------------;
;            initial work area                  ;
;-----------------------------------------------;power on all high
                mov     a,#0h                   ;
                setb    pover_bit
                lcall   prn_act                 ;
prt_inisb: ;;;;     jb      flg_noprn,jp_er9
                jnb     pover_bit,prt_inisb     ;during printer initial ?
;                sjmp    prt_ini1
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;jp_er9:
;                setb    flg_noprn               ;printer dis-connection set
;                lcall   error9                  ;yes, printer initial re start
;                ljmp    main_a
;                ;
prt_ini1:
IF 0
                mov     dptr,#flag_fis2
                movx    a,@dptr
                clr     acc.1
                movx    @dptr,a                 ;error9(printer
                mov     dptr,#dectax
                movx    a,@dptr                 ;decimal tax inf. load
                anl     a,#0fh                  ;decimal inf. clear
                mov     tax_tmp,a               ;tax inf. temp save
;;;;;;;;; insert for paper end check 93.1.18
                mov     dptr,#comm_stat         ;paper end senser address
                movx    a,@dptr
                jb      acc.2,wait_pp
                mov     dptr,#flag_fis2
                movx    a,@dptr
                setb    acc.0
                movx    @dptr,a                 ;paper end flag set
wait_pp:
                mov     dptr,#flag_fis2
                movx    a,@dptr
                jnb     acc.0,con_ini           ;paper end flag set ?
                lcall   keyscan
                sjmp    wait_pp
                ;
ENDIF
main_a:
                ;-------------------------------;
                MOV     A,#$BYTE3 main          ; PKR0624
                MOV     DPTR,#main              ; PKR0624
                LCALL   ?X_CALL_L18             ; PKR0624
exit:                                           ;
                setb    ie.1                    ;timer0 display
                mov     pfail_flg,#00h          ;power on flg
                lcall   inidtx                  ;
                mov     a,#01h                  ;
                mov     dptr,#flg_dis_txtmp+5   ;
                movx    @dptr,a                 ;
                mov     dptr,#ram_end           ;
                movx    a,@dptr                 ;
                mov     dptr,#flg_dis_txtmp+4   ;
                movx    @dptr,a                 ;
                lcall   outdtx                  ;
                sjmp    $                       ;
;;push_pstat:
;;                mov     dptr,#pstat_f
;;                movx    @dptr,a
;;                ret
;;pop_pstat:
;;                mov     dptr,#pstat_f
;;                movx    a,@dptr
;;                ret
;********************************************************************
;***                                                              ***
;***            POWER FAIL INTERRUPT SERVICE ROUTINE              ***
;***                                                              ***
;********************************************************************
p_fail:                                         ;
                clr     ie.7                    ;all interrupt mask
                push    acc                     ;
                push    b                       ;
                push    psw                     ;
                push    dph                     ;
                push    dpl                     ;
                push    _r+0                    ;
                push    _r+1                    ;
                push    _r+2                    ;
                push    _r+3                    ;
                push    _r+4                    ;
                push    _r+5                    ;
                ;CHECK P/F RS232-1/2            ;
                mov     dptr,#comm_stat         ;
                movx    a,@dptr                 ;
                jnb     acc.7,pf_ser            ;
                jnb     acc.0,rs1_ser           ;
                jnb     acc.1,rs2_ser           ;
int_452_ret:    ;                               ;
                MOV     A,#$BYTE3 sv_lcd1       ; PKR0624
                MOV     DPTR,#sv_lcd1           ; PKR0624
                LCALL   ?X_CALL_L18             ; PKR0624
                pop     _r+5                    ;
                pop     _r+4                    ;
                pop     _r+3                    ;
                pop     _r+2                    ;
                pop     _r+1                    ;
                pop     _r+0                    ;
                pop     dpl                     ;
                pop     dph                     ;
                pop     psw                     ;
                pop     b                       ;
                pop     acc                     ;
                setb    ie.7                    ;
                reti                            ;
rs1_ser:   ;;;  mov     dptr,#pf_select         ;
          ;;;   mov     a,#01h                  ;
          ;;;   movx    @dptr,a                 ;
          ;;;   sjmp    ser_452_1               ;rs232c - 1
                sjmp    int_452_ret             ;
                ;                               ;
rs2_ser:  ;;;   mov     dptr,#pf_select         ;
          ;;;   mov     a,#02h                  ;
          ;;;   movx    @dptr,a                 ;
                sjmp    int_452_ret             ;
;-----------------------------------------------;
;               disable ram                     ;
;-----------------------------------------------;
pf_ser:         mov     a,#08h                  ;
                lcall   rtc_conv1               ;
                mov     dptr,#rtc_mode          ;rtc enable
                movx    @dptr,a                 ;
;;;; change to latch(ptr_stat bit0) for 2M eprom 96.10.6
;                setb    p1.3                    ;ram disable
                mov     dptr,#ptr_stat
                mov     a,#01h
                movx    @dptr,a
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;power fail port initial        ;
                mov     r2,#16h                 ;
clrppp:         mov     r1,#0ffh                ;
clr_p:          lcall   pport_init              ;drawer reset
                lcall   dport_init              ;
                djnz    r1,clr_p                ;
                djnz    r2,clrppp               ;
                ;power fail delay time          ;
                ;Time adjust late ...           ;
                ;                               ;
                mov     r0,#09h                 ;9->f
dummy2:         mov     r1,#0ffh                ;dummy instruction
dummy1:         mov     r2,#0ffh                ;7x0fffffh= : 7.34s
dummy:          nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
                djnz    r2,dummy                ;
                djnz    r1,dummy1               ;
                djnz    r0,dummy2               ;
                ;-------------------------------;
                ;after power fail               ;
                ;power stable wait total time   ;
                ;about 7.5sec                   ;
;-----------------------------------------------;
; after power fail, reti return address         ;
; must be 0000h                                 ;
;-----------------------------------------------;
                mov     r2,#0ffh                ;
                mov     r1,#0ffh                ;
stkzero:        clr     a                       ;
                mov     @r1,a                   ;
                dec     r1                      ;
                dec     r2                      ;
                cjne    r2,#02fh,stkzero        ;
                ;                               ;
                reti                            ;
IF 0
;********************************************************************
;***            452 interrupt service routine                     ***
;********************************************************************
ser_452_1:      mov     dptr,#reg1_intidn       ;rs232c - 1
                movx    a,@dptr                 ;
                jb      acc.0,no_int            ;
                anl     a,#06h                  ;rec/trs
                cjne    a,#06h,chk_rts          ;
                mov     dptr,#reg1_lnestat      ;
                movx    a,@dptr                 ;
                anl     a,#0eh                  ;overrun/parity/framing err check
                cjne    a,#0h,set_err           ;
                ljmp    int_452_ret             ;
set_err:        mov     comm_err,a              ;
no_int:         ljmp    int_452_ret             ;
chk_rts:        jb      acc.1,ser_trans         ;trans interrupt
                jb      acc.2,ser_recev         ;recev interrupt
                ljmp    int_452_ret             ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;;;;;;;   452 TRANSMT   ;;;;;;;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ser_trans:      mov     a,s_out_flg             ;trans active flg
                cjne    a,#01h,trs_ret          ;
                ;                               ;
                mov     dptr,#comm_buff         ;
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                jnc     t_ccc                   ;
                inc     dph                     ;
t_ccc:          mov     dpl,a                   ;
                movx    a,@dptr                 ;trans data fetch
                ;                               ;
                mov     dptr,#reg1_trans        ;
                movx    @dptr,a                 ;
                ;                               ;
                inc     io_cnt                  ;
                mov     a,io_cnt                ;
                cjne    a,trx_buf_cnt,trs_ret   ;
                mov     tend_flg,#01h           ;
trs_ret:        ljmp    int_452_ret             ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;;;;;;;   452 RECEIVE   ;;;;;;;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ser_recev:      mov     a,comm_kind             ;comm_kind = 0 : PC
                cjne    a,#0h,sp_chk            ;            1 : SLIP
                sjmp    recev_pc                ;
sp_chk:         cjne    a,#02h,rev_ret          ;            2 : SCALE
                ;-------------------------------;
                ;;;      SCALE RECEIVE        ;;;
                ;-------------------------------;
                mov     a,s_in_flg              ;interrupt active flg
                cjne    a,#01h,rev_ret          ;
                ;                               ;
                mov     dptr,#reg1_recve        ;
                movx    a,@dptr                 ;
                ;                               ;
                mov     r0,a                    ;
                mov     dptr,#comm_buff         ;receive DATA save
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                mov     dpl,a                   ;
                jnc     r_scc                   ;
                inc     dph                     ;
r_scc:          mov     a,r0                    ;
                anl     a,#07fh                 ;remove perity
                movx    @dptr,a                 ;
                inc     io_cnt                  ;
                cjne    a,#ETX,chk_siocnt       ;
sc_end:         mov     rend_flg,#02h           ;
rev_ret:        ljmp    int_452_ret             ;
                ;                               ;
chk_siocnt:     mov     a,io_cnt                ;
                clr     c                       ;
                cjne    a,#010h,ck_sgt          ;
ck_sgt:         jc      rev_ret                 ;
                sjmp    sc_end                  ;
                ;-------------------------------;
                ;;;        PC RECEIVE         ;;;
                ;-------------------------------;
recev_pc:       mov     a,s_in_flg              ;interrupt active flg
                cjne    a,#01h,rev_ret          ;
                ;                               ;
                mov     dptr,#reg1_recve        ;
                movx    a,@dptr                 ;
                ;                               ;
                mov     r0,a                    ;
                lcall   recv_chk                ;
                mov     a,dsave_flg             ;save data indicator flg
                cjne    a,#01h,rev_ret          ;
                ;                               ;
                mov     dptr,#comm_buff         ;receive DATA save
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                mov     dpl,a                   ;
                jnc     r_pcc                   ;
                inc     dph                     ;
r_pcc:          mov     a,r0                    ;
                movx    @dptr,a                 ;
                inc     io_cnt                  ;
                ljmp    int_452_ret             ;
;-----------------------------------------------;
;            SLIP MAIN TRANSMITTER              ;
;-----------------------------------------------;
sp_trans452:    mov     comm_kind,#01h          ;
                mov     a,s_out_flg             ;trans int active flg
                cjne    a,#0h,sp_trans452       ;
                mov     s_out_flg,#01h          ;trans int active flg
                mov     tend_flg,#0h            ;
                lcall   init_452                ;initial 452
                mov     io_cnt,#01h             ;
                mov     dptr,#comm_buff         ;
                movx    a,@dptr                 ;
                ;                               ;
                mov     dptr,#reg1_trans        ;First data transmit
                movx    @dptr,a                 ;
                ;                               ;
w_tsp:          mov     a,tend_flg              ;
                cjne    a,#01h,w_tsp            ;
                mov     s_out_flg,#00h          ;trans int active flg
                ;                               ;
                lcall   int_disable             ;
                lcall   clr_prt_buff            ;
                mov     comm_kind,#0h           ;
                ret                             ;
;-----------------------------------------------;
;           SCALE MAIN TRANSMITTER              ;
;-----------------------------------------------;
sc_trans452:    mov     comm_kind,#02h          ;
                mov     a,s_out_flg             ;trans int active flg
                cjne    a,#0h,sc_trans452       ;
                mov     s_out_flg,#01h          ;trans int active flg
                mov     tend_flg,#0h            ;
                lcall   init_452                ;initial 452
                mov     io_cnt,#01h             ;
                mov     dptr,#comm_buff         ;
                movx    a,@dptr                 ;
                ;                               ;
                mov     dptr,#reg1_trans        ;First data transmit
                movx    @dptr,a                 ;
                ;
wait_tsc:       mov     a,tend_flg              ;
                cjne    a,#01h,wait_tsc         ;
                mov     s_out_flg,#00h          ;trans int active flg
                ;                               ;
                mov     rend_flg,#0h            ;receive ending flg
                mov     comm_kind,#02h          ;comm_kind = 2 : SCALE
                mov     s_in_flg,#01h           ;recev int active flg
                mov     io_cnt,#0h              ;
                mov     comm_err,#0h            ;
                ;                               ;
wait_rsc:       mov     a,comm_err              ;
                cjne    a,#0h,sc_ret            ;
                cjne    a,#02h,wait_rsc         ;
                mov     s_in_flg,#0h            ;
sc_ret:         lcall   int_disable             ;
                mov     comm_kind,#0h           ;
                ret                             ;
;-----------------------------------------------;
;              PC MAIN TRANSMITTER              ;
;-----------------------------------------------;
pc_trans452:    mov     s_out_flg,#01h          ;trans int active flg
                mov     tend_flg,#0h            ;
                lcall   init_452                ;initial 452
                mov     io_cnt,#01h             ;
                mov     dptr,#comm_buff         ;
                movx    a,@dptr                 ;
                ;                               ;
                mov     dptr,#reg1_trans        ;First data transmit
                movx    @dptr,a                 ;
                ;                               ;
wait_trans:     mov     a,tend_flg              ;
                cjne    a,#01h,wait_trans       ;
                mov     s_out_flg,#00h          ;trans int active flg
                ; ack / nack recv               ;
                lcall   rflg_init               ;receive flag initial
wait_ack:       mov     a,ack_flg               ;
                cjne    a,#01h,wait_nack        ;
                mov     comm_status,#0h         ;
                ret                             ;
wait_nack:      mov     a,nack_flg              ;
                cjne    a,#01h,wait_ack         ;
                mov     comm_status,#01h        ;
                lcall   int_disable             ;
                ret                             ;
;-----------------------------------------------;
;               PC MAIN RECEIVER                ;
;-----------------------------------------------;
pc_recev452:    mov     rend_flg,#0h            ;receive ending flg
                lcall   rflg_init               ;receive flag initial
                mov     s_in_flg,#01h           ;recev int active flg
                mov     io_cnt,#0h              ;
                lcall   init_452                ;initial 452
wait_recev:     mov     a,comm_err              ;
                cjne    a,#0h,pc_ret            ;
                mov     a,rend_flg              ;
                cjne    a,#02h,wait_recev       ;
                mov     s_in_flg,#0h            ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                call   rvd_vcheck               ;receive data valid check
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                nop                             ;
                mov     a,r4                    ;
                cjne    a,#01h,recev_good       ;
                mov     comm_status,#01h        ;receive comm fail !
                lcall   send_nack               ;
                sjmp    save_iocnt              ;
                ;                               ;
recev_good:     lcall   send_ack                ;
                mov     comm_status,#0h         ;receive comm success !
save_iocnt:     mov     a,io_cnt                ;
                mov     trx_buf_cnt,a           ;
pc_ret:         lcall   rflg_init               ;receive flag initial
                lcall   int_disable             ;
                ret                             ;
;-----------------------------------------------;
;               452 SUBROUTINE                  ;
;-----------------------------------------------;
init_452:       mov     a,comm_kind             ;Line control reg setting
                ;comm_kind = 0 : PC             ;8bit/1stop/no parity
                ;comm_kind = 1 : SLIP           ;8bit/1stop/no parity
                ;comm_kind = 2 : SCALE          ;7bit/1stop/even parity
                cjne    a,#02h,set_pc_slip      ;
                mov     b,#0h                   ;SCALE setting
                mov     a,#len_7bit             ;data length 7 bits/1 stop bit
                orl     b,a                     ;
                mov     a,#even_parity          ;even parity
                orl     b,a                     ;
                sjmp    set_line_reg            ;
                ;                               ;
set_pc_slip:    mov     b,#0h                   ;PC/SLIP setting
                mov     a,#len_8bit             ;data length 8 bits/1 stop bit
                orl     b,a                     ;no parity
                ;                               ;
set_line_reg:   mov     a,b                     ;DLAB reset
                mov     dptr,#reg1_lnecntl      ;
                movx    @dptr,a                 ;
                ;                               ;
                mov     dptr,#reg1_lnecntl      ;
                movx    a,@dptr                 ;SET baud rate
                orl     a,#set_dalb             ;DLAB set
                movx    @dptr,a                 ;
                mov     dptr,#reg1_higdiv       ;
                mov     a,#0h                   ;
                movx    @dptr,a                 ;
                mov     dptr,#reg1_lowdiv       ;
                mov     a,#BD9600               ;
                movx    @dptr,a                 ;
                mov     dptr,#reg1_lnecntl      ;
                movx    a,@dptr                 ;SET baud rate
                anl     a,#clr_dalb             ;DLAB reset
                movx    @dptr,a                 ;
                ;                               ;
                lcall   int_enable              ;Interrupt enable all
                ret                             ;
;-----------------------------------------------;
int_enable:     mov     a,#int_all              ;Interrupt enable all
                mov     dptr,#reg1_intenv       ;
                movx    @dptr,a                 ;
                ret
;-----------------------------------------------;
int_disable:    mov     a,#int_mask             ;Interrupt disable all
                mov     dptr,#reg1_intenv       ;
                movx    @dptr,a                 ;
                ret                             ;
ENDIF
;********************************************************************
;***                                                              ***
;***          TIMER0 INTERRUPT SERVICE ROUTINE (DISPLAY)          ***
;***                                                              ***
;********************************************************************
timer0i:        push    ie                      ;ex int1 & t1
                mov     ip,#0ch                 ;ex int1 & t1
;PKR0515                mov     ie,#084h                ;except timer2
                mov     ie,#094h                ;except timer2
                call    label1                  ;
                push    acc                     ;
                push    b                       ;
                push    psw                     ;
                push    dph                     ;
                push    dpl                     ;
                push    _r+0                    ;
                push    _r+1                    ;
                push    _r+2                    ;
                push    _r+3                    ;
                push    _r+4                    ;
                push    _r+5                    ;
                ;                               ;
;;;             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;TIMER 0 STOP
                clr     tcon.4                  ;timer0 run control bit
;;;             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     a,pfail_flg             ;
                cjne    a,#00h,lpend            ;power on bit
                ljmp    nor_dsp                 ;
                ;-------------------------------;
lpend:          mov     a,jam_flg               ;93.05.01
                cjne    a,#00h,nor_dsp          ;
                ljmp    off_dspp                ;yes key scan
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
nor_dsp:        mov     r1,dig_cnt              ;make next digit no
                mov     a,r1                    ;
                mov     dptr,#flg_dis_txt       ;
                clr     c                       ;
                add     a,dpl                   ;
                jnc     go_dpl                  ;
                inc     dph                     ;
go_dpl:         mov     dpl,a                   ;
                movx    a,@dptr                 ;
                mov     r0,a                    ;
                anl     a,#070h                 ;0fge0000-070h
                clr     c                       ;
                rlc     a                       ;
                mov     r2,a                    ;
                ;                               ;
                mov     a,r1                    ;
                mov     dptr,#decp_buf          ;decimal & cap buffer chk
                clr     c                       ;
                add     a,dpl                   ;
                jnc     go1_dpl                 ;
                inc     dph                     ;
go1_dpl:        mov     dpl,a                   ;
                movx    a,@dptr                 ;
                jnb     acc.0,chk_digtm         ;
                mov     a,#010h                 ;decimal point
                orl     a,r2                    ;
                mov     r2,a                    ;
chk_digtm:      mov     a,r1                    ;
                cjne    a,#09h,chk_d56          ;
                sjmp    make_r3                 ;
chk_d56:        clr     c                       ;
                cjne    a,#05h,com_d56          ;
com_d56:        jc      make_r3                 ;
                mov     dptr,#digt_pos          ;digit 6 7 8 9
                movc    a,@a+dptr               ;get current digit line
                orl     a,r2                    ;
                mov     r2,a                    ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;make R3
make_r3:        mov     a,r0                    ;
                anl     a,#0eh                  ;
                clr     c                       ;
                rrc     a                       ;
                mov     r3,a                    ;
                mov     a,r1                    ;
                clr     c                       ;
                cjne    a,#05h,chk_d5           ;
chk_d5:         jnc     make_r4                 ;
                mov     dptr,#digt_pos          ;
                movc    a,@a+dptr               ;get current digit line
                orl     a,r3                    ;
                mov     r3,a                    ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;make R4
make_r4:        mov     r4,#0h                  ;
                mov     a,r0                    ;
                jnb     acc.0,mk_cap            ;
                mov     r4,#04h                 ;
mk_cap:         mov     a,r1                    ;
                mov     dptr,#decp_buf          ;decimal & cap buffer chk
                clr     c                       ;
                add     a,dpl                   ;
                jnc     go2_dpl
                inc     dph
go2_dpl:        mov     dpl,a                   ;
                movx    a,@dptr                 ;
                jnb     acc.1,chk_digt          ;
                mov     a,#02h                  ;cap point make
                orl     a,r4                    ;
                mov     r4,a                    ;
chk_digt:       mov     a,r1                    ;
                cjne    a,#09h,out_75518        ;
                mov     a,#01h                  ;digit 10 make
                orl     a,r4                    ;
                mov     r4,a                    ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
out_75518:      mov     r5,#013h                ;19ea
dsp_loop:       mov     a,r5                    ;
                clr     p1.5                    ;clock clr
                clr     c                       ;
                cjne    a,#011h,chk_11          ;
chk_11:         jc      chek_09                 ;
                mov     a,r4                    ;
                rrc     a                       ;
                mov     r4,a                    ;
                sjmp    out_dsp                 ;
                ;                               ;
chek_09:        clr     c                       ;
                cjne    a,#09h,chk_09           ;
chk_09:         jc      ser_r2                  ;
                clr     c                       ;
                mov     a,r3                    ;
                rrc     a                       ;
                mov     r3,a                    ;
                sjmp    out_dsp                 ;
                ;                               ;
ser_r2:         clr     c                       ;
                mov     a,r2                    ;
                rrc     a                       ;
                mov     r2,a                    ;
                ;                               ;
out_dsp:        jc      set_data                ;set data port
                clr     p1.7                    ;
                sjmp    set_clk                 ;
set_data:       setb    p1.7                    ;
set_clk:        nop                             ;
                setb    p1.5                    ;
                djnz    r5,dsp_loop             ;
                ;                               ;
                setb    p1.6                    ;75518 latch enable
                nop                             ;
                nop                             ;
                clr     p1.6                    ;
                ;                               ;
countup:        mov     a,r1                    ;
                inc     a                       ;
                cjne    a,#0ah,disend           ;
                mov     a,#0h                   ;
disend:         mov     dig_cnt,a               ;
                nop                             ;
off_dspp:       ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     a,jam_flg               ;
                cjne    a,#01h,jam_chk          ;
                clr     pover_bit               ;
                lcall   pport_init              ;
;;;;;; error message display in lcd
                mov     dptr,#errmsg            ;
                mov     a,#E_GENERAL
                movx    @dptr,a
                setb    err_bit
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                sjmp    off_dsp                 ;
                ;                               ;
jam_chk:        jb      pover_bit,scan_key      ;
                inc     jam_cnt                 ;inc jam counter
                mov     a,jam_cnt               ;
                clr     c                       ;
                cjne    a,#0D0h,ck_cc           ;60mS-> 208mS 93.05.01
ck_cc:          jc      scan_key                ;
                mov     jam_cnt,#0h             ;
                mov     jam_flg,#01h            ;
                lcall   inidtx                  ;
                mov     a,#018d                 ;'P'
                mov     dptr,#flg_dis_txtmp+5   ;
                movx    @dptr,a                 ;
                mov     dptr,#flg_dis_txtmp+4   ;
                movx    @dptr,a                 ;'P'
                lcall   outdtx                  ;
                mov     prt_chatt,#0h           ;
                clr     rhome_bit               ;
                clr     jhome_bit               ;
;;;;;; error message display in lcd
                mov     dptr,#errmsg            ;
                mov     a,#E_GENERAL
                movx    @dptr,a
                mov     dptr,#pop_err           ;
                mov     a,#00h
                movx    @dptr,a
                setb    err_bit
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                sjmp    off_dsp                 ;
scan_key:       ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   keyscan                 ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;-----------------------------------------------;
off_dsp:
                inc     timd_cnt                ;drawer open time count
                mov     a,siotm_cnt0            ;
                cjne    a,#0ffh,inc_tmout       ;
                inc     siotm_cnt1              ;sio time run out
inc_tmout:      inc     siotm_cnt0              ;sio time run out
                ;                               ;
                inc     buzz_cnt                ;
                ;===============================;
                ;       buzzer service(OFF)     ;
                ;===============================;
                jb      err_bit,dwr_chk         ;
                mov     a,buzz_cnt              ;
                clr     c                       ;
                cjne    a,#BUZZ_MAX,b_m         ;
b_m:            jc      dwr_chk                 ;
                setb    p1.4                    ;buzzer off
;;;                clr     p1.4                    ;buzzer off
                ;===============================;
                ;   drawer & sensor check       ;
                ;===============================;
dwr_chk:        mov     a,timd_cnt              ;
                jnb     drwr_bit,mot_chk        ;
                jnb     pover_bit,end_dsp       ;motor on
                cjne    a,#DRWTIM,end_dsp       ;80mS (drawer time)
                clr     drwr_bit                ;
                mov     dptr,#ptr_stat          ;
                mov     a,#OFFDWR               ;dawer sol off
                movx    @dptr,a                 ;
                ;===============================;
                ;   noise & static ele check    ;
                ;===============================;
mot_chk:        jnb     pover_bit,end_dsp       ;motor on
                lcall   pport_init              ;drawer port reset
                mov     dptr,#comm_stat         ;disp disconnection check
                movx    a,@dptr                 ;
                jnb     acc.3,clr_disc          ;
;;;;;;;; insert for display diconnection 2 times check 96.8.6
                mov     a,disc_flg
                jb      acc.0,disp_discon
                mov     disc_flg,#01h           ;
                sjmp    chk_pend
                ;
clr_disc:
                mov     disc_flg,#00h
                sjmp    chk_pend
                ;
disp_discon:
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   inidtx                  ;
                mov     a,#018d                 ;'P'
                mov     dptr,#flg_dis_txtmp+5   ;
                movx    @dptr,a                 ;
                mov     a,#013d                 ;'d'
                mov     dptr,#flg_dis_txtmp+4   ;
                movx    @dptr,a                 ;
                lcall   outdtx                  ;
;;;;;; error message display in lcd
                mov     dptr,#errmsg            ;
                mov     a,#E_GENERAL
                movx    @dptr,a
                mov     dptr,#pop_err           ;
                mov     a,#00h
                movx    @dptr,a
                setb    err_bit
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;             ;                               ;
chk_pend:       mov     a,pend_flg              ;
                cjne    a,#01h,end_dsp          ;
                lcall   inidtx                  ;
                mov     a,#018d                 ;'P'
                mov     dptr,#flg_dis_txtmp+5   ;
                movx    @dptr,a                 ;
                mov     a,#014d                 ;'E'
                mov     dptr,#flg_dis_txtmp+4   ;
                movx    @dptr,a                 ;
                lcall   outdtx                  ;
;;;;;; error message display in lcd
                mov     dptr,#errmsg            ;
                mov     a,#E_GENERAL
                movx    @dptr,a
                mov     dptr,#pop_err           ;
                mov     a,#00h
                movx    @dptr,a
                setb    err_bit
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;                               ;
end_dsp:        mov     th0,#0fdh               ;
                mov     tl0,#0e1h               ;timer 0=1ms :(961uS + service routine)
;;;             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;TIMER 0 RUN
                setb    tcon.4                  ;timer0 run control bit
;;;             ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;                               ;
                pop     _r+5                    ;
                pop     _r+4                    ;
                pop     _r+3                    ;
                pop     _r+2                    ;
                pop     _r+1                    ;
                pop     _r+0                    ;
                pop     dpl                     ;
                pop     dph                     ;
                pop     psw                     ;
                pop     b                       ;
                pop     acc                     ;
                pop     ie                      ;
                ret                             ;
label1:         reti                            ;
                ;-------------------------------;
digt_pos:       db         08h                  ;digit 0 address
                db         10h                  ;digit 1 address
                db         20h                  ;digit 2 address
                db         40h                  ;digit 3 address
                db         80h                  ;digit 4 address
                db         01h                  ;digit 5 address
                db         02h                  ;digit 6 address
                db         04h                  ;digit 7 address
                db         08h                  ;digit 8 address
                db         20h                  ;digit 9 address
                nop                             ;
                nop                             ;
;
;********************************************************************
;***                                                              ***
;***           INT1 INTERRUPT SERVICE ROUTINE (PRINTER )          ***
;***                                                              ***
;********************************************************************
print_ser:
;;;;;;; insert for forbid manual motor on error 95.5.13
                jnb     pover_bit,pint_ser
                reti
pint_ser:
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                push    ie                      ;
                mov     ip,#08h                 ;
;PKR0515                mov     ie,#088h                ;
                mov     ie,#098h                ;
                call    label                   ;
                push    acc                     ;
                push    psw                     ;
                push    dph                     ;
                push    dpl                     ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;  Test 12/10
                ;;setb    p1.4
                ;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;                               ;
                ; jam count reset               ;over 100 mS
;                jb      nfeed_bit,ser_nnf       ;normal 1 line feed check
;                jb      sfeed_bit,ser_ssf       ;stamp long feed check
                mov     a,prt_chatt             ;
                cjne    a,#0h,chk_fastf         ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ; home position port check      ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ; Acc.3     - reset right       ; initial = 1  reset detect = 0
                ; Acc.4     - reset left        ; initial = 1  reset detect = 0
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     dptr,#ptr_read         ;home position read
                movx    a,@dptr                 ;
                jb      acc.1,r_ckk
                jb      acc.0,r_ckk
                clr     rhome_bit               ;yes
                clr     jhome_bit               ;
                mov     prt_rstm,#0h            ;93.05.01
                sjmp    prn_sret                ;
                ;                               ;
r_ckk:
                jb      acc.1,prt_mainr
                jb      rhome_bit,r_set         ;93.05.01
                inc     prt_rstm                ;
                mov     a,prt_rstm              ;
                cjne    a,#011h,prn_sret        ;600 * 17 = 10.2mS
r_set:
                setb    rhome_bit               ;
                clr     jhome_bit               ;
                sjmp    tmp_set                 ;
                ;                               ;
next_j:         mov     dptr,#ptr_read         ;home position read
                movx    a,@dptr                 ;
                jb      acc.0,prt_mainj
                jb      jhome_bit,j_set         ;93.05.01
                inc     prt_rstm                ;
                mov     a,prt_rstm              ;
                cjne    a,#011h,prn_sret        ;600 * 17 = 10.2mS
j_set:          setb    jhome_bit               ;
                clr     rhome_bit               ;
;;;;;;;; change to 26 characters 95.5.15
;                mov     jtmp_cnt,#TIMLOW-61     ;2.10(70->71);1 line end count = 358
;;;;;;;;;; change to 358T 96.5.27
;               mov     jtmp_cnt,#TIMLOW-50     ;2.10(70->71);1 line end count = 358
                mov     jtmp_cnt,#TIMLOW-49     ;2.10(70->71);1 line end count = 358
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     jtmp1_cnt,#TIMHIGH      ;358=166h
tmp_set:        mov     tmp_cnt,#0h             ;time pulse reset
                mov     tmp1_cnt,#0h            ;//
                ;                               ;
prn_sret:       mov     jam_cnt,#0h             ;
                pop     dpl                     ;
                pop     dph                     ;
                pop     psw                     ;
                pop     acc                     ;
                pop     ie                      ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;  Test 12/10
                ;;clr     p1.4
                ;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ret                             ;
label:          reti                            ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;ser_feed:       ljmp    ser_fast                ;
;ser_nnf:        ljmp    ser_nfeed               ;
;ser_ssf:        ljmp    ser_sfeed               ;
;***********************************************;
;**        PRINTER INT MAIN SERVICE           **;
;***********************************************;94.01.12
prt_mainr:
                jnb     rhome_bit,next_j        ;printing (left -> right)
;                mov     prgt_flag,#0h           ;
                sjmp    chk_fastf               ;
prt_mainj:
                jnb     jhome_bit,tmp_set       ;printing (right -> left)
;                mov     prgt_flag,#01h          ;
                ;*******************************;DOT OUT
chk_fastf:
;                jb      ffeed_bit,ser_feed      ;fast feed service
                mov     prt_chatt,#01h          ;
;;;;;; insert for 24 colume printing 95.1.27
                inc     tmp_cnt
                mov     a,tmp_cnt
                jnz     notinc_cnt
                mov     tmp1_cnt,#01h
notinc_cnt:
                mov     a,tmp1_cnt
                jnz     con_prnt
                mov     a,tmp_cnt
                clr     c
;;;;;;; change to 26 characters 95.5.15
;                subb    a,#58d                  ;left to right
;;;;;;;;;;; change to 358T 96.5.27
;                subb    a,#48d                  ;left to right
                subb    a,#49d                  ;left to right
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                jc      prn_sret
con_prnt:
;;;;;;;;;;;;; insert for test 95.2.2
                jnb     nfeed_bit,con_pr1       ;waiting feeding
                ljmp    chk_lft
con_pr1:
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     a,font_data             ;
                mov     dptr,#ptr_font           ;
;                mov     dpl,a                   ;
                movx    @dptr,a                 ;dot 1 - 8 out
                nop

                mov     a,fonte_data            ;
                cjne    a,#00h,not_out          ;
nnot_out:
                mov     a,#MOTOR_9              ;080h - motor & dot 9
                sjmp    out_9                   ;
not_out:
                mov     a,#MOTOR                ;
out_9:
                mov     dptr,#ptr_stat
;                mov     dpl,a                   ;
                movx    @dptr,a                 ;
                nop                             ;
                mov     dptr,#ram_stat
                mov     a,#00h
                movx    @dptr,a
                ;*******************************;DOT OUT
                jnb     rhome_bit,chk_jhome     ;make next dont data(left -> righr)
                clr     c                       ;
                mov     dpl,tmp_cnt             ;make font data address
                mov     a,tmp1_cnt              ;
                ;                               ;make next font data
                add     a,#002h                 ;font_buffer address
                mov     dph,a                   ;
                movx    a,@dptr                 ;font data read
                mov     font_data,a             ;next font data save
                mov     a,#0ffh                 ;
                movx    @dptr,a                 ;write and cler
                ;                               ;
fonte_mk:       clr     c                       ;Make next fonte data
                mov     a,dph                   ;
                add     a,#02h                  ;
                mov     dph,a                   ;
                jnb     rhome_bit,rtol
;;;;;;;;;;; change to fonte_buffer address 95.1.27  cho
                mov     dpl,tmp_cnt
                sjmp    mvedat
rtol:
                mov     dpl,jtmp_cnt
mvedat:
                movx    a,@dptr                 ;fonte data read
                mov     fonte_data,a            ;next font data save
                mov     a,#0ffh                 ;
                movx    @dptr,a                 ;write and cler
                nop                             ;
                mov     dptr,#ram_stat
                mov     a,#80h
                movx    @dptr,a
                sjmp    chk_end_dot             ;
                ;                               ;
chk_jhome:      clr     c                       ;make next font data(right -> left)
                mov     a,jtmp_cnt              ;
                cjne    a,#0h,deccc             ;
                mov     jtmp1_cnt,#0h           ;
deccc:          dec     jtmp_cnt                ;
                clr     c                       ;make font data address
                mov     dpl,jtmp_cnt            ;
                mov     a,jtmp1_cnt             ;
                add     a,#002h                 ;
                mov     dph,a                   ;
                movx    a,@dptr                 ;font data read
                mov     font_data,a             ;next font data save
                mov     a,#0ffh                 ;
                movx    @dptr,a                 ;write and cler
                sjmp    fonte_mk                ;
                ;===============================;CHECK TIMING PLUSE
chk_end_dot:
;;;;;;;;;;;; insert for printer test 95.1.27
                jb      nfeed_bit,chk_lft
                mov     a,tmp1_cnt
                cjne    a,#01h,conti3_ser
                mov     a,tmp_cnt
                clr     c
;;;;;;;;;; change to 26 characters 95.5.15
;                subb    a,#2ch                  ;287t
;;;;;;;; change to 358T 96.5.27
;                subb    a,#35h                  ;287t
                subb    a,#36h                  ;309t
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                jc      j_con3_ser
                jnz     chk_ppp
                mov     a,#0ffh
                mov     dptr,#ptr_font           ;
;                mov     dpl,a                   ;
                movx    @dptr,a                 ;dot 1 - 8 clear
j_con3_ser:
                ljmp    conti3_ser
chk_ppp:
                mov     a,tmp_cnt
                clr     c
;;;;;;;;;; change to 26 characters 95.5.15
;                subb    a,#30h         ;2.9/66h ;home count
;;;;;;;; change to 358T 96.5.27
;                subb    a,#3ah         ;2.9/66h ;home count
                subb    a,#3bh         ;2.9/66h ;home count
;                subb    a,#3dh         ;2.9/66h ;home count
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                jc      j_con3_ser
                jnz     chk_lft
pschk1:         mov     a,#0d8h
                mov     dptr,#ptr_stat
                movx    @dptr,a
                setb    nfeed_bit
                sjmp    conti3_ser
chk_lft:
                mov     a,tmp_cnt
;;;;;;;;;; change to 26 characters 95.5.15
;                cjne    a,#4eh,aaa1      ;2.9/84h
;;;;;;;; change to 358T 96.5.27
;                cjne    a,#58h,aaa1      ;2.9/84h
                cjne    a,#59h,aaa1      ;2.9/84h
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
pschk2:         mov     a,#0c8h
                mov     dptr,#ptr_stat    ;!
                movx    @dptr,a          ;!
                sjmp    conti3_ser              ;???1line print
aaa1:
                mov     a,tmp_cnt
;;;;;;;;;; change to 26 characters 95.5.15
;                cjne    a,#071h,conti3_ser ;2.9/0a8h
;;;;;;;; change to 358T 96.5.27
;                cjne    a,#07bh,conti3_ser ;2.9/0a8h
                cjne    a,#07ch,conti3_ser ;2.9/0a8h
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
pschk3:         mov     a,#080h
                mov     dptr,#ptr_stat    ;!
                movx    @dptr,a          ;!
                clr     rhome_bit
                clr     jhome_bit
                clr     nfeed_bit
                setb    pover_bit       ;2.6
                ljmp    tmp_set
                ;
conti3_ser:     ljmp    prn_sret                ;
;                ;===============================;
;*******************************************************************;
;***                                                             ***;
;***                KEY SCAN  SERVICE  ROUTINE                   ***;
;***                                                             ***;
;*******************************************************************;
;****************************************************;
;***                 FEED KEY CHECK               ***;
;****************************************************;
feedkscan:      mov     a,#0h                   ;
                mov     prntask,#0h             ;
                jnb     pover_bit,fk_skip       ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;high scan check
                mov     r1,#04h                  ;76x4x210
                lcall   fky_scan                ;
                anl     a,#RJFRTN_DATA
                jz      fk_skip
                ;
                mov     r0,#03h                 ;chattering time
ok_sc:
                mov     r2,#0h                  ;32,52
                mov     r1,#0h                  ;76x4x210
fd_scan:        lcall   fky_scan                ;
                cjne    r1,#RFSCAN_LINE,zr_chk  ;zero ckeck
                mov     r2,a                    ;
                sjmp    inc_scn                 ;
zr_chk:         cjne    a,#00h,fk_skip          ;column mult chk
inc_scn:        inc     r1                      ;
                cjne    r1,#KEYSCAN_NO,fd_scan  ;
                ;                               ;
                mov     a,r2                    ;
                jz      fk_skip                ;64  76543210
                anl     a,#03fh
                jz      fk_skip
                mov     a,r2                    ;
                anl     a,#RJFRTN_DATA          ;0c0h
                jnb     acc.5,fk_skip             ;
                mov     prntask,#022h           ;jfeed task
                djnz    r0,ok_sc                ;
                ret                             ;
                ;                               ;
fk_skip:        mov     prntask,#0h             ;
                ret                             ;
;***********************************************;
                ;
on_lcd:
                mov     dptr,#lcd_wi1
                mov     a,#3Fh
                lcall   chk_busy1
                movx    @dptr,a
                mov     a,#0C0h
                lcall   chk_busy1
                movx    @dptr,a
                mov     dptr,#lcd_wi2
                mov     a,#3Fh
                lcall   chk_busy2
                movx    @dptr,a
                mov     a,#0C0h
                lcall   chk_busy2
                movx    @dptr,a
                ret
;***********************************************;
;*                                             *;
;*           60 KEYS SCAN ROUTINE              *;
;*                                             *;
;***********************************************;
; keyscan time : ?????????????????????????      ;
;***********************************************;
;***         MAIN KEYSCAN ROUTINE            ***;
;***********************************************;
scan_ret:     ret                               ;
keyscan:
              mov     a,lcd_reflg
              cjne    a,#0ffh,skip_lcdr
              lcall   on_lcd
skip_lcdr:
              inc     lcd_reflg
skip_lcdr2:
              mov       dptr,#mode_id           ;
              movx      a,@dptr                 ;
              cjne      a,#OMODE,pf_chk         ;93.05.01
kk_ret:       ret                               ;
pf_chk:       mov       a,pfail_flg             ;
              cjne      a,#00h,kk_ret           ;power on bit
              ;                                 ;
scan_ok:      mov       dptr,#flg_key_pend      ;
              movx      a,@dptr                 ;
              cjne      a,#KEYBUFF_NO,scan      ;
              mov       a,pend_flg              ;
              cjne      a,#01h,scan_ret         ;
              ;                                 ;
scan:         mov       a,scnl_cnt              ;scan line counter inc
              lcall     ky_scan                 ;scan with scnl_cnt
              cjne      r2,#0h,in_data          ;r2 have return data
chk_sline:    mov       a,scnl_cnt              ;scan line counter inc
              inc       a                       ;
              cjne      a,#KEYSCAN_NO,inc_sline ; scan line
              mov       scnl_cnt,#0h            ;row scan order is over
              jnb       kin_bit,offch_chk       ;
              clr       kin_bit                 ;1 loop complete
              ret                               ;over 20 line scan offch inc +1
              ;                                 ;
inc_sline:    inc       scnl_cnt                ;next scan line scan line save
              ret                               ;
              ;---------------------------------;
offch_chk:    mov       dptr,#flg_offcht        ;off chattering counter check
              movx      a,@dptr                 ;
incoffct:     inc       a                       ;
              movx      @dptr,a                 ;off chattering counter inc
              ljmp      clr_ck_cd               ;ret to first key buffer clear
              ;---------------------------------;
multi:        mov       scnl_cnt,#0h            ;column or law multi error
              clr       kin_bit                 ;reset scan line & valid key flg
              ljmp      clr_off_ch              ;reset first key buf clear
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;             return data valid                 ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;column multi check
in_data:      jb          kin_bit,multi         ;in case of set of kin_bit
              setb        kin_bit               ;above 2keys are enter during 20 times scan
              ;
              mov         a,r2                  ;return data
              clr         c                     ;raw multi check
findacc:      rrc         a                     ;rotate right
              jnc         findacc               ;until carry
              jz          chkcode               ;only 1 bit entered
              ljmp        multi                 ;return row line multi
              ;                                 ;
chkcode:      clr         c                     ;MAKE KEY CODE
              mov         r1,scnl_cnt           ;detected scan line
              sjmp        makecode              ;
              ;                                 ;
mkcode:       mov         a,r1                  ;scan line
              add         a,#010h               ;
              mov         r1,a                  ;
makecode:     mov         a,r2                  ;load scan data
              rrc         a                     ;
              mov         r2,a                  ;
              jnc         mkcode                ;
              mov         a,r1                  ;
              mov         r2,a                  ;set scan code
              ;---------------------------------;valid one key enter
              mov         dptr,#flg_key_buf     ;first location
              movx        a,@dptr               ;
              xrl         a,r2                  ;
              jz          ckonch                ;equal
              ;                                 ;
              mov         a,r2                  ;not equal=first scan data
              movx        @dptr,a               ;set check code
              mov         a,#0h                 ;
              mov         dptr,#flg_oncht       ;
inconct:      inc         a                     ;on chattering inc
              movx        @dptr,a               ;
              ljmp        chk_sline             ;
              ;---------------------------------;
ckonch:       mov         dptr,#flg_oncht       ;*ON CHATTERING TIME CHECK
              movx        a,@dptr               ;
              clr         c                     ;95.11.06
              cjne        a,#KEYCHATT_NO,chk_on ;on chattering passed, then cont depress
chk_on:       jc          inconct               ;
              ;---------------------------------;on chattering pass (valid key)
              mov         dptr,#flg_key_buf+01h ;last scan key
              movx        a,@dptr               ;valid key code compare
              xrl         a,r2                  ;
              jnz         kcode_udate           ;not equal
              ;---------------------------------;
              mov         dptr,#flg_offcht      ;equal
              movx        a,@dptr               ;*OFF CHATTERING TIME CHECK
              clr         c                     ;
              cjne        a,#KEYCHATT_NO,chk_off;not pass off chattering, cont depress
chk_off:      jc          clr_off_ch            ;95.11.06
              ;---------------------------------;
kcode_udate:  mov         a,r2                  ;feed key chk
              cjne        a,#RFEED,ok_up        ;
              sjmp        clr_off_ch            ;
              ;                                 ;
pclr_chk:     mov         a,pend_flg            ;paper end status chk
              cjne        a,#01h,ok_up          ;
              mov         a,r2                  ;
              cjne        a,#CLEAR,clr_off_ch   ;
;;;;;;;; delete to paper end senser
;              mov         dptr,#comm_stat       ;paper near sensor check
;              movx        a,@dptr               ;
;              jnb         acc.2,clr_off_ch      ;
;;;;;;;;;;;;;;;;;;
              mov         pend_flg,#0h          ;
              lcall       inidtx                ;
              lcall       outdtx                ;
              sjmp        buz_act               ;
              ;                                 ;
ok_up:        mov         r3,#KEYBUFF_NO        ;storing key buffer
              mov         dptr,#flg_key_buf+KEYBUFF_END
update_key:   movx        a,@dptr               ;
              inc         dptr                  ;
              movx        @dptr,a               ;
              mov         a,dpl                 ;
              dec         a                     ;
              dec         a                     ;
              mov         dpl,a                 ;
              ;                                 ;
              djnz        r3,update_key         ;
              mov         dptr,#flg_key_pend    ;key pend count inc
              movx        a,@dptr               ;
              inc         a                     ;
              movx        @dptr,a               ;
              ;---------------------------------;
buz_act:
              mov         dptr,#SYS_OPT+1       ;SYS_OPT.OPT2_1
              movx        a,@dptr               ;
              jnb         acc.0,buz_skip
              clr         p1.4                  ;
buz_skip:
              mov         buzz_cnt,#0h          ;TIMER 1 RUN
              mov         scnl_cnt,#0h          ;
              ;                                 ;
clr_off_ch:   mov         a,#0h                 ;
              mov         dptr,#flg_offcht      ;
              movx        @dptr,a               ;
              ;                                 ;
clr_ck_cd:    mov         a,#0ffh               ;
              mov         dptr,#flg_key_buf     ;first key buffer clear with 'ffh'
              movx        @dptr,a               ;
              ret                               ;
;***********************************************;
ky_scan:      clr         ie.2                  ;test1
              clr         c                     ;
              mov         a,scnl_cnt            ;get scan line no.
              mov         r1,a                  ;
              mov         dptr,#ky_sc_adn       ;normal key
              movc        a,@a+dptr             ;high order address
              mov         dptr,#key_addr       ;
              mov         dpl,a                 ;get scan line no.
              movx        a,@dptr               ;key read
              xrl         a,#0ffh               ;read data conversion
              anl         a,#7fh
              mov         r2,a                  ;
              setb        ie.2                  ;test1
              ret                               ;
;-----------------------------------------------;
;    60 KEYS        ;   1 1 1 1    1 1 1 0  0 0 0 0  1 X X X (0FE08H)
;    90 KEYS        ;   1 1 1 1    1 1 1 0  0 0 0 1  0 X X X (0FE10H)
;   160 KEYS        ;   1 1 1 1    1 1 1 0  0 0 1 0  0 X X X (0FE20H)
;-----------------------------------------------;
ky_sc_adn:     db         008h                  ;
               db         00Ah                  ;
               db         00Ch                  ;
               db         00Eh                  ;
               db         018h                  ;
               db         01Ah                  ;
               db         01Ch                  ;
               db         01Eh                  ;
;-----------------------------------------------;
               nop                              ;
;-----------------------------------------------;
fky_scan:     clr         ie.2                  ;not remove test cho
              mov         dptr,#ky_sc_adn       ;
              mov         a,r1                  ;get scan line no.
              movc        a,@a+dptr             ;high order address
              mov         dptr,#key_addr        ;
              mov         dpl,a                 ;get scan line no.
              ;                                 ;
              clr         ie.1                  ;not remove test cho
              movx        a,@dptr               ;key read
              xrl         a,#0ffh               ;read data conversion
              anl         a,#3fh
              setb        ie.1                  ;not remove test cho
              setb        ie.2                  ;not remove test cho
              ret                               ;
;********************************************************************
;***                                                              ***
;***                   SERIAL IO CONTROL                          ***
;***                                                              ***
;********************************************************************
int_sio:        clr     ie.7                    ;
                push    acc                     ;
                push    b                       ;
                push    psw                     ;
                push    dph                     ;
                push    dpl                     ;
                push    _r+0                    ;
                push    _r+1                    ;
                push    _r+2                    ;
                push    _r+3                    ;
                push    _r+4                    ;
                push    _r+5                    ;
                jb      scon.1,s_transs         ;
                jb      scon.0,s_recei          ;
sio_rett:       ljmp    sio_ret                 ;
s_transs:       ljmp    s_trans
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;;;;;;;   SIO RECEIVE   ;;;;;;;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
s_recei:        clr     scon.0                  ;
                mov     dptr,#SYS_OPT+3         ;SYS_OPT.OPT13_1
                movx    a,@dptr                 ;
                cjne    a,#03h,s_receiv
                sjmp    chk_liq
s_receiv:       mov     a,comm_kind             ;comm_kind = 0 : PC
                cjne    a,#0h,slip_chk          ;            1 : SLIP
                ljmp    ser_pc                  ;
slip_chk:       cjne    a,#02h,sio_rett         ;            2 : SCALE
                ;;;;;;   SCALE RECEIVE   ;;;;;;;;
                mov     a,s_in_flg              ;interrupt active flg
                cjne    a,#01h,sio_rett         ;
                mov     a,sbuf                  ;
                mov     r0,a                    ;
                mov     dptr,#comm_buff         ;receive DATA save
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                mov     dpl,a                   ;
                jnc     r_ccc                   ;
                inc     dph                     ;
r_ccc:          mov     a,r0                    ;
                anl     a,#07fh                 ;remove parity
                movx    @dptr,a                 ;
                inc     io_cnt                  ;
                cjne    a,#ETX,chk_iocnt        ;
scale_end:      mov     rend_flg,#01h           ;r end
                sjmp    sio_rett                ;
chk_iocnt:      mov     a,io_cnt                ;
                clr     c                       ;
                cjne    a,#010h,ck_gt           ;
ck_gt:          jc      sio_rett                ;
                sjmp    scale_end               ;
                ;;;
chk_liq:        mov     a,sbuf                  ;
                mov     r0,a                    ;
                mov     dptr,#comm_buff         ;receive DATA save
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                mov     dpl,a                   ;
                jnc     r_cccc                  ;
                inc     dph                     ;
r_cccc:         mov     a,r0                    ;
                anl     a,#07fh                 ;remove parity
                movx    @dptr,a                 ;
                inc     io_cnt                  ;
                cjne    a,#0ah,end_liq          ;
                mov     a,io_cnt                ;
                mov     io_cnt,#00h
                clr     c                       ;
                cjne    a,#05h,ck_gt2           ;
ck_gt2:         jc      sio_ret                 ;
                mov     rend_flg,#02h           ;r end
                MOV     A,#$BYTE3 liq_cpy       ;
                MOV     DPTR,#liq_cpy           ;
                LCALL   ?X_CALL_L18             ;
end_liq:        sjmp    sio_ret                 ;
                ;
                ;;;;;;;;;  PC RECEIVE   ;;;;;;;;;
ser_pc:         mov     a,s_in_flg              ;interrupt active flg
                cjne    a,#01h,sio_ret          ;
                ;                               ;
                mov     a,sbuf                  ;
                mov     r0,a                    ;
                lcall   recv_chk                ;
                mov     a,dsave_flg             ;save data indicator flg
                cjne    a,#01h,sio_ret          ;
;;;             ;                               ;
;;;             mov     dptr,#flg_dis_txt+9     ;
;;;             mov     a,#05fh                 ;
;;;             movx    @dptr,a                 ;
;;;             ;                               ;
                mov     dptr,#comm_buff         ;receive DATA save
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                mov     dpl,a                   ;
                jnc     r_cc                    ;
                inc     dph                     ;
r_cc:           mov     a,r0                    ;
                movx    @dptr,a                 ;
                inc     io_cnt                  ;
                sjmp    sio_ret                 ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;;;;;;;   SIO TRANSMT   ;;;;;;;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
s_trans:        clr     scon.1                  ;
                ;                               ;
                mov     a,s_out_flg             ;trans active flg
                cjne    a,#01h,sio_ret          ;
                ;                               ;
                mov     dptr,#comm_buff         ;
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                jnc     t_cc                    ;
                inc     dph                     ;
t_cc:           mov     dpl,a                   ;
                movx    a,@dptr                 ;
                mov     sbuf,a                  ;
                inc     io_cnt                  ;
                mov     a,io_cnt                ;
                cjne    a,trx_buf_cnt,sio_ret   ;
                mov     tend_flg,#01h           ;
sio_ret:        pop     _r+5                    ;
                pop     _r+4                    ;
                pop     _r+3                    ;
                pop     _r+2                    ;
                pop     _r+1                    ;
                pop     _r+0                    ;
                pop     dpl                     ;
                pop     dph                     ;
                pop     psw                     ;
                pop     b                       ;
                pop     acc                     ;
                setb    ie.7                    ;
                reti                            ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
recv_chk:       mov     dsave_flg,#0h           ;
                mov     a,data_s_end            ;
                cjne    a,#01h,chk_stx          ;data stream end flg check
                sjmp    end_del_chk             ;
chk_stx:        mov     a,stx_flg               ;
                cjne    a,#01h,chk_dle0         ;
                mov     a,io_cnt                ;
                cjne    a,#0h,ld_itm_cnt        ;
                sjmp    sv_drecv                ;save receive data (RECEIVE COUNTER)
ld_itm_cnt:     mov     dptr,#comm_buff         ;DATA stream counter = rbuff
                movx    a,@dptr                 ;
                clr     c                       ;
                cjne    a,io_cnt,go_go          ;
                sjmp    mk_s_end                ;EQUAL
go_go:          jnc     sv_drecv                ;LS
mk_s_end:       mov     data_s_end,#01h         ;data stream end flg set
                sjmp    recv_chk                ;
                ;                               ;
end_del_chk:    mov     a,etx_flg               ;
                cjne    a,#01h,ck_e_del         ;save data & end
                sjmp    chk_crc                 ;
ck_e_del:       mov     a,r0                    ;
                cjne    a,#DLE,go_drecv         ;
                ;data stream end                ;
                ret                             ;
go_drecv:       cjne    a,#ETX,chk_crc          ;data receive
                mov     etx_flg,#01h            ;
                ret                             ;
sv_drecv:       mov     dsave_flg,#01h          ;
                ret                             ;
                ;                               ;
chk_crc:        mov     a,rend_flg              ;crc flg check
                cjne    a,#0h,crc2_sv           ;
                mov     a,r0                    ;save crc1
                mov     crc1_data,a             ;
                mov     rend_flg,#01h           ;
                ret                             ;
crc2_sv:        mov     a,r0                    ;
                mov     crc2_data,a             ;
                mov     rend_flg,#02h           ;
                ret                             ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ; recv data 1st. check          ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
chk_dle0:       mov     a,r0                    ;character control check
                cjne    a,#DLE,chk_dle1         ;
                mov     dle_flg,#01h            ;
                ret                             ;
chk_dle1:       mov     a,dle_flg               ;
                cjne    a,#01h,skip_data        ;
                mov     a,r0                    ;Check STX
                cjne    a,#STX,chk_ack          ;
                mov     stx_flg,#01h            ;
                ret                             ;
chk_ack:        cjne    a,#ACK,chk_nack         ;Check ACK
                mov     ack_flg,#01h            ;
                ret                             ;
chk_nack:       cjne    a,#NACK,skip_data       ;Check NACK
                mov     nack_flg,#01h           ;
                ret                             ;
skip_data:                                      ;NON data / recv reject
                ret                             ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;   TRANS ACK  ROUTINE   ;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
delayy:         mov     r1,#0ffh                ;9ffffhx5 = 1.5 sec
dly_lop:        nop                            ;ffff
                nop                            ;
                nop                            ;
                djnz    r1,dly_lop               ;
                ret
send_ack:       call    delayy
                clr     ie.7                    ;sio int disable
                mov     s_out_flg,#0h           ;
                mov     a,#DLE                  ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                mov     a,#ACK                  ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                setb    ie.7                    ;sio int enable
                ret                             ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;   TRANS NACK ROUTINE   ;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
send_nack:      call    delayy
                clr     ie.7                    ;sio int disable
                mov     s_out_flg,#0h           ;
                mov     a,#DLE                  ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                mov     a,#NACK                 ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                setb    ie.7                    ;sio int enable
                ret                             ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;   RECV PARAMETER INIT  ;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
rflg_init:      mov     rend_flg,#0h            ;
                mov     data_s_end,#0h          ;data stream end flg set
                mov     stx_flg,#0h             ;
                mov     dsave_flg,#0h           ;
                mov     etx_flg,#0h             ;
                mov     dle_flg,#0h             ;
                mov     ack_flg,#0h             ;
                mov     nack_flg,#0h            ;
                mov     s_in_flg,#01h           ;recev int active flg
                mov     comm_kind,#0h           ;comm_kind = 0 : PC
                mov     comm_err,#0h            ;
                ret                             ;
;********************************************************************
rvd_vcheck:     mov     dptr,#comm_buff         ;receive data valid check
                lcall   save_dp                 ;
                mov     r1,io_cnt               ;
                mov     r2,#0h                  ;crc 1
                mov     r3,#0h                  ;crc 2
                mov     r4,#0h                  ;
ck_lp:          lcall   load_dp                 ;
                movx    a,@dptr                 ;
                inc     dptr                    ;
                lcall   save_dp                 ;
                clr     c                       ;
                add     a,r2                    ;
                mov     r2,a                    ;
                jnc     dec_iocnt               ;
                inc     r3                      ;
dec_iocnt:      djnz    r1,ck_lp                ;
                mov     a,r2                    ;
                anl     a,#07fh                 ;
                cjne    a,crc1_data,nack_set    ;
                mov     a,r3                    ;
                anl     a,#07fh                 ;
                cjne    a,crc2_data,nack_set    ;
                mov     r4,#0h                  ;
                ret                             ;
nack_set:       mov     r4,#01h                 ;
                ret                             ;
;-----------------------------------------------;
;***********************************************;
;***             RTC READ ROUTINE            ***;
;***********************************************;
;                          20   01   40   80
;data D3 / D2 / D1 / D0 -> D7 / D6 / D5 / D4    ;
rtc_conv1:
                rl      a
                rl      a
                rl      a
                rl      a
                anl     a,#0f0h
                ret                             ;
rtc_conv2:
                rr      a
                rr      a
                rr      a
                rr      a
                anl     a,#0fh
                ret                             ;
;-----------------------------------------------;
;********************************************************************
;***                                                              ***
;***                       ASSM SUBROUTINE                        ***
;***                                                              ***
;********************************************************************
;-----------------------------------------------;
;            display seg make & out             ;
;-----------------------------------------------;
outdtx:         mov     a,#0h                   ;
                mov     r1,#0ah                 ;
                mov     dptr,#flg_dis_txtmp     ;
                mov     r2,dpl                  ;
                mov     dptr,#flg_dis_txt       ;
                mov     r3,dpl                  ;
                mov     r4,dph                  ;
                ;                               ;
dis_tmk:        mov     dpl,r2                  ;
                mov     dph,r4                  ;
                movx    a,@dptr                 ;
                mov     dptr,#dis_fnt           ;
                movc    a,@a+dptr               ;
                mov     dpl,r3                  ;flg_dis_txt
                mov     dph,r4                  ;
                movx    @dptr,a                 ;
                inc     r3                      ;
                inc     r2                      ;
                djnz    r1,dis_tmk              ;segment make loop
                ;                               ;
                mov     dptr,#mode_id           ;void mode cap make
                movx    a,@dptr                 ;
                cjne    a,#OMODE,set_cap        ;
                ret                             ;
                ;                               ;
set_cap:
;                mov     a,#0h                   ;cap value setting
;                mov     dptr,#decp_buf+9        ;
;                jnb     rpoff_bit,vodc_chk      ;tax cap chk
;                mov     a,#02h                  ;cap value setting
;vodc_chk:       movx    @dptr,a                 ;
;                mov     dptr,#mode_id           ;void mode cap make
;                movx    a,@dptr                 ;
;                cjne    a,#VMODE,not_vdmd       ;
;                mov     dptr,#decp_buf+8        ;
;                sjmp    vmd_cap
;not_vdmd:       mov     a,#0h                   ;cap value setting
;                mov     dptr,#decp_buf+8        ;
;                jnb     void_bit,taxc_chk       ;tax cap chk
;vmd_cap:        mov     a,#02h                  ;cap value setting
;taxc_chk:       movx    @dptr,a                 ;
;                mov     a,#0h                   ;
;                mov     dptr,#decp_buf+7        ;
;                jnb     taxs_bit,lvl_chk        ;tax cap chk
;                mov     a,#02h                  ;cap value setting
;lvl_chk:        movx    @dptr,a                 ;
;                mov     dptr,#d_level           ;
;                movx    a,@dptr                 ;
;                mov     r0,a                    ;
;                mov     a,#0h                   ;
;                mov     dptr,#decp_buf+6        ;level 1 cap
;                cjne    r0,#0h,lvl2_chk         ;
;                mov     a,#02h                  ;cap value setting
;lvl2_chk:       movx    @dptr,a                 ;
;                mov     a,#0h                   ;
;                mov     dptr,#decp_buf+5        ;level2 cap
;                cjne    r0,#01h,lvl3_chk        ;
;                mov     a,#02h                  ;cap value setting
;lvl3_chk:       movx    @dptr,a                 ;
;                mov     a,#0h                   ;
;                mov     dptr,#decp_buf+4        ;
;                cjne    r0,#02h,decim_chk       ;
;                mov     a,#02h                  ;cap value setting
;decim_chk:      movx    @dptr,a                 ;
;                ;                               ;
                jnb     kdec_bit,no_decimal     ;decimal point chk & make
                mov     dptr,#dcnt              ;
                movx    a,@dptr                 ;
                mov     decimal,a               ;decimal save
                ;                               ;
no_decimal:
;                mov     dptr,#clerk             ;
;                movx    a,@dptr                 ;
;                mov     temp1_flg,a             ;clerk on
;                ;
                mov     dptr,#decp_buf          ;
                mov     r0,#0h                  ;
                ;                               ;
lop_dcsd:       mov     a,r0                    ;
                clr     c                       ;
                cjne    a,#02h,chk_2po          ;
chk_2po:        jc      mk_dccap1               ;1 / 2 point cash decimal serv
                cjne    a,#03h,chk_2poc         ;94.07.08 mira
;                jnb     vals_bit,chk_decv       ;val cap chk
;                cjne    a,decimal,sv_d2         ;
;                sjmp    sv_d3                   ;
;                ;                               ;
chk_decv:       cjne    a,decimal,no_dcsh       ;above 2 & 3 point
                sjmp    sv_d1                   ;
                ;                               ;
chk_2poc:       cjne    a,decimal,no_dcsh       ;above 2 & 3 point
                mov     a,#01h                  ;decimal only
                sjmp    sv_d                    ;
                ;                               ;
mk_dccap1:      mov     a,r0                    ;
                cjne    a,#0h,ser_dccap2        ;
;                mov     a,temp1_flg             ;
;                jnb     acc.1,chk_dec0          ;point 1 (clerk 2)
;                mov     a,decimal               ;
;                cjne    a,#0h,sv_d2             ;only cap
;                sjmp    sv_d3                   ;cap & decimal
chk_dec0:       mov     a,decimal               ;
                cjne    a,#0h,no_dcsh           ;blank
                sjmp    sv_d1                   ;only decimal
                ;                               ;
ser_dccap2:
;                mov     a,temp1_flg             ;
;                jnb     acc.0,chk_dec1          ;point 2 (clerk 2)
;                mov     a,decimal               ;
;                cjne    a,#01h,sv_d2            ;only cap
;                sjmp    sv_d3                   ;cap & decimal
chk_dec1:       mov     a,decimal               ;
                cjne    a,#01h,no_dcsh          ;blank
                sjmp    sv_d1                   ;only decimal
                ;                               ;
sv_d3:          mov     a,#03h                  ;
                sjmp    sv_d                    ;
sv_d2:          mov     a,#02h                  ;
                sjmp    sv_d                    ;
sv_d1:          mov     a,#01h                  ;
                sjmp    sv_d                    ;
                ;                               ;
no_dcsh:        mov     a,#0h                   ;not decimal & cashier cap
sv_d:           movx    @dptr,a                 ;
                inc     dptr                    ;
                inc     r0                      ;
                cjne    r0,#04h,lop_dcsd        ;
                ret                             ;
                ;                               ;
                ;            fgedcba            ;
dis_fnt:        db         001011111b           ;0
                db         000000110b           ;1
                db         000111011b           ;2
                db         000101111b           ;3
                db         001100110b           ;4
                db         001101101b           ;5
                db         001111101b           ;6
                db         001000111b           ;7
                db         001111111b           ;8
                db         001101111b           ;9
                db         001110111b           ;A 10
                db         001111100b           ;b 11
                db         001011001b           ;C 12
                db         000111110b           ;d 13
                db         001111001b           ;E 14
                db         001110001b           ;F 15
                db         001011000b           ;L 16
                db         000110100b           ;n 17
                db         001110011b           ;P 18
                db         001101110b           ;y 19
                db         000100000b           ;- 20
                db         000101000b           ;= 21
                db         000000000b           ;blank 22
                db         000011100b           ;u 23
                nop                             ;
                nop                             ;
;-----------------------------------------------;
;            display init make & out            ;
;-----------------------------------------------;
inidtx:         mov     dptr,#SYS_OPT+23        ;SYS_OPT.OPT18_1
                movx    a,@dptr                 ;
                cjne    a,#00h,chk_one_dec      ;
                mov     decimal,#0fh            ;decimal count
                mov     r0,#01h                 ;
                mov     dptr,#flg_dis_txtmp     ;
                mov     a,#0h                   ;
                lcall   fill_da                 ;
                mov     r0,#09h                 ;
                mov     a,#022d                 ;blank
                lcall   fill_da                 ;
                ret                             ;
                ;-------------------------------;
chk_one_dec:    cjne    a,#01h,chk_thr_dec      ;
                mov     decimal,#01h            ;ONE DECIMAL count
                mov     r0,#02h                 ;
                mov     dptr,#flg_dis_txtmp     ;
                mov     a,#0h                   ;
                lcall   fill_da                 ;
                mov     r0,#08h                 ;
                mov     a,#022d                 ;
                lcall   fill_da                 ;
                ret                             ;
                ;-------------------------------;
chk_thr_dec:    cjne    a,#03h,twodec           ;
                mov     decimal,#03h            ;THREE DECIMAL count
                mov     r0,#04h                 ;
                mov     dptr,#flg_dis_txtmp     ;
                mov     a,#0h                   ;
                lcall   fill_da                 ;
                mov     r0,#06h                 ;
                mov     a,#022d                 ;
                lcall   fill_da                 ;
                ret                             ;
                ;-------------------------------;
twodec:         mov     decimal,#02h            ;decimal count
                mov     r0,#03h                 ;
                mov     dptr,#flg_dis_txtmp     ;
                mov     a,#0h                   ;
                lcall   fill_da                 ;
                mov     r0,#07h                 ;
                mov     a,#022d                 ;
                lcall   fill_da                 ;
                ret                             ;
                ;
IF 0
error9:
                mov     dptr,#flag_fis2
                movx    a,@dptr
                orl     a,#02h
                movx    @dptr,a                 ;error9 flag set
                mov     a,#6fh
                sjmp    error_sb
                ;
;
error8:
                mov     a,#7fh
                mov     dptr,#dis_buf+8
                movx    @dptr,a                 ;dis_buf8 <-- "error no."
                mov     a,#79h                  ;error symbol(9th digit)
                mov     dptr,#dis_buf+9
                movx    @dptr,a                 ;dis_buf9 <-- "E"
;               setb    flg_err
                ret
                ;
;
error7:
                mov     a,#47h
                sjmp    error_sb
                ;
error_0:
                mov     a,#5fh
                sjmp    error_sb
error:
                mov     a,#06h
ENDIF
error_sb:
IF 0
                mov     dptr,#dis_buf+8
                movx    @dptr,a                 ;dis_buf8 <-- "error no."
                mov     a,#79h                  ;error symbol(9th digit)
                mov     dptr,#dis_buf+9
                movx    @dptr,a                 ;dis_buf9 <-- "E"
                mov     dptr,#buzz_cnt
                mov     a,#0h
                movx    @dptr,a                 ;buzzer counter clear
                setb    flg_err                 ;error flag set
                setb    tcon.6                  ;timer1 start
ENDIF
                ret
r232chk:
                mov     dptr,#ptr_read         ;home position read
                mov     a,#0h
                clr     ie.7                    ;
                mov     sbuf,a                  ;
                clr     p1.4
                movx    a,@dptr                 ;
                mov     r1,a
                setb    ie.7                    ;
                mov     r2,#050h                ;9ffffhx5 = 1.5 sec
rloop:          nop                            
                nop                            ;
                nop                            ;
                nop                            ;
                nop                            ;
                nop                            ;
                nop                            ;
                nop                            ;
                nop                            ;
                nop                            ;
                djnz    r2,rloop               ;
                movx    a,@dptr                 ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                setb    p1.4
                jb      acc.5,rs_set
                clr     none05
                sjmp    nnret
rs_set:
                setb    none05
nnret:
                mov     a,r1
                jb      acc.5,nn_set
                clr     none06
                ret
nn_set:
                setb    none06
                ret
;-----------------------------------------------;
;          printer data format convert          ;
;-----------------------------------------------;
prn_reset:      mov     font_data,#0ffh         ;93.05.20
                mov     fonte_data,#0ffh        ;
                clr     rhome_bit               ;
                clr     jhome_bit               ;
                mov     tmp_cnt,#0h             ;
                mov     tmp1_cnt,#0h            ;
                mov     jam_cnt,#0h             ;
                mov     prt_chatt,#00h          ;
                mov     prt_rstm,#0h            ;
                ret                             ;
                ;-------------------------------;
prn1:           nop                             ;
                sjmp    prn_go                  ;93.05.20
                ;-------------------------------;94.03.05
prn:
                mov     a,jam_flg
                cjne    a,#01h,prn_go2
                ret
                ;
prn_go2:
                jnb     pover_bit,prn           ;near paper sensor chk
;;;;;;; delete to paper end senser
;                mov     a,pend_flg              ;
;                cjne    a,#0h,prn_pe            ;
;                mov     dptr,#comm_stat         ;paper near sensor check
;                movx    a,@dptr                 ;
;                jb      acc.2,prn_go            ;
;prn_pe:
;                mov     pend_flg,#0h           ;
;                mov     pfail_flg,#0h           ;power on p e detect
;                sjmp    prn                     ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;              ;
prn_go:         jnb     pover_bit,prn1          ;
                jb      drwr_bit,prn            ;
;;;;;;; delay 96.9.2
                mov     r1,#002h                ;about 12ms
d_h2:
                mov     r0,#0ffh
d_h21:
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                djnz    r0,d_h21
                djnz    r1,d_h2
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                jb      okbuf_bit,j_pinit      ;
                mov     dptr,#r_off             ;; 0121 TEST
                movx    a,@dptr                 ;;
                cjne    a,#01h,j_pinit3         ;;
                sjmp    j_pinit4
j_pinit3:
                mov     dptr,#SYS_OPT+4       ;SYS_OPT.OPT4_3
                movx    a,@dptr               ;
                jnb     acc.2,j_pinit
j_pinit4:
;;;; insert re-issue receipt printing
                mov     dptr,#mode_id           ;
                movx    a,@dptr                 ;
                cjne    a,#RMODE,v_chk          ;
                sjmp    rp_off                  ;
v_chk:          cjne    a,#VMODE,x_chk          ;
                sjmp    rp_off                  ;
                ;
x_chk:          cjne    a,#XMODE,j_pinit       ;
                mov     dptr,#regstep
                movx    a,@dptr
                jnz     rp_off
                mov     a,xoff_flg
                cjne    a,#01h,j_pinit
rp_off:
                jb      notbuf_bit,j_pinit2    ;
                mov     dptr,#r_off
                movx    a,@dptr
                cjne    a,#00h,reg_chk
                ;
                lcall   prn_reset
                mov     a,#$BYTE3 make_fontr
                mov     dptr,#make_fontr
                LCALL   ?X_CALL_L18             ; PKR0624

                clr     pover_bit
                mov     a,#MOTOR
                mov     dptr,#ptr_stat           ;
;               mov     dpl,a                   ;
                movx    @dptr,a                 ;Motor on
                nop                             ;
                setb    ie.2                    ;prn int free
                ;
reg_chk:        mov     dptr,#regstep          ;
                movx    a,@dptr                ;
                cjne    a,#0h,chktnd           ;
                sjmp    tnd_step               ;
chktnd:         cjne    a,#RSTEP_STEND,nor_step;split tender
                sjmp    sp_tend                ;
                ;                              ;
j_pinit:
                ljmp    prn_init
j_cnbclr:
                ljmp    ret_init
                ;
j_pinit2:
                mov     dptr,#r_off
                movx    a,@dptr
                cjne    a,#01h,j_pinit
                ljmp    ret_init
                ;
tnd_step:       mov     a,xoff_flg             ;
                cjne    a,#01h,j_pinit         ;
sp_tend:        clr     c                      ;
                mov     dptr,#buf_cnt          ;
                movx    a,@dptr                ;
                cjne    a,#53d,gtck            ;max 50
gtck:           jc      contd_step             ;continuous buffering
                jb      onlytd_bit,nor_step    ;
                mov     dptr,#r_cont
                movx    a,@dptr
                jz      cont_st1
                mov     a,#1h                  ;
                jmp     cont_st2
cont_st1:
                mov     a,#2h                  ;
cont_st2:
                mov     dptr,#buf_cnt          ;
                movx    @dptr,a                ;
contd_step:     setb    onlytd_bit             ;
                ;------------------------------;
nor_step:       clr     c                      ;
                mov     dptr,#buf_cnt          ;
                movx    a,@dptr                ;
                cjne    a,#63d,gt14            ;max.60 line
                ;                              ;
gt14:           jnc     j_cnbclr               ;
                mov     dptr,#buf_cnt          ;
                movx    a,@dptr                ;
                mov     r3,a                   ;
                mov     r1,a                   ;
                mov     dptr,#stubbuf          ;
                cjne    a,#0h,add_add          ;
                sjmp    buf_ex                 ;
add_add:        mov     a,dpl                  ;
add_ad:         clr     c                      ;
                add     a,#026d                ;96.09.18
                jnc     skp                    ;
                inc     dph                    ;
skp:            djnz    r1,add_ad              ;
                mov     dpl,a                  ;
                ;                              ;
buf_ex:         mov     dph0_add,dph           ;
                mov     dpl0_add,dpl           ;
                ;                              ;
                mov     r2,#026d               ;
                mov     dptr,#prt_buffer       ;
                mov     dph_add,dph            ;
                mov     dpl_add,dpl            ;
                ;                              ;
exch:           mov     dpl,dpl_add            ;
                mov     dph,dph_add            ;
                movx    a,@dptr                ;
                inc     dpl_add                ;
                ;                              ;
                mov     dpl,dpl0_add           ;
                mov     dph,dph0_add           ;
                movx    @dptr,a                ;
                inc     dptr                   ;
                mov     dph0_add,dph           ;
                mov     dpl0_add,dpl           ;
                djnz    r2,exch                ;
                inc     r3                     ;
                mov     a,r3                   ;
                mov     dptr,#buf_cnt          ;
                movx    @dptr,a                ;
                mov     dptr,#buft_cnt         ;
                movx    @dptr,a                ;
;                mov     dptr,#r_off
;                movx    a,@dptr
;                cjne    a,#01h,prn_init
                sjmp    ret_init          ;
                ;
prn_init:                                       ;
                lcall   prn_reset
                mov     a,#$BYTE3 make_fontr
                mov     dptr,#make_fontr
                LCALL   ?X_CALL_L18             ; PKR0624

                clr     pover_bit
pschk5:         mov     a,#MOTOR
                mov     dptr,#ptr_stat           ;
;               mov     dpl,a                   ;
                movx    @dptr,a                 ;Motor on
                nop                             ;
                setb    ie.2                    ;prn int free
ret_init:
                lcall   cnbclr                  ;prt_buffer clear
                ret                             ;
;-----------------------------------------------;
;            printer data initial               ;
;-----------------------------------------------;
prn_act:        lcall   font_clr                ;
                mov     dptr,#ptr_read          ;paper near sensor check
                movx    a,@dptr                 ;
                jnb     acc.7,init_pp           ;
                mov     pend_flg,#0h           ;
                mov     pfail_flg,#0h           ;power on p e detect
init_pp:
                ljmp    prn_init                ;
;
font_clr:       mov     dptr,#font_buffer       ;with blank ffh
clr_ff:         mov     a,#0ffh                 ;490 * 2 font
                movx    @dptr,a                 ;
                inc     dptr                    ;
                mov     a,dph                   ;
                cjne    a,#005h,clr_ff          ;
                mov     a,dpl                   ;
                cjne    a,#0ffh,clr_ff          ;
                mov     dptr,#numtxt            ;with space = blank
                mov     r0,#030d                ;
                mov     a,#' '                  ;
                lcall   fill_da                 ;
cnbclr:
                mov     dptr,#prt_buffer         ;with space = blank
                mov     r0,#026d                 ;
                mov     a,#' '                  ;
                lcall   fill_da                 ;
                ret                             ;
                ;
;-----------------------------------------------;
;                drawer open routine            ;
;-----------------------------------------------;
drawopn:        jnb     pover_bit,drawopn       ;
                jb      drwr_bit,drawopn        ;
;;;;;;; delay 96.9.2
                mov     r0,#0ffh                ;about 3 ms
d_h1:
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                nop
                djnz    r0,d_h1
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     a,#0h                   ;time start
                mov     timd_cnt,a              ;solenoid servive time support
                setb    drwr_bit                ;
                ;-------------------------------;
;                mov     dptr,#clerk             ;
;                movx    a,@dptr                 ;
;                dec     a                       ;
;                mov     dptr,#clk_drawer        ;
;                clr     c                       ;
;                add     a,dpl                   ;
;                mov     dpl,a                   ;
;                jnc     c_c                     ;
;                inc     dph                     ;
;c_c:                                            ;
;                movx    a,@dptr                 ;
;                cjne    a,#02h,nor_drw          ;
;                mov     dptr,#ram_stat          ;multi drawer opn
;                mov     a,#MLTRW                ;
;                movx    @dptr,a                 ;
;                ret                             ;
nor_drw:        mov     dptr,#ptr_stat          ;standard drawer opn
                mov     a,#STDRW                ;
                movx    @dptr,a                 ;
                ret                             ;
;-----------------------------------------------;
;                compulsory d check             ;
;-----------------------------------------------;
;;;compdchk:    jnb     pover_bit,compdchk      ;96.04.17
compdchk:       jnb     pover_bit,not_opn       ;paper near sensor check
                mov     compd_flg,#0h           ;drawer opn check
                mov     dptr,#ptr_read          ;
                movx    a,@dptr                 ;
                jnb     acc.6,not_opn           ;
                orl     compd_flg,#040h         ;0
;chk_comp2:      jnb     acc.5,not_opn           ;
;                orl     compd_flg,#020h         ;
not_opn:        ret                             ;
;-----------------------------------------------;
;               paper end sensor check          ;
;-----------------------------------------------;
pend_chk:
;                jnb     pover_bit,not_ret       ;paper near sensor check
;                mov     dptr,#ptr_read          ;paper near sensor check
;                movx    a,@dptr                 ;
;                jnb     acc.4,not_ret           ;
;                 mov     pend_flg,#01h           ;
                 mov     pend_flg,#0h           ;
not_ret:        ret                             ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;-----------------------------------------------;
;            print feeding                      ;
;-----------------------------------------------;
feeding1:
                mov     dptr,#r_cont
                movx    a,@dptr
                jz      feeding
                ret
feeding:
                mov     dptr,#0h                ;
                jnb     pover_bit,feeding      ;
                ;                               ;
                clr     rhome_bit               ;
                clr     ffedoff_bit             ;
                mov     tmp_cnt,#0h             ;
                mov     tmp1_cnt,#0h            ;
                mov     prt_chatt,#0h           ;
                mov     prt_rstm,#0h            ;
                lcall   pport_init              ;
                mov     dptr,#r_off
                movx    a,@dptr
                cjne    a,#01h,fed_con
                jb      okbuf_bit,fed_con
                jb      sfeed_bit,feed_rt
fed_con:
                clr     pover_bit               ;
                setb    ie.2                    ;int free
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;  Test 12/10
                ;;setb    ie.7                    ;int free
                ;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;                lcall   pop_pstat
;;                anl     a,#40
;;                jz      pschk8
;;                mov     a,#MOTOR_L
;;                sjmp    pschk8_out
pschk8:         mov     a,#MOTOR
pschk8_out:
;;                lcall   push_pstat
                mov     dptr,#ptr_stat          ;
                movx    @dptr,a                 ;motor on
                nop                             ;
feed_rt:
                ret                             ;
;-----------------------------------------------;
;            print port initial                 ;
;-----------------------------------------------;
prn_nn:
                mov     a,#DOT_9_L
                mov     dptr,#ptr_stat
                movx    @dptr,a
                ret

pport_init:     mov     a,#0ffh                 ;0ffh
                mov     dptr,#ptr_font           ;
;                mov     dpl,a                   ;
                movx    @dptr,a                 ;dot0-8 clear
                lcall   prn_nn
                ret                             ;
;-----------------------------------------------;
;            disply port initial                ;
;-----------------------------------------------;
dport_init:     mov     r5,#013h                ;19ea
dsp_loopi:      mov     a,r5                    ;
                clr     p1.5                    ;clock clr
                nop                             ;
                clr     p1.7                    ;data in 1=on 0=off
                nop                             ;
                setb    p1.5                    ;
                nop                             ;
                djnz    r5,dsp_loopi            ;
                ;                               ;
                setb    p1.6                    ;75518 latch enable
                nop                             ;
                nop                             ;
                clr     p1.6                    ;
                ret                             ;
;-----------------------------------------------;
;            external ram clear                 ;
;-----------------------------------------------;
exramclr:     mov        r1,#01h                ;
srt_add:      mov        dptr,#0h               ;
ext_ramc:     cjne       r1,#01h,w_zero         ;
              mov        a,#0ffh                ;
              sjmp       wrt_init               ;
w_zero:       mov        a,#0h                  ;
wrt_init:     movx       @dptr,a                ;
              inc        dptr                   ;
              mov        a,dph                  ;testtt
              cjne       a,#0fdh,ext_ramc       ;62k ram
              mov        a,dpl                  ;0000h - fdffh
              ;                                 ;
exttt:        cjne       a,#0ffh,ext_ramc       ;
              cjne       r1,#01h,w_z            ;
              mov        a,#0ffh                ;
              sjmp       in_p                   ;
w_z:          mov        a,#0h                  ;
in_p:         movx       @dptr,a                ;
              ;---------------------------------;
test_skp:     mov        dptr,#0h               ;
ext_exc0:     movx       a,@dptr                ;
              inc        dptr                   ;
              cjne       r1,#01h,r_zero         ;
              cjne       a,#0ffh,err0           ;
              sjmp       r_cont1                ;
r_zero:       cjne       a,#0h,err0             ;
r_cont1:      mov        a,dph                  ;
              cjne       a,#0fdh,ext_exc0       ;
              mov        a,dpl                  ;
              cjne       a,#0ffh,ext_exc0       ;
              cjne       r1,#01h,exram_end      ;r1 = 0 end
              mov        r1,#0h                 ;
              sjmp       srt_add                ;
exram_end:    ret                               ;
err0:         mov        dptr,#ram_end          ;
              movx       @dptr,a                ;
              setb       err_bit                ;
              ret                               ;
;-----------------------------------------------;
;        @dptr <- acc untill r0 times           ;
;-----------------------------------------------;
fill_da:      movx        @dptr,a               ;
              inc         dptr                  ;
              djnz        r0,fill_da            ;
              ret                               ;
              ;
rd_clear:                                   ; 981014
              mov       dptr,#ptr_read
              movx      a,@dptr
              mov       io_cnt,a
              ret
;-----------------------------------------------;
;           initial func parameter              ;
;-----------------------------------------------;
init_mdchg:   mov     a,#0h                     ;
              mov     dptr,#rcnt                ;
              movx    @dptr,a                   ;
              mov     dptr,#zero_flg            ;95.11.03
              movx    @dptr,a                   ;
;              clr     vals_bit                  ;
              clr     clear_bit                 ;
              clr     err_bit                   ;
clr_num:      mov     dptr,#nur                 ;
              mov     a,#0h                     ;
              mov     r0,#04h                   ;
              lcall   fill_da                   ;
              mov     dptr,#ncnt                ;
              movx    @dptr,a                   ;
              mov     dptr,#dcnt                ;
              movx    @dptr,a                   ;
              clr     knur_bit                  ;
              clr     kdec_bit                  ;
              ret                               ;
              ;                                 ;
initseq:      lcall   initky                    ;
              clr     taxs_bit                  ;
              mov     a,#0h                     ;
              mov     twostep_id,a              ;
              mov     dptstp_id,a               ;
              mov     dptstp1_id,a              ;
              mov     dptr,#scale_bit
              movx    @dptr,a                   ;
              mov     dptr,#sglok_flg
              movx    @dptr,a                   ;
              mov     rstep_id,a                ;clear at tender
              mov     pskp_flag,a               ;94.01.12
              ret                               ;
;-----------------------------------------------;
initky:       mov         a,#0h                 ;table.h modify (consecutive)
              mov         key_id,a              ;to reduce asm code
              mov         dptr,#zero_flg        ;95.11.03
              movx        @dptr,a               ;
              mov         dptr,#dcnt            ;
              movx        @dptr,a               ;
              mov         dptr,#ncnt            ;
              movx        @dptr,a               ;
              mov         dptr,#func            ;
              mov         r0,#2h                ;
              lcall       fill_da               ;
              mov         dptr,#nur             ;
              mov         a,#0h                 ;
              mov         r0,#4h                ;
              lcall       fill_da               ;
              mov         dptr,#pcode           ;
              mov         r0,#2h                ;
              lcall       fill_da               ;
              mov         dptr,#dnur            ;
              mov         r0,#4h                ;
              lcall       fill_da               ;
              ret                               ;
;-----------------------------------------------;
;        func (dept/plu) var reload             ;
;-----------------------------------------------;
loadseq:
              mov         dptr,#rstepold_id       ;
              movx        a,@dptr               ;
              mov         rstep_id,a           ;
                                                ;
              mov         dptr,#dptsav_id       ;
              movx        a,@dptr               ;
              mov         dptstp_id,a           ;
                                                ;
              mov         dptr,#dptsav1_id      ;
              movx        a,@dptr               ;
              mov         dptstp1_id,a          ;
                                                ;
              mov         dptr,#twosave_id      ;
              movx        a,@dptr               ;
              mov         twostep_id,a          ;
                                                ;
              mov         dptr,#sfunc           ;
              movx        a,@dptr               ;
              mov         dptr,#func            ;
              movx        @dptr,a               ;
              mov         dptr,#sfunc+1         ;
              movx        a,@dptr               ;
              mov         dptr,#func+1          ;
              movx        @dptr,a               ;
              mov         dptr,#spcode          ;
              movx        a,@dptr               ;
              mov         dptr,#pcode           ;
              movx        @dptr,a               ;
              mov         dptr,#spcode+1        ;
              movx        a,@dptr               ;
              mov         dptr,#pcode+1         ;
              movx        @dptr,a               ;
              ret                               ;
;-----------------------------------------------;
;        func (dept/plu) var save               ;
;-----------------------------------------------;
saveseq:      mov         a,dptstp_id           ;
              mov         dptr,#dptsav_id       ;
              movx        @dptr,a               ;
                                                ;
              mov         a,dptstp1_id          ;
              mov         dptr,#dptsav1_id      ;
              movx        @dptr,a               ;
                                                ;
              mov         a,twostep_id          ;
              mov         dptr,#twosave_id      ;
              movx        @dptr,a               ;
                                                ;
              mov         dptr,#func            ;
              movx        a,@dptr               ;
              mov         dptr,#sfunc           ;
              movx        @dptr,a               ;
              mov         dptr,#func+1          ;
              movx        a,@dptr               ;
              mov         dptr,#sfunc+1         ;
              movx        @dptr,a               ;
              mov         dptr,#pcode           ;
              movx        a,@dptr               ;
              mov         dptr,#spcode          ;
              movx        @dptr,a               ;
              mov         dptr,#pcode+1         ;
              movx        a,@dptr               ;
              mov         dptr,#spcode+1        ;
              movx        @dptr,a               ;
              ret                               ;
;-----------------------------------------------;
;           end temp clear                      ;
;-----------------------------------------------;
endclr:       mov        dptr,#tnd_clre         ;
              mov        dph_add,dph            ;
              mov        dpl_add,dpl            ;
              mov        dptr,#tnd_clrs         ;
tnd_ramc1:    mov        a,#0h                  ;
              movx       @dptr,a                ;
              inc        dptr                   ;
              mov        a,dph                  ;
              cjne       a,dph_add,tnd_ramc1    ;
              mov        a,dpl                  ;
              cjne       a,dpl_add,tnd_ramc1    ;
              ret                               ;
;-----------------------------------------------;
;           temp area clear (system initial)    ;
;-----------------------------------------------;
p_temp_clr:   mov       r2,#0h                  ;
              mov       r1,#0h                  ;
p_scan:       lcall     fky_scan               ;
              cjne      r1,#SBSCAN_LINE,p_more  ;"SUBT " (c9h)
              mov       r2,a                    ;
              sjmp      p_inc                   ;
              ;                                 ;
p_more:       cjne      a,#00h,p_end            ;column mult chk
p_inc:        inc       r1                      ;
              cjne      r1,#KEYSCAN_NO,p_scan   ;
              mov       a,r2                    ;
              cjne      a,#SBRETN_DATA,p_end    ;SUBT
              mov       dptr,#temp_area         ;
              mov       dpl0_add,dpl            ;
              mov       dph0_add,dph            ;
              mov       dptr,#flg_dis_txt       ;
              lcall     zero_in                 ;
              setb      allramclr_bit           ;
              setb      tempramclr_bit          ;
p_end:        ret                               ;
;                                               ;
zero_in:      mov        a,#0h                  ;
              movx       @dptr,a                ;
              inc        dptr                   ;
              mov        a,dph                  ;
              cjne       a,dph0_add,zero_in     ;
              mov        a,dpl                  ;
              ;                                 ;
              cjne       a,dpl0_add,zero_in     ;
              mov        a,#0h                  ;
              movx       @dptr,a                ;
              ret                               ;
;****************************************************;
;                                                    ;
;       EPROM READ WRITE (Fiscal control)            ;
;                                                    ;
;****************************************************;
IF 0
sep_long:       mov     dptr,#fsbuf                  ;
                mov     r1,#04h                      ;
                lcall   save_dp0                     ;
                mov     dptr,#temp_long              ;
                lcall   save_dp                      ;
                sjmp    sep_lop                      ;
                ;                                    ;
sep_int:        mov     dptr,#fsbuf                  ;
                mov     r1,#02h                      ;
                lcall   save_dp0                     ;
                mov     dptr,#temp_int               ;
                lcall   save_dp                      ;
                sjmp    sep_lop                      ;
                ;                                    ;
sep_lop:        lcall   load_dp                      ;
                movx    a,@dptr                      ;
                inc     dptr                         ;
                lcall   save_dp                      ;
                lcall   load_dp0                     ;
                movx    @dptr,a                      ;
                inc     dptr                         ;
                lcall   save_dp0                     ;
                djnz    r1,sep_lop                   ;
                ret                                  ;
;----------------------------------------------------;
com_long:       mov     dptr,#fsbuf                  ;
                mov     r1,#04h                      ;
                lcall   save_dp0                     ;
                mov     dptr,#temp_long              ;
                lcall   save_dp                      ;
                sjmp    com_lop                      ;
                ;                                    ;
com_int:        mov     dptr,#fsbuf                  ;
                mov     r1,#02h                      ;
                lcall   save_dp0                     ;
                mov     dptr,#temp_int               ;
                lcall   save_dp                      ;
                sjmp    com_lop                      ;
                ;                                    ;
com_lop:        lcall   load_dp0                     ;
                movx    a,@dptr                      ;
                inc     dptr                         ;
                lcall   save_dp0                     ;
                lcall   load_dp                      ;
                movx    @dptr,a                      ;
                inc     dptr                         ;
                lcall   save_dp                      ;
                djnz    r1,com_lop                   ;
                ret                                  ;
ENDIF
;----------------------------------------------------;
save_dp0:       mov     dpl0_add,dpl                 ;
                mov     dph0_add,dph                 ;
                ret                                  ;
load_dp0:       mov     dpl,dpl0_add                 ;
                mov     dph,dph0_add                 ;
                ret                                  ;
save_dp:        mov     dpl_add,dpl                  ;
                mov     dph_add,dph                  ;
                ret                                  ;
load_dp:        mov     dpl,dpl_add                  ;
                mov     dph,dph_add                  ;
                ret                                  ;
;********************************************************************
clr_ex0:        clr     ie.0                         ;
                ret                                  ;
set_ex0:        setb    ie.0                         ;
                ret                                  ;
;***********************************************;
;            sum check sum routine              ;
;***********************************************;
set_bank:
                cjne    a,#01h,set_bk2
set_bk1:
                clr     p1.2
                clr     p1.3
                ret
set_bk2:
                cjne    a,#02h,set_bk3
                setb    p1.2
                clr     p1.3
                ret
set_bk3:
                cjne    a,#03h,set_bk4
                clr     p1.2
                setb    p1.3
                ret
set_bk4:
                setb    p1.2
                setb    p1.3
                ret
                ;
sumchk:         mov     a,brom_flg               ;
                push    acc                     ;
                mov     r3,#04h                 ;
                mov     a,r3
                lcall   set_bank
                ;                               ;
                mov     r0,#0h                  ;
                mov     r1,#0h                  ;
                mov     r2,#0h                  ;
chk_bank2:      mov     dptr,#00h               ;
                ;                               ;
schk_lp:        mov     a,#0h                   ;
                movc    a,@a+dptr               ;
                mov     r0,a                    ;
                ;                               ;
                mov     a,dph                   ;
                cjne    a,#0ffh,lp_sum          ;
                mov     a,dpl                   ;
                cjne    a,#0ffh,lp_sum          ;
                mov     a,r0                    ;
                add     a,r1                    ;
                jnc     schk_sve                ;
                inc     r2                      ;
schk_sve:       mov     r1,a                    ;
                ;                               ;
                djnz    r3,lop_bank2            ;
;               recover original bank           ;
                pop     acc                     ;
                mov     brom_flg,a               ;
                lcall   set_bank
                sjmp    put_chksum              ;
pset_b11:       clr     p1.2                    ;
                ;                               ;
put_chksum:     mov     dptr,#romsum_low        ;
                mov     a,r1                    ;
                movx    @dptr,a                 ;
                mov     dptr,#romsum_hig        ;
                mov     a,r2                    ;
                movx    @dptr,a                 ;
                ret                             ;
                ;                               ;
lp_sum:         inc     dptr                    ;
                clr     c                       ;
                mov     a,r0                    ;
                add     a,r1                    ;
                jnc     schk_sv                 ;
                inc     r2                      ;
schk_sv:        mov     r1,a                    ;
                sjmp    schk_lp                 ;
                ;-------------------------------;
lop_bank2:      mov     a,r3
                lcall   set_bank
                sjmp    chk_bank2               ;
;********************************************************************
chk_busy1:
;                clr     ie.7
                push    dph
                push    dpl
                push    acc
;;                lcall   pop_pstat                   ;
;                clr     acc.2
;                lcall   push_pstat
;                mov     dptr,#ptr_stat
;                movx    @dptr,a
                mov     dptr,#lcd_rs1
chk_b1:
                movx    a,@dptr
                anl     a,#80h
                cjne    a,#00h,chk_b1
;
;                lcall   pop_pstat                   ;
;                setb     acc.2
;                lcall   push_pstat
;                mov     dptr,#ptr_stat
;                movx    @dptr,a
                pop     acc
                pop     dpl
                pop     dph
;                setb    ie.7
                ret
;
chk_busy2:
;                clr     ie.7
                push    dph
                push    dpl
                push    acc                     ;
;                lcall   pop_pstat                   ;
;                clr     acc.2
;                lcall   push_pstat
;                mov     dptr,#ptr_stat
;                movx    @dptr,a
                mov     dptr,#lcd_rs2
chk_b2:
                movx    a,@dptr
                anl     a,#80h
                cjne    a,#00h,chk_b2
;
;                lcall   pop_pstat                   ;
;                setb     acc.2
;                lcall   push_pstat
;                mov     dptr,#ptr_stat
;                movx    @dptr,a
                pop     acc
                pop     dpl
                pop     dph
;                setb    ie.7
                ret
;
;****************************************************;
;                                                    ;
;       EPROM READ WRITE (Fiscal control)            ;
;                                                    ;
;****************************************************;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
fst_write:      ;     data -> FS ROM                 ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                jnb     pover_bit,fst_write          ;
                lcall   f_wrt_rst                    ;
                mov     dptr,#fs_t_buf               ;12(+10=22) byte
                lcall   save_dp0                     ;
                mov     r1,#0h                       ;
                mov     r2,low_add                   ;writing address
                mov     r3,high_add                  ;
                ;                                    ;
cho_lp:         lcall   load_dp0                     ;fs_t_buf
                movx    a,@dptr                      ;
                mov     fs_data,a                    ;
;;;;;;; insert for 1m fiscal eprom 96.8.6
                mov     dptr,#ram_stat
                jnb     f1m_bit,real_wrt
                mov     a,#0a0h                      ;address 16 enable
                sjmp    real_wrt1
                ;
real_wrt:
                mov     a,#080h                      ;address 16 enable
real_wrt1:
                movx    @dptr,a
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   f_wrt_s                      ;write address set
;;;;;;; insert for 1m fiscal eprom 96.8.6
;                clr     f1m_bit
                mov     dptr,#ram_stat
                mov     a,#080h                      ;address 16 disable
                movx    @dptr,a
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                inc     r1                           ;
                mov     a,r2                         ;
                cjne    a,#0ffh,add_adj22            ;
                inc     r3                           ;address inc
add_adj22:      inc     r2                           ;
                mov     a,r1                         ;
                cjne    a,blk_time,wrt_loopp         ;1 block writing
                ;                                    ;not change writing address
;;;             mov     low_add,r2                   ;save next rom address
;;;             mov     high_add,r3                  ;
                ret                                  ;
                ;                                    ;
wrt_loopp:      lcall   load_dp0                     ;fs_t_buf
                inc     dptr                         ;
                lcall   save_dp0                     ;
                ljmp    cho_lp                       ;
;*****************************************************
;       fs_l_add/fs_h_add = before reading point
;       low_add /high_add = after reading point
;*****************************************************
;***************     FISCAL READING                  *
;*****************************************************
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
fs_read:        ;     FS ROM -> data                 ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                jnb     pover_bit,fs_read            ;
                lcall   f_wrt_rst                    ;
                ;                                    ;
                mov     dptr,#fs_t_buf               ;12(+10=22) byte
                lcall   save_dp0                     ;
                ;make fs from/to address make        ;
                ;                                    ;
                mov     r2,low_add                   ;
                mov     r3,high_add                  ;
                mov     r1,#0h                       ;
                ;                                    ;
act_red:
;;;;;;; insert for 1m fiscal eprom 96.8.6
                mov     dptr,#ram_stat
                jnb     f1m_bit,real_rd
                mov     a,#0a0h                      ;address 16 enable
                sjmp    real_rd1
                ;
real_rd:
                mov     a,#080h                      ;address 16 enable
real_rd1:
                movx    @dptr,a
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   f_read_s                     ;
;;;;;;; insert for 1m fiscal eprom 96.8.6
;                clr     f1m_bit
                mov     dptr,#ram_stat
                mov     a,#080h                      ;address 16 disable
                movx    @dptr,a
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   load_dp0                     ;
                mov     a,fs_data                    ;
                movx    @dptr,a                      ;save fiscal temp buffer
                inc     dptr                         ;
                lcall   save_dp0                     ;
                inc     r1                           ;
                mov     a,r2                         ;rom address adjust
                cjne    a,#0ffh,add_adj              ;
                inc     r3                           ;
add_adj:        inc     r2                           ;
                mov     a,r1                         ;
                cjne    a,blk_time,act_red           ;blk_time=block times
                ;                                    ;
                mov     r1,#0h                       ;
                mov     r2,#0h                       ;
                mov     r3,#0h                       ;
                ret                                  ;
;----------------------------------------------------;
;               fiscal board write                   ;
;----------------------------------------------------;
;ram data  7 6 5 4 3 2 1 0                           ;
;conv data 7 6 0 5 1 4 2 3                           ;
fis_conv:       mov     b,#0h                        ;
                jnb     acc.7,cf_1                   ;
                orl     b,#080h                      ;
cf_1:           jnb     acc.6,cf_2                   ;
                orl     b,#040h                      ;
cf_2:           jnb     acc.5,cf_3                   ;
                orl     b,#01h                       ;
cf_3:           jnb     acc.4,cf_4                   ;
                orl     b,#020h                      ;
cf_4:           jnb     acc.3,cf_5                   ;
                orl     b,#02h                       ;
cf_5:           jnb     acc.2,cf_6                   ;
                orl     b,#10h                      ;
cf_6:           jnb     acc.1,cf_7                   ;
                orl     b,#04h                       ;
cf_7:           jnb     acc.0,cf_8                   ;
                orl     b,#08h                       ;
cf_8:           mov     a,b                          ;
                ret                                  ;
                ;------------------------------------;
f_wrt_s:        clr     ie.7                         ;all int mask
                mov     a,#COUTPUT                   ;control mode write set
                lcall   fis_conv                     ;
                mov     dptr,#fs_con_add             ;
                movx    @dptr,a                      ;control - write
                mov     dptr,#fs_lw_add              ;low address set
                mov     a,r2                         ;
                lcall   fis_conv                     ;
                movx    @dptr,a                      ;
                mov     dptr,#fs_hg_add              ;high address set
                mov     a,r3                         ;
                lcall   fis_conv                     ;
                movx    @dptr,a                      ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     dptr,#fs_dt_add              ;data address set
                mov     a,fs_data                    ;
                movx    @dptr,a                      ;data write
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     r5,#0bh                      ;100uS
                setb    p3.4                         ;12.5 V ENABLE
                nop                                  ;
                nop                                  ;
                nop                                  ;
                nop                                  ;
                nop                                  ;
                clr     p3.5                         ;chip ENABLE
fs_delay:       nop                                  ;
                nop                                  ;
                nop                                  ;
                nop                                  ;
                nop                                  ;
                nop                                  ;
                nop                                  ;
                nop                                  ;
                djnz    r5,fs_delay                  ;
                setb    p3.5                         ;chip DISABLE
                ;                                    ;
                clr     p3.4                         ;12.5 V DISABLE
                setb    ie.7                         ;int free
                ret                                  ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;RESET
f_wrt_rst:      clr     ie.7                         ;82c55 reset
                mov     a,#COUTPUT                   ;control mode write set
                lcall   fis_conv                     ;
                mov     dptr,#fs_con_add             ;
                movx    @dptr,a                      ;control - write
                mov     dptr,#fs_lw_add              ;low address reset
                mov     a,#0ffh                      ;95.12.15
                movx    @dptr,a                      ;
                mov     dptr,#fs_hg_add              ;high address reset
                movx    @dptr,a                      ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     dptr,#fs_dt_add              ;data address reset
                movx    @dptr,a                      ;data write
                nop                                  ;
                nop                                  ;
                setb    ie.7                         ;
                ret                                  ;
;----------------------------------------------------;
;               fiscal board read                    ;
;----------------------------------------------------;
f_read_s:       clr     ie.7                         ;all int mask
                mov     a,#CINPUT                    ;port c = data port (input)
                lcall   fis_conv                     ;
                mov     dptr,#fs_con_add             ;
                movx    @dptr,a                      ;control - read
                mov     dptr,#fs_lw_add              ;low address set
                mov     a,r2                         ;
                lcall   fis_conv                     ;
                movx    @dptr,a                      ;
                mov     dptr,#fs_hg_add              ;high address set
                mov     a,r3                         ;
                lcall   fis_conv                     ;
                movx    @dptr,a                      ;
                mov     dptr,#fs_dt_add              ;
                clr     p3.5                         ;CHIP ENABLE
                nop                                  ;
                movx    a,@dptr                      ;
                nop                                  ;
                setb    p3.5                         ;CHIP DISABLE
                mov     fs_data,a                    ;read data save
                setb    ie.7                         ;int free
                ret                                  ;
;
;----------------------------------------------------;
;            rrram test                              ;
;----------------------------------------------------;
IF 0
write_0:        mov     b,#0h                        ;
                sjmp    w_com                        ;
write_1:        mov     b,#0ffh                      ;
w_com:          mov     dptr,#ram_end                ;
                mov     dph1_add,dph                 ;
                mov     dpl1_add,dpl                 ;
                mov     dptr,#regstep+1              ;
                ;                                    ;
w_loop:         mov     a,b                          ;
                movx    @dptr,a                      ;
                inc     dptr                         ;
                mov     a,dph                        ;
                cjne    a,dph1_add,w_loop            ;
                mov     a,dpl                        ;
                cjne    a,dpl1_add,w_loop            ;
                ret                                  ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
read_0:         mov     b,#0h                        ;
                sjmp    r_com                        ;
read_1:         mov     b,#01h                       ;
r_com:          mov     dptr,#ram_end                ;
                mov     dph1_add,dph                 ;
                mov     dpl1_add,dpl                 ;
                mov     dptr,#regstep+1              ;
                ;                                    ;
r_loop:         mov     a,b                          ;
                cjne    a,#01h,chk_z                 ;chk 0
                movx    a,@dptr                      ;chk ff
                cjne    a,#0ffh,ret_err              ;
                sjmp    rr_com                       ;
                ;                                    ;
chk_z:          movx    a,@dptr                      ;
                cjne    a,#0h,ret_err                ;
rr_com:         inc     dptr                         ;
                mov     a,dph                        ;
                cjne    a,dph1_add,r_loop            ;
                mov     a,dpl                        ;
                cjne    a,dpl1_add,r_loop            ;
                ret                                  ;
ret_err:        ;
                mov     r0,a                         ;data
                mov     r1,dph                       ;
                mov     r2,dpl                       ;
                mov     a,r1                         ;
                anl     a,#0f0h                      ;
                swap    a                            ;
                mov     dptr,#flg_dis_txtmp+9        ;
                movx    @dptr,a                      ;
                mov     a,r1                         ;
                anl     a,#0fh                       ;
                mov     dptr,#flg_dis_txtmp+8        ;address
                movx    @dptr,a                      ;
                mov     a,r2                         ;
                anl     a,#0f0h                      ;
                swap    a                            ;
                mov     dptr,#flg_dis_txtmp+7        ;
                movx    @dptr,a                      ;
                mov     a,r2                         ;
                anl     a,#0fh                       ;
                mov     dptr,#flg_dis_txtmp+6        ;
                movx    @dptr,a                      ;
                mov     a,#BLANK                     ;
                mov     dptr,#flg_dis_txtmp+5        ;blank
                movx    @dptr,a                      ;
                mov     a,r0                         ;
                anl     a,#0f0h                      ;
                swap    a                            ;
                mov     dptr,#flg_dis_txtmp+4        ;data
                movx    @dptr,a                      ;
                mov     a,r0                         ;
                anl     a,#0fh                       ;
                mov     dptr,#flg_dis_txtmp+3        ;
                movx    @dptr,a                      ;
                mov     a,#BLANK                     ;
                mov     dptr,#flg_dis_txtmp+2        ;
                movx    @dptr,a                      ;
                lcall   outdtx                       ;
                ;                                    ;
                setb    err_bit                      ;
                mov     a,#03h                       ;
                mov     dptr,#errmsg                 ;
                movx    @dptr,a                      ;
                ret                                  ;
ENDIF
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;         CLEAR LCD
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
clr_lcd1:
                mov     r1,#08h
init_lc1:
                dec     r1
                mov     dptr,#lcd_wi1
                mov     a,#0B8h
                orl     a,r1
                lcall   chk_busy1
                movx    @dptr,a
                mov     a,#040h
                lcall   chk_busy1
                movx    @dptr,a
                mov     r0,#40h
                mov     dptr,#lcd_wd1
                jnb     yyyyy_bit, lccl1
                mov     a,#0ffh
                jmp     init_lc2
lccl1:
                mov     a,#00h
init_lc2:
                lcall   chk_busy1
                movx    @dptr,a
                dec     r0
                cjne    r0,#00h,init_lc2
                cjne    r1,#00h,init_lc1
                mov     dptr,#lcd_wi1
                mov     a,#03Fh
                lcall   chk_busy1
                movx    @dptr,a
;
                mov     r1,#08h
init_lc3:
                dec     r1
                mov     dptr,#lcd_wi2
                mov     a,#0B8h
                orl     a,r1
                lcall   chk_busy2
                movx    @dptr,a
                mov     a,#040h
                lcall   chk_busy2
                movx    @dptr,a
                mov     r0,#40h
                mov     dptr,#lcd_wd2
                jnb     yyyyy_bit, lccl2
                mov     a,#0ffh
                jmp     init_lc4
lccl2:
                mov     a,#00h
init_lc4:
                lcall   chk_busy2
                movx    @dptr,a
                dec     r0
                cjne    r0,#00h,init_lc4
                cjne    r1,#00h,init_lc3
                mov     dptr,#lcd_wi2
                mov     a,#03Fh
                lcall   chk_busy2
                movx    @dptr,a
end_lcd:
                ret
                ;
clr_lcd:
                mov     dptr,#dsp_y
                mov     a,#00h
                movx    @dptr,a
                mov     a,#20h
                mov     dptr,#dsp_buf
                mov     r0,#0a8h
clr_loop:
                movx    @dptr,a
                dec     r0
                inc     dptr
                cjne    r0,#00h,clr_loop
;                mov     dptr,#dsp_bak
;                mov     r0,#0a8h
;clr_loop1:
;                movx    @dptr,a
;                dec     r0
;                inc     dptr
;                cjne    r0,#00h,clr_loop1
                lcall   clr_lcd1
                ret
                ;
pkr_cpy:
                mov     dptr,#mem_dest
                inc     dptr
                movx    a,@dptr
                mov     r3,a
                inc     dptr
                movx    a,@dptr
                mov     r4,a
                mov     dptr,#mem_src
                movx    a,@dptr
                mov     r0,a
                inc     dptr
                movx    a,@dptr
                mov     r5,a
                inc     dptr
                movx    a,@dptr
                mov     r6,a
                mov     dptr,#mem_len
                movx    a,@dptr
                inc     acc
                mov     r1,a
                inc     dptr
                movx    a,@dptr
                mov     r2,a
pkr_cpy0:
                cjne    r2,#0,pkr_cpy1
                mov     r2,#0ffh
                dec     r1
                cjne    r1,#0,pkr_cpy1
                sjmp    pkr_cpye
pkr_cpy1:
                dec     r2
                mov     dph,r5
                mov     dpl,r6
                cjne    r0,#02,pkr_cpy2
                mov     acc,#0
                movc    a,@a+dptr
                sjmp    pkr_cpy3
pkr_cpy2:
                movx    a,@dptr
pkr_cpy3:
                inc     dptr
                mov     r5,dph
                mov     r6,dpl
                mov     dph,r3
                mov     dpl,r4
                movx    @dptr,a
                inc     dptr
                mov     r3,dph
                mov     r4,dpl
                sjmp    pkr_cpy0
pkr_cpye:
                ret
;
;next_rept:
;                mov     r1,#00h
;next_rept1:
;                lcall   fky_scan                ;low key check
;                cjne    r1,#PDSCAN_LINE,ck_clr  ;
;                mov     r2,a                    ;
;                sjmp    inc_scand               ;
;;                ;                               ;
;ck_clr:         cjne    r1,#CLSCAN_LINE,nt_chk  ;
;                mov     r3,a                    ;
;                sjmp    inc_scand                ;
;                ;                               ;
;nt_chk:         cjne    a,#00h,unuse_data       ;column mult chk
;inc_scand:      inc     r1                      ;
;                cjne    r1,#KEYSCAN_NO,next_rept1 ;
;                ;                               ;
;                mov     a,r2                    ;DOUBLE ZERO
;                cjne    a,#PDRETN_DATA,chk_clrck;
;                mov     a,r3                    ;
;                cjne    a,#0h,unuse_data        ;
;                mov     a,#01h                  ;
;                sjmp    ret_data                ;
;                ;
;chk_clrck:
;                mov     a,r3                    ;DOUBLE ZERO
;                cjne    a,#CLRETN_DATA,unuse_data
;                mov     a,r2                    ;
;                cjne    a,#0h,unuse_data        ;
;                mov     a,#02h                  ;
;                sjmp    ret_data                ;
;                ;
;unuse_data:
;                mov     a,#00h
;ret_data:
;                mov     dptr,#ret_kdata
;                movx    @dptr,a
;                ret
;
?X_CALL_L18:                                ; PKR0624
;===========================;
;       Save old bank       ;
;===========================;
;                           ;
;       PUSH    P1          ;
    mov     b,brom_flg
    push    b
;                           ;
;===========================;
;       Bank-switch         ;
;===========================;
;                           ;
    cjne    a,#01h,set_b2
set_b1:
    clr     p1.2
    clr     p1.3
    mov     brom_flg,#01h
    jmp     goto_fn
set_b2:
    cjne    a,#02h,set_b3
    setb    p1.2
    clr     p1.3
    mov     brom_flg,#02h
    jmp     goto_fn
set_b3:
    cjne    a,#03h,set_b4
    clr     p1.2
    setb    p1.3
    mov     brom_flg,#03h
    jmp     goto_fn
set_b4:
    setb    p1.2
    setb    p1.3
    mov     brom_flg,#04h
goto_fn:
;                           ;
;===========================;
;       Go to function      ;
;===========================;

        CLR     A
        JMP     @A+DPTR

;---------------------------------------;
;                                       ;
;       Leave current function          ;
;                                       ;
;---------------------------------------;
;                                       ;
;       Input:                          ;
;         Stack: 24-bit return address  ;
;                                       ;
;---------------------------------------;

        PUBLIC  ?X_RET_L18

?X_RET_L18:
;===========================;
;       Bank-switch         ;
;===========================;
;                           ;
;       POP     P1          ;
    pop     acc
    cjne    a,#01h,set_bp2
set_bp1:
    clr     p1.2
    clr     p1.3
    mov     brom_flg,#01h
    ret
set_bp2:
    cjne    a,#02h,set_bp3
    setb    p1.2
    clr     p1.3
    mov     brom_flg,#02h
    ret
set_bp3:
    cjne    a,#03h,set_bp4
    clr     p1.2
    setb    p1.3
    mov     brom_flg,#03h
    ret
set_bp4:
    setb    p1.2
    setb    p1.3
    mov     brom_flg,#04h
    ret
;
;---------------------------------------------------------------;
;             C variable initialization section                 ;
;             =================================                 ;
;                                                               ;
; If there is no demand that global/static C variables should   ;
; have a defined value at startup (required by ANSI), the       ;
; following section can be removed to conserve code memory      ;
; size.   Note that this part calls functions in the end of     ;
; this file, that also can be removed if initialized values are ;
; not needed.                                                   ;
;                                                               ;
; Systems controlled by a watch-dog may require additional      ;
; code insertions as the initialization can take several        ;
; milliseconds (if there are many variables) to complete.       ;
; These parts are marked with    *** WDG ***                    ;
;---------------------------------------------------------------;

;===============================================================;
; Zero out sections containing variables without explicit       ;
; initializers like in:                                         ;
;                                                               ;
;       int i;                                                  ;
;       xdata double d[10];                                     ;
;===============================================================;
C_INIT:                                       ;
;              MOV     R0,#stack_begin - 1    ; Assumes that CSTACK is last
;CLEAR_IRAM:                                  ;
;              MOV     @R0,#0                 ;
;              DJNZ    R0,CLEAR_IRAM          ;
;                                             ;
;X_CLR:        MOV     DPTR,#SFE (X_UDATA)    ; XDATA
;              MOV     R6,DPH                 ;
;              MOV     R7,DPL                 ;
;              MOV     DPTR,#SFB (X_UDATA)    ;
;              ;                              ;
;NEXT_X_UDATA:                                ;
;              MOV     A,R7                   ;
;              XRL     A,DPL                  ;
;              JNZ     NOT_EQUAL              ;
;              MOV     A,R6                   ;
;              XRL     A,DPH                  ;
;NOT_EQUAL:;                                  ;
;              JZ      GOEND                  ;
;              CLR     A                      ;
;              MOVX    @DPTR,A                ;
;              INC     DPTR                   ;
;              SJMP    NEXT_X_UDATA           ;
;GOEND:        RET                            ;
                                              ;
               MOV     R0,#stack_begin - 1    ; Assumes that CSTACK is last
CLEAR_IRAM:                                   ;
               MOV     @R0,#0                 ;
               DJNZ    R0,CLEAR_IRAM          ;
                                              ;
CHOX_INIT:                                    ;
               MOV     DPTR,#SFE (X_UDATA)    ; XDATA
               MOV     R6,DPH                 ;
               MOV     R7,DPL                 ;
               MOV     DPTR,#SFB (X_UDATA)    ;
                                              ;
NEXT_X_UDATA:                                 ;
               LCALL   COMP_R67_DPTR          ;
               JZ      INIT_VARS              ;
               CLR     A                      ;
               MOVX    @DPTR,A                ;
               INC     DPTR                   ;
               SJMP    NEXT_X_UDATA           ;
                                              ;
;===============================================================;
; Copy initializers into the proper memory segments for decla-  ;
; rations like:                                                 ;
;                                                               ;
;       int i = 7;                                              ;
;       idata char *cp = "STRING";                              ;
;===============================================================;
                                              ;
INIT_VARS:                                    ;
               MOV     DPTR,#DATA_TABLE       ; DATA
               LCALL   DI_INIT                ;
               MOV     DPTR,#IDATA_TABLE      ; IDATA
               LCALL   DI_INIT                ;
               MOV     DPTR,#XDATA_TABLE      ; XDATA
               LCALL   X_INIT                 ;
               MOV     DPTR,#YDATA_TABLE      ; For the -y compiler option
               LCALL   X_INIT                 ;
               RET                            ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
COMP_R67_DPTR:                                ;
;=============================================;
;       *** WDG ***                           ;
;                                             ;
; ACC, B, R0-R3 may be used                   ;
;=============================================;
               MOV     A,R7                   ;
               XRL     A,DPL                  ;
               JNZ     NOT_EQUAL              ;
               MOV     A,R6                   ;
               XRL     A,DPH                  ;
NOT_EQUAL:                                    ;
               RET                            ;
                                              ;
DI_INIT:                                      ;
               CLR     A                      ;
               MOVC    A,@A+DPTR              ;
               MOV     R0,A                   ;
               MOV     A,#1                   ;
               MOVC    A,@A+DPTR              ;
               MOV     R1,A                   ;
               MOV     A,#2                   ;
               MOVC    A,@A+DPTR              ;
               MOV     R6,A                   ;
               MOV     A,#3                   ;
               MOVC    A,@A+DPTR              ;
               MOV     DPL,A                  ;
               MOV     DPH,R6                 ;
MORE_DI_COPY:                                 ;
;=============================================;
;       *** WDG ***                           ;
;                                             ;
; ACC, B, R2-R6 may be used                   ;
;=============================================;
               MOV     A,R0                   ;
               XRL     A,R1                   ;
               JNZ     $+3                    ;
               RET                            ;
               CLR     A                      ;
               MOVC    A,@A+DPTR              ;
               MOV     @R0,A                  ;
               INC     DPTR                   ;
               INC     R0                     ;
               SJMP    MORE_DI_COPY           ;
                                              ;
X_INIT:                                       ;
               CLR     A                      ;
               MOVC    A,@A+DPTR              ;
               MOV     R4,A                   ;
               MOV     A,#1                   ;
               MOVC    A,@A+DPTR              ;
               MOV     R5,A                   ;
               MOV     A,#2                   ;
               MOVC    A,@A+DPTR              ;
               MOV     R6,A                   ;
               MOV     A,#3                   ;
               MOVC    A,@A+DPTR              ;
               MOV     R7,A                   ;
               MOV     A,#4                   ;
               MOVC    A,@A+DPTR              ;
               MOV     R0,A                   ;
               MOV     A,#5                   ;
               MOVC    A,@A+DPTR              ;
               MOV     DPL,A                  ;
               MOV     DPH,R0                 ;
MORE_X_COPY:                                  ;
               LCALL   COMP_R67_DPTR          ;
               JNZ     $+3                    ;
               RET                            ;
               CLR     A                      ;
               MOVC    A,@A+DPTR              ;
               INC     DPTR                   ;
               MOV     R0,DPH                 ;
               MOV     R1,DPL                 ;
               MOV     DPH,R4                 ;
               MOV     DPL,R5                 ;
               MOVX    @DPTR,A                ;
               INC     DPTR                   ;
               MOV     R4,DPH                 ;
               MOV     R5,DPL                 ;
               MOV     DPH,R0                 ;
               MOV     DPL,R1                 ;
               SJMP    MORE_X_COPY            ;
                                              ;
DATA_TABLE:                                   ;
               DB      SFB (D_IDATA)          ;
               DB      SFE (D_IDATA)          ;
               DW      SFB (D_CDATA)          ;
IDATA_TABLE:                                  ;
               DB      SFB (I_IDATA)          ;
               DB      SFE (I_IDATA)          ;
               DW      SFB (I_CDATA)          ;
XDATA_TABLE:                                  ;
               DW      SFB (X_IDATA)          ;
               DW      SFE (X_CDATA)          ;
               DW      SFB (X_CDATA)          ;
YDATA_TABLE:                                  ;
               DW      SFB (ECSTR)            ;
               DW      SFE (CCSTR)            ;
               DW      SFB (CCSTR)            ;
               NOP                            ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
               RSEG    D_UDATA                ;
               RSEG    I_UDATA                ;
               RSEG    X_UDATA                ;
               RSEG    D_CDATA                ;
               RSEG    I_CDATA                ;
               RSEG    X_CDATA                ;
               RSEG    D_IDATA                ;
               RSEG    I_IDATA                ;
               RSEG    X_IDATA                ;
               RSEG    ECSTR                  ;
               RSEG    CCSTR                  ;
               RSEG    BANK4SEG               ;
pkr_cpyc:
                mov     dptr,#mem_dest
                inc     dptr
                movx    a,@dptr
                mov     r3,a
                inc     dptr
                movx    a,@dptr
                mov     r4,a
                mov     dptr,#mem_src
                inc     dptr
                movx    a,@dptr
                mov     r5,a
                inc     dptr
                movx    a,@dptr
                mov     r6,a
                mov     dptr,#mem_len
                movx    a,@dptr
                inc     acc
                mov     r1,a
                inc     dptr
                movx    a,@dptr
                mov     r2,a
pkr_cpyc0:
                cjne    r2,#0,pkr_cpyc1
                mov     r2,#0ffh
                dec     r1
                cjne    r1,#0,pkr_cpyc1
                sjmp    pkr_cpyce
pkr_cpyc1:
                dec     r2
                mov     dph,r5
                mov     dpl,r6
                mov     acc,#0
                movc    a,@a+dptr
pkr_cpyc3:
                inc     dptr
                mov     r5,dph
                mov     r6,dpl
                mov     dph,r3
                mov     dpl,r4
                movx    @dptr,a
                inc     dptr
                mov     r3,dph
                mov     r4,dpl
                sjmp    pkr_cpyc0
pkr_cpyce:
                LJMP    ?X_RET_L18
                ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;   TRANS LOOP ROUTINE   ;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
sio_trans1:
                clr     ie.7
                clr     scon.0                  ;receive
                clr     scon.1                  ;trans
                mov     dptr,#tbuff             ;
                movx    a,@dptr                 ;
                mov     sbuf,a                  ;
w_ta:
                nop
                jnb     scon.1,w_ta             ;trans end ?
                clr     scon.1                  ;yes
                mov     timeol,#0h
                mov     timeoh,#0h
w_r2:                                           ;
                nop
                inc     timeol
                mov     a,timeol
                cjne    a,#0ffh,w_r3
                inc     timeoh
                mov     timeol,#0h
                mov     a,timeoh
                cjne    a,#11h,w_r3
                mov     dptr,#rbuff             ;
                mov     a,0ffh
                movx    @dptr,a
                sjmp    sio_enda
w_r3:
                jnb     scon.0,w_r2             ;receive end ?
                clr     scon.0                  ;yes
                mov     a,sbuf
                mov     dptr,#rbuff             ;
                movx    @dptr,a
sio_enda:       setb    ie.7
                LJMP    ?X_RET_L18
                ;
fnt_tbll:
                db      00000000b       ;20
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;21  !
                db      00000000b
                db      10111110b
                db      00000000b
                db      00000000b
                db      00000000b       ;22  "
                db      00000000b
                db      00000110b
                db      00000000b
                db      00000110b
                db      00100100b       ;23  #
                db      11111110b
                db      00100100b
                db      11111110b
                db      00100100b
                db      01001000b       ;24  $
                db      01010100b
                db      11111110b
                db      01010100b
                db      00100100b
                db      01000110b       ;25  %
                db      00100110b
                db      00010000b
                db      11001000b
                db      11000100b
                db      01101100b       ;26  &
                db      10010010b
                db      10010010b
                db      01101100b
                db      10100000b
                db      00000000b       ;27  '
                db      00000000b
                db      00001010b
                db      00000110b
                db      00000000b
                db      00000000b       ;28  (
                db      00111000b
                db      01000100b
                db      10000010b
                db      00000000b
                db      00000000b       ;29  )
                db      10000010b
                db      01000100b
                db      00111000b
                db      00000000b
                db      01001000b       ;2A  *
                db      00110000b
                db      11111100b
                db      00110000b
                db      01001000b
                db      00010000b       ;2B  +
                db      00010000b
                db      01111100b
                db      00010000b
                db      00010000b
                db      00000000b       ;2C  ,
                db      10100000b
                db      01100000b
                db      00000000b
                db      00000000b
                db      00010000b       ;2D  -
                db      00010000b
                db      00010000b
                db      00010000b
                db      00010000b
                db      00000000b       ;2E  .
                db      01100000b
                db      01100000b
                db      00000000b
                db      00000000b
                db      01000000b       ;2F  /
                db      00100000b
                db      00010000b
                db      00001000b
                db      00000100b
                db      01111100b       ;30  0
                db      10000010b
                db      10000010b
                db      10000010b
                db      01111100b
                db      00000000b       ;31  1
                db      10000100b
                db      11111110b
                db      10000000b
                db      00000000b
                db      10000100b       ;32  2
                db      11000010b
                db      10100010b
                db      10010010b
                db      10001100b
                db      01000010b       ;33  3
                db      10000010b
                db      10001010b
                db      10010110b
                db      11100010b
                db      00110000b       ;34  4
                db      00101000b
                db      00100100b
                db      11111110b
                db      00100000b
                db      01001110b       ;35  5
                db      10001010b
                db      10001010b
                db      10001010b
                db      01110010b
                db      01111100b       ;36  6
                db      10010010b
                db      10010010b
                db      10010010b
                db      01100000b
                db      00000010b       ;37  7
                db      11100010b
                db      00010010b
                db      00001010b
                db      00000110b
                db      01101100b       ;38  8
                db      10010010b
                db      10010010b
                db      10010010b
                db      01101100b
                db      00001100b       ;39  9
                db      10010010b
                db      10010010b
                db      01010010b
                db      00111100b
                db      00000000b       ;3A  :
                db      00000000b
                db      01101100b
                db      01101100b
                db      00000000b
                db      00000000b       ;3B  ;
                db      00000000b
                db      10101100b
                db      01101100b
                db      00000000b
                db      00000000b       ;3C  <
                db      00010000b
                db      00101000b
                db      01000100b
                db      10000010b
                db      00101000b       ;3D  =
                db      00101000b
                db      00101000b
                db      00101000b
                db      00101000b
                db      10000010b       ;3E  >
                db      01000100b
                db      00101000b
                db      00010000b
                db      00000000b
                db      00000100b       ;3F  ?
                db      00000010b
                db      10100010b
                db      00010010b
                db      00001100b
                db      01100100b       ;40  @
                db      10010010b
                db      11110010b
                db      10000010b
                db      01111100b
                db      11111000b       ;41  A
                db      00100100b
                db      00100010b
                db      00100100b
                db      11111000b
                db      11111110b       ;42  B
                db      10010010b
                db      10010010b
                db      10010010b
                db      01101100b
                db      01111100b       ;43  C
                db      10000010b
                db      10000010b
                db      10000010b
                db      01000100b
                db      11111110b       ;44  D
                db      10000010b
                db      10000010b
                db      10000010b
                db      01111100b
                db      11111110b       ;45  E
                db      10010010b
                db      10010010b
                db      10010010b
                db      10000010b
                db      11111110b       ;46  F
                db      00010010b
                db      00010010b
                db      00010010b
                db      00000010b
                db      01111100b       ;47  G
                db      10000010b
                db      10000010b
                db      10010010b
                db      11110100b
                db      11111110b       ;48  H
                db      00010000b
                db      00010000b
                db      00010000b
                db      11111110b
                db      00000000b       ;49  I
                db      10000010b
                db      11111110b
                db      10000010b
                db      00000000b
                db      00000000b       ;4A  J
                db      01000000b
                db      10000010b
                db      01111110b
                db      00000010b
                db      11111110b       ;4B  K
                db      00010000b
                db      00101000b
                db      01000100b
                db      10000010b
                db      11111110b       ;4C  L
                db      10000000b
                db      10000000b
                db      10000000b
                db      10000000b
                db      11111110b       ;4D  M
                db      00000100b
                db      00001000b
                db      00000100b
                db      11111110b
                db      11111110b       ;4E  N
                db      00001000b
                db      00010000b
                db      00100000b
                db      11111110b
                db      01111100b       ;4F  O
                db      10000010b
                db      10000010b
                db      10000010b
                db      01111100b
                db      11111110b       ;50  P
                db      00010010b
                db      00010010b
                db      00010010b
                db      00001100b
                db      01111100b       ;51  Q
                db      10000010b
                db      10100010b
                db      01000010b
                db      10111100b
                db      11111110b       ;52  R
                db      00010010b
                db      00110010b
                db      01010010b
                db      10001100b
                db      01001100b       ;53  S
                db      10010010b
                db      10010010b
                db      10010010b
                db      01100100b
                db      00000010b       ;54  T
                db      00000010b
                db      11111110b
                db      00000010b
                db      00000010b
                db      01111110b       ;55  U
                db      10000000b
                db      10000000b
                db      10000000b
                db      01111110b
                db      00111110b       ;56  V
                db      01000000b
                db      10000000b
                db      01000000b
                db      00111110b
                db      01111110b       ;57  W
                db      10000000b
                db      01111000b
                db      10000000b
                db      01111110b
                db      11000110b       ;58  X
                db      00101000b
                db      00010000b
                db      00101000b
                db      11000110b
                db      00000110b       ;59  Y
                db      00001000b
                db      11110000b
                db      00001000b
                db      00000110b
                db      11000010b       ;5A  Z
                db      10100010b
                db      10010010b
                db      10001010b
                db      10000110b
                db      00000000b       ;5B  [
                db      11111110b
                db      10000010b
                db      00000000b
                db      00000000b
                db      00000100b       ;5C  \
                db      00001000b
                db      00010000b
                db      00100000b
                db      01000000b
                db      00000000b       ;5D  ]
                db      00000000b
                db      10000010b
                db      11111110b
                db      00000000b
                db      00000000b       ;5E  ^
                db      00000100b
                db      00000010b
                db      00000100b
                db      00000000b
                db      10000000b       ;5F  _
                db      10000000b
                db      10000000b
                db      10000000b
                db      10000000b
                db      00000000b       ;60  .
                db      00111100b
                db      00111100b
                db      00111100b
                db      00000000b
                db      01000000b       ;61  a
                db      10101000b
                db      10101000b
                db      11110000b
                db      10000000b
                db      00000000b       ;62  b
                db      11111110b
                db      10010000b
                db      10010000b
                db      01100000b
                db      00000000b       ;63  c
                db      01110000b
                db      10001000b
                db      10001000b
                db      10001000b
                db      01100000b       ;64  d
                db      10010000b
                db      10010000b
                db      11111110b
                db      00000000b
                db      01110000b       ;65  e
                db      10101000b
                db      10101000b
                db      10101000b
                db      00110000b
                db      00000000b       ;66  f
                db      00001000b
                db      11111100b
                db      00001010b
                db      00001010b
                db      00010000b       ;67  g
                db      10101000b
                db      10101000b
                db      10101000b
                db      01111000b
                db      00000000b       ;68  h
                db      11111110b
                db      00010000b
                db      00010000b
                db      11100000b
                db      00000000b       ;69  i
                db      10001000b
                db      11111010b
                db      10000000b
                db      00000000b
                db      01000000b       ;6A  j
                db      10000000b
                db      10000000b
                db      01111010b
                db      00000000b
                db      11111110b       ;6B  k
                db      00100000b
                db      00110000b
                db      01001000b
                db      10000000b
                db      00000000b       ;6C  l
                db      00000010b
                db      11111110b
                db      00000000b
                db      00000000b
                db      11111000b       ;6D  m
                db      00001000b
                db      11110000b
                db      00001000b
                db      11110000b
                db      00000000b       ;6E  n
                db      11111000b
                db      00001000b
                db      00001000b
                db      11110000b
                db      01110000b       ;6F  o
                db      10001000b
                db      10001000b
                db      10001000b
                db      01110000b
                db      11111000b       ;70  p
                db      00101000b
                db      00101000b
                db      00101000b
                db      00010000b
                db      00010000b       ;71  q
                db      00101000b
                db      00101000b
                db      00101000b
                db      11111000b
                db      00000000b       ;72  r
                db      11111000b
                db      00010000b
                db      00001000b
                db      00001000b
                db      10010000b       ;73  s
                db      10101000b
                db      10101000b
                db      10101000b
                db      01001000b
                db      00000000b       ;74  t
                db      00001000b
                db      01111110b
                db      10001000b
                db      10001000b
                db      00000000b       ;75  u
                db      01111000b
                db      10000000b
                db      10000000b
                db      01111000b
                db      00111000b       ;76  v
                db      01000000b
                db      10000000b
                db      01000000b
                db      00111000b
                db      01111000b       ;77  w
                db      10000000b
                db      01100000b
                db      10000000b
                db      01111000b
                db      10001000b       ;78  x
                db      01010000b
                db      00100000b
                db      01010000b
                db      10001000b
                db      00011000b       ;79  y
                db      10100000b
                db      10100000b
                db      01111000b
                db      00000000b
                db      10001000b       ;7A  z
                db      11001000b
                db      10101000b
                db      10011000b
                db      00000000b
                db      00000010b       ;7B  Tx
                db      00001110b
                db      10100010b
                db      01000000b
                db      10100000b
                db      11111110b       ;7C  
                db      11111110b
                db      11111110b
                db      11111110b
                db      11111110b
                db      00010000b       ;7D  <-
                db      00111000b
                db      01010100b
                db      00010000b
                db      00010000b
                db      00100000b       ;7E   \|/
                db      01000000b
                db      11111111b
                db      01000000b
                db      00100000b
                db      00000100b       ;7F   /|\
                db      00000010b
                db      11111111b
                db      00000010b
                db      00000100b
                ;
                db      00111100b       ;80  
                db      01000010b
                db      01000010b
                db      11000010b
                db      00100100b
                db      01110000b       ;81  
                db      10000100b
                db      10000000b
                db      10000100b
                db      11110000b
                db      01110100b       ;82  
                db      10101010b
                db      10101010b
                db      10101000b
                db      00110000b
                db      01100100b       ;83  
                db      10010010b
                db      10010010b
                db      01010010b
                db      11110100b
                db      01100000b       ;84  
                db      10010100b
                db      10010000b
                db      01010100b
                db      11110000b
                db      01100000b       ;85  
                db      10010010b
                db      10010010b
                db      01010100b
                db      11110000b
                db      01100000b       ;86  
                db      10010000b
                db      10010110b
                db      01010110b
                db      11110000b
                db      00111000b       ;87  
                db      01000100b
                db      01000100b
                db      11000100b
                db      00101000b
                db      01110100b       ;88  
                db      10101010b
                db      10101010b
                db      10101010b
                db      00110100b
                db      01110000b       ;89  
                db      10101010b
                db      10101000b
                db      10101010b
                db      00110000b
                db      01110000b       ;8a  
                db      10101000b
                db      10101010b
                db      10101010b
                db      00110100b
                db      00000000b       ;8b  
                db      00000100b
                db      11110000b
                db      00000100b
                db      00000000b
                db      00000000b       ;8c  
                db      00000100b
                db      11110010b
                db      00000100b
                db      00000000b
                db      00000000b       ;8d  
                db      00000010b
                db      11110010b
                db      00000100b
                db      00000000b
                db      11100000b       ;8e  
                db      01010010b
                db      01001000b
                db      01010010b
                db      11100000b
                db      11100000b       ;8e  
                db      01010010b
                db      01001010b
                db      01010010b
                db      11100000b
                ;
                db      11111000b       ;90  
                db      10101100b
                db      10101010b
                db      10101010b
                db      10101000b
                db      11101000b       ;91  
                db      10101000b
                db      11111000b
                db      10101000b
                db      10111000b
                db      11111000b       ;92  
                db      00010110b
                db      11111110b
                db      10010010b
                db      10010010b
                db      01100100b       ;93  
                db      10010010b
                db      10010010b
                db      10010010b
                db      01100100b
                db      01100000b       ;94  
                db      10010100b
                db      10010000b
                db      10010100b
                db      01100000b
                db      01100000b       ;95  
                db      10010010b
                db      10010010b
                db      10010100b
                db      01100000b
                db      01110000b       ;96  
                db      10000100b
                db      10000010b
                db      10000100b
                db      11110000b
                db      01110000b       ;97  
                db      10000010b
                db      10000010b
                db      10000100b
                db      11110000b
                db      10011000b       ;98  
                db      10100010b
                db      10100000b
                db      01000010b
                db      00111000b
                db      01110000b       ;99  
                db      10001010b
                db      10001000b
                db      10001010b
                db      01110000b
                db      01111000b       ;9a  
                db      10000010b
                db      10000000b
                db      10000010b
                db      01111000b
                db      00111000b       ;9b  
                db      01000100b
                db      11111110b
                db      01000100b
                db      00101000b
                db      10010000b       ;9c  
                db      11111100b
                db      10010010b
                db      10010100b
                db      10000000b
                db      00001010b       ;9d  
                db      00011100b
                db      11101000b
                db      00011100b
                db      00001010b
                db      11111110b       ;9e  
                db      00001010b
                db      00101110b
                db      11110000b
                db      00100000b
                db      01000000b       ;9f  
                db      10010000b
                db      01111100b
                db      00010010b
                db      00000100b
                ;
                db      01100000b       ;a0  
                db      10010100b
                db      10010010b
                db      01010010b
                db      11110000b
                db      00000000b       ;a1  
                db      00000100b
                db      11110010b
                db      00000010b
                db      00000000b
                db      01100000b       ;a2  
                db      10010100b
                db      10010010b
                db      10010010b
                db      01100000b
                db      01110000b       ;a3  
                db      10000100b
                db      10000010b
                db      10000010b
                db      11110000b
                db      11110100b       ;a4  
                db      00100010b
                db      00010010b
                db      00010100b
                db      11100100b
                db      11110100b       ;a5  
                db      00100010b
                db      00100010b
                db      01000100b
                db      11110100b
                db      10010000b       ;a6  
                db      10101010b
                db      10101010b
                db      10111110b
                db      00000000b
                db      00000000b       ;a7  
                db      10011000b
                db      10100100b
                db      10011000b
                db      00000000b
                db      01100000b       ;a8  
                db      10010000b
                db      10001010b
                db      10000000b
                db      01100000b
                db      00001110b       ;a9  
                db      00000010b
                db      00000010b
                db      00000010b
                db      00000010b
                db      00000010b       ;aa  
                db      00000010b
                db      00000010b
                db      00000010b
                db      00001110b
                db      00101110b       ;ab  
                db      00010000b
                db      11001000b
                db      10101100b
                db      10111010b
                db      00101110b       ;ac  
                db      01010000b
                db      01101000b
                db      01010100b
                db      11111010b
                db      00000000b       ;ad  
                db      00000000b
                db      11111010b
                db      00000000b
                db      00000000b
                db      00000000b       ;ae
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;af
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                ;
                db      00000000b       ;b0
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b1
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b2
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b3
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b4
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b5
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b6
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b7
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b8
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;b9
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;ba
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;bb
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;bc
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;bd
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;be
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;bf
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                ;
                db      00000000b       ;c0
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c1
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c2
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c3
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c4
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c5
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c6
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c7
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c8
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;c9
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;ca
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;cb
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;cc
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;cd
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;ce
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;cf
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                ;
                db      00000000b       ;d0
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d1
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d2
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d3
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d4
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d5
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d6
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d7
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d8
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;d9
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;da
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;db
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;dc
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;dd
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;de
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;df
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                ;
                db      01111000b       ;e0
                db      10000100b
                db      10000010b
                db      01111100b
                db      10000010b
                db      11111100b       ;e1
                db      00101010b
                db      00101010b
                db      00101010b
                db      00010100b
                db      00000000b       ;e2
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;e3
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;e4
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;e5
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      10000000b       ;e6
                db      01111000b
                db      01000000b
                db      01111000b
                db      10000000b
                db      00000000b       ;e7
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;e8
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;e9
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;ea
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;eb
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;ec
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;ed
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00101000b       ;ee
                db      01111100b
                db      10101010b
                db      10101010b
                db      10000010b
                db      00000000b       ;ef
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                ;
                db      00000000b       ;f0
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f1
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f2
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f3
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f4
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f5
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f6
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f7
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f8
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;f9
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;fa
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;fb
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;fc
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;fd
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;fe
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b       ;ff
                db      00000000b
                db      00000000b
                db      00000000b
                db      00000000b
               ;
get_font:
                mov     dptr,#lcd_ch
                movx    a,@dptr
                mov     b,a
                inc     dptr
                movx    a,@dptr
                mov     dptr,#fnt_tbll
                add     a,dpl
                mov     dpl,a
                mov     a,b
                addc    a,dph
                mov     dph,a
                ret
                ;
lcdwrt1:
                mov     dptr,#lcd_x
                movx    a,@dptr             ; X address
                orl     a,#0B8h
                mov     dptr,#lcd_wi1
                lcall   chk_busy1
                movx    @dptr,a
                ;
                mov     dptr,#lcd_y
                movx    a,@dptr             ; Y address
                orl     a,#40h
                mov     dptr,#lcd_wi1
                lcall   chk_busy1
                movx    @dptr,a
                ;
                mov     r0,#5
                lcall   get_font
lcd_loop1:
                mov     a,#00h
                movc    a,@a+dptr             ; Get Data
                inc     dptr
                push    dph
                push    dpl
                mov     dptr,#lcd_wd1
                lcall   chk_busy1
                movx    @dptr,a
                pop     dpl
                pop     dph
                dec     r0
                cjne    r0,#00h,lcd_loop1
                ;
                LJMP    ?X_RET_L18

lcdwrt2:
                mov     dptr,#lcd_x
                movx    a,@dptr             ; X address
                orl     a,#0B8h
                mov     dptr,#lcd_wi2
                lcall   chk_busy2
                movx    @dptr,a
                ;
                mov     dptr,#lcd_y
                movx    a,@dptr             ; Y address
                orl     a,#40h
                mov     dptr,#lcd_wi2
                lcall   chk_busy2
                movx    @dptr,a
                ;
                mov     r0,#5
                lcall   get_font
lcd_loop2:
                mov     a,#00h
                movc    a,@a+dptr             ; Get Data
                inc     dptr
                push    dph
                push    dpl
                mov     dptr,#lcd_wd2
                lcall   chk_busy2
                movx    @dptr,a
                pop     dpl
                pop     dph
                dec     r0
                cjne    r0,#00h,lcd_loop2
                ;
                LJMP    ?X_RET_L18
                ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;dsp_scr:
;;                mov     dptr,#bit_buf
;;                mov     r1,#0
;;scr_loop0:
;;                push    dph
;;                push    dpl
;;                mov     a,r1
;;                orl     a,#0B8h
;;                mov     dptr,#lcd_wi1       ; X address
;;                lcall   chk_busy1
;;                movx    @dptr,a
;;                ;
;;                mov     a,#40h
;;                mov     dptr,#lcd_wi1       ; Y address
;;                lcall   chk_busy1
;;                movx    @dptr,a
;;                ;
;;                pop     dpl
;;                pop     dph
;;                mov     r0,#64
;;scr_loop1:
;;                movx    a,@dptr             ; Get Data
;;                inc     dptr
;;                push    dph
;;                push    dpl
;;                mov     dptr,#lcd_wd1
;;                lcall   chk_busy1
;;                movx    @dptr,a
;;                pop     dpl
;;                pop     dph
;;                dec     r0
;;                cjne    r0,#00h,scr_loop1
;;                push    dph
;;                push    dpl
;;                ;
;;                mov     a,r1
;;                orl     a,#0B8h
;;                mov     dptr,#lcd_wi2       ; X address
;;                lcall   chk_busy2
;;                movx    @dptr,a
;;                ;
;;                mov     a,#40h
;;                mov     dptr,#lcd_wi2       ; Y address
;;                lcall   chk_busy2
;;                movx    @dptr,a
;;                ;
;;                pop     dpl
;;                pop     dph
;;                mov     r0,#64
;;scr_loop2:
;;                movx    a,@dptr             ; Get Data
;;                inc     dptr
;;                push    dph
;;                push    dpl
;;                mov     dptr,#lcd_wd2
;;                lcall   chk_busy2
;;                movx    @dptr,a
;;                pop     dpl
;;                pop     dph
;;                dec     r0
;;                cjne    r0,#00h,scr_loop2
;;                ;
;;                inc     r1
;;                cjne    r1,#07,scr_loop0
;;                ;
;;                LJMP    ?X_RET_L18
;;                ;
;;                ;
;-----------------------------------------------;
;  make magt font text by current prn text      ;
;-----------------------------------------------;
make_fontr:
                mov     dptr,#prt_buffer+25     ;24 character RECEIPT FONT MAKE
                mov     r3,dpl                  ;receipt,journal same
                mov     r4,dph                  ;2.10(70->71)
;;;;;; change to 26 characters 95.5.15
;                mov     dptr,#font_buffer+58    ;5100h + 70
;;;;;;; change to 358T 96.5.27
;               mov     dptr,#font_buffer+48    ;5100h + 70
                mov     dptr,#font_buffer+49    ;5100h + 70
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     r5,dpl                  ;total 358 T
                mov     r6,dph                  ;2.10(70->71)
;;;;;; change to 26 characters 95.5.15
;                mov     dptr,#fonte_buffer+58   ;5100h + 70
;;;;;;; change to 358T 96.5.27
;               mov     dptr,#fonte_buffer+48   ;5100h + 70
                mov     dptr,#fonte_buffer+49   ;5100h + 70
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                mov     dpl0_add,dpl            ;total 358T
                mov     dph0_add,dph            ;
                ;                               ;
sub_lp:         mov     dpl,r3                  ;character data read
                mov     dph,r4                  ;
;;;;; delete to double character 95.5.15
;                movx    a,@dptr                 ;numeric or alphbet
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   prt_conv                ;9ch a0     a6h        b0d        ba
;                dec     r3                      ;|||||||||| |||||||||| |||||||||| |||||||||| ||
;;;;;; change to 26 characters 95.5.15
;                cjne    r3,#31h,sub_lp          ;6110h - 6127h(24 byte)           b1h             c0    c5h
                cjne    r3,#00h,sub_lp1          ;6110h - 6127h(24 byte)           b1h             c0    c5h
                jmp     ff_ret
sub_lp1:        dec     r3
                jmp     sub_lp
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
ff_ret:
                LJMP    ?X_RET_L18
;
prt_conv:                                       ;1 digit data font make
;;;;;;; insert for double character printing 95.5.15
                movx    a,@dptr
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                cjne    a,#11h,chk_zero          ;double ?
                cjne    r3,#00h,prt_cv1
                ret
prt_cv1:        setb    double_bit               ;
                dec     r3
                mov     dpl,r3
                movx    a,@dptr
;;;;;;;; change to double chacracter pering 95.5.15
;                inc     r3
;                movx    a,@dptr
;                dec     r3
;                ret
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
chk_zero:
                mov     dptr,#eng_pft
                clr     c
                subb    a,#21h
add_nxt:
                jnc     add_nxt01
                clr     c
                mov     a,r5
                add     a,#10
                jnc     add_nx01
                inc     r6
add_nx01:
                mov     r5,a
                clr     c
                mov     a,dpl0_add            ;save extra dot 9
                add     a,#10
                jnc     add_nx02
                mov     r1,dph0_add            ;fonte_buffer address
                inc     r1
                mov     dph0_add,r1
add_nx02:
                mov     dpl0_add,a
                ret
add_nxt01:
                mov     b,a
                mov     a,#08h
                mul     ab
                add     a,dpl
                mov     dpl,a
                mov     a,b
                addc    a,dph
                mov     dph,a
                ;
common_r:       mov     dpl_add,dpl             ;
                mov     dph_add,dph             ;
                mov     a,#0h                   ;
                ;
point_ok:       jnb     double_bit,not_dou      ;looping counter
                ljmp    double_ser              ;
                ;
not_dou:        mov     r1,#00h                 ;looping counter
                mov     r2,a                    ;save data location
                ;                               ;
loop_b:         mov     a,r2                    ;
                add     a,r1                    ;
                mov     dpl,dpl_add             ;font rom address
                mov     dph,dph_add             ;                     -
                movc    a,@a+dptr               ;actual font data read
                mov     dpl,r5                  ;font_buffer address
                mov     dph,r6                  ;                     -
                cjne    r1,#07h,save_nor        ;                     -
                mov     r2,a                    ;dot9 font data temp save
                lcall   space                   ;font_buffer increment 3 point
                mov     r5,dpl                  ;                     -
                mov     r6,dph                  ;font_buffer address save
                sjmp    save_end                ;                     -
                ;                               ;                     -
save_nor:       movx    @dptr,a                 ;font_buffer <-- font data
                inc     r1                      ;
                inc     dptr                    ;last space 1
                mov     r5,dpl                  ;
                mov     r6,dph                  ;
                sjmp    loop_b                  ;
                ;                               ;
save_end:       mov     r0,#07h                 ;extra dat 7 loop
                mov     dpl,dpl0_add            ;save extra dot 9
                mov     dph,dph0_add            ;fonte_buffer address
save_endl:      mov     a,r2                    ;dot 9 data
                jb      acc.7,sft_left          ;dot9 data = blank ?
                mov     a,#00h                  ;no, dot9 data set
                movx    @dptr,a                 ;data out bit = 7
sft_left:       mov     a,r2                    ;next dot9 data make
                rl      a                       ;rotate left without carry
                mov     r2,a                    ;
                inc     dptr                    ;
                djnz    r0,save_endl            ;
                lcall   space                   ;fonte_buffer address 3 increment
                mov     dpl0_add,dpl            ;fonte_buffer save
                mov     dph0_add,dph            ;
                ret                             ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;             DOUBLE CHAR MAKE        ;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
double_ser:     mov     r1,#00h                 ;looping counter
                mov     r2,a                    ;save data location
                mov     doubf_flg,#0ffh
loop_k:         mov     a,r2                    ;
                add     a,r1                    ;
                mov     dpl,dpl_add             ;
                mov     dph,dph_add             ;                     -
                movc    a,@a+dptr               ;actual font data read
                mov     dpl,r5                  ;103h
                mov     dph,r6                  ;                     -
                cjne    r1,#07h,save_nor_k      ;                     -
                mov     r2,a                    ;dot9 data            -
                ;                               ;
                mov     a,doubf_flg             ;last anl data save
                movx    @dptr,a                 ;
                inc     dptr                    ;
                lcall   space                   ;
                inc     dptr                    ;
                inc     dptr                    ;
                mov     r5,dpl                  ;
                mov     r6,dph                  ;space end address
                sjmp    save_end_k              ;
                ;                               ;
save_nor_k:     push    acc                     ;push income font
                anl     a,doubf_flg             ;anl previoud font
                movx    @dptr,a                 ;
                pop     acc                     ;
                mov     doubf_flg,a             ;
                inc     r1                      ;
                inc     dptr                    ;next blank
                inc     dptr                    ;point inc
                mov     r5,dpl                  ;
                mov     r6,dph                  ;
                sjmp    loop_k                  ;
                ;                               ;
save_end_k:     mov     r0,#07h                 ;extra dat 7 loop
                mov     doubf_flg,#0ffh         ;dot 9 data
                mov     dpl,dpl0_add            ;save extra dot 9
                mov     dph,dph0_add            ;fonte_buffer+3
save_endk:      mov     a,r2                    ;dot 9 data
                jb      acc.7,chk_next          ;
                mov     a,#00h                  ;
                mov     doubf_flg,a             ;
                movx    @dptr,a                 ;data out bit = 7
                inc     dptr                    ;next blank
                sjmp    sft_leftk               ;
chk_next:       mov     a,doubf_flg             ;
                movx    @dptr,a                 ;
                mov     doubf_flg,#0ffh         ;
                inc     dptr                    ;next blank
sft_leftk:      mov     a,r2                    ;
                rl      a                       ;rotate left without carry
                mov     r2,a                    ;
                inc     dptr                    ;
                djnz    r0,save_endk            ;
                mov     a,doubf_flg             ;
                movx    @dptr,a                 ;
                inc     dptr                    ;
                lcall   space                   ;
                inc     dptr                    ;
                inc     dptr                    ;
                mov     dpl0_add,dpl            ;
                mov     dph0_add,dph            ;
                clr     double_bit              ;
;                dec     r3                      ;prt_buffer inc
                ret                             ;
;-----------------------------------------------;
space:          inc     dptr                    ;
                inc     dptr                    ;
                inc     dptr                    ;
                ret                             ;
                ;                               ;            c5h
;*********************************************************************
;*                                                                   *
;*             dot printer font data         1992.06.26              *
;*                                                                   *
;*********************************************************************
;sym_font:
;        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;20h   - s
eng_pft:
        db      0ffh,0ffh,0ffh,088h,0ffh,0ffh,0ffh,0efh  ;21h  - !
        db      0ffh,0bdh,0ffh,0ffh,0ffh,0bdh,0ffh,0bbh  ;22h  - "
        db      03fh,0c0h,03fh,0ffh,03fh,0c0h,03fh,0bbh  ;23h  - #
        db      03bh,0d5h,0ffh,000h,0ffh,0d5h,03eh,0efh  ;24h  - $
        db      0e5h,0bfh,0e6h,0dfh,0f9h,07fh,0e5h,075h  ;25h  - %
        db      0ebh,0f7h,03dh,0eah,0dfh,0eah,035h,0ebh  ;26h  - &
        db      0ffh,0fdh,0bfh,0fch,0ffh,0ffh,0ffh,0afh  ;27h  - '
        db      0ffh,0ffh,0ffh,0ffh,0efh,0f5h,01ah,0f7h  ;28h  - (
        db      01ah,0f5h,0efh,0ffh,0ffh,0ffh,0ffh,0dfh  ;29h  - )
        db      0f5h,03fh,0fah,005h,0fah,03fh,0f5h,0efh  ;2ah  - *
        db      0dfh,0ffh,0dfh,030h,0dfh,0ffh,0dfh,0ffh  ;2bh  - +
        db      0ffh,07bh,0f7h,06bh,0ffh,0ffh,0ffh,0ffh  ;2ch  - ,
        db      0dfh,0ffh,0dfh,0ffh,0dfh,0ffh,0dfh,0ffh  ;2dh  - -
        db      0ffh,0ffh,0e7h,0ffh,0e7h,0ffh,0ffh,0ffh  ;2eh  - .
        db      0fdh,0bfh,0feh,0dfh,0fbh,07fh,0e7h,07fh  ;2fh  - /
        db      010h,0efh,0ffh,0efh,0ffh,0efh,010h,0abh  ;4fh  - 0
        db      0ffh,0efh,0ffh,000h,0ffh,0edh,0ffh,0efh  ;31h  - 1
        db      0ach,0ffh,0cfh,0ffh,0ebh,0ffh,065h,0abh  ;32h  - 2
        db      030h,0cfh,0ffh,0cfh,0ffh,0efh,0f5h,0abh  ;33h  - 3
        db      07fh,080h,07fh,0fdh,03fh,0feh,05bh,0bfh  ;34h  - 4
        db      053h,0efh,0feh,0efh,0feh,0efh,0b4h,055h  ;35h  - 5
        db      073h,0dfh,0edh,09fh,0eeh,0dfh,073h,0bfh  ;36h  - 6
        db      0bdh,0feh,0dfh,063h,0ffh,0ffh,0fdh,055h  ;37h  - 7
        db      030h,0cfh,0ffh,0cfh,0ffh,0cfh,030h,0abh  ;38h  - 8
        db      0bch,0dfh,0fbh,05fh,0f7h,0cfh,0bch,0d7h  ;39h  - 9
        db      0ffh,0ffh,0e5h,0ffh,0e5h,0ffh,0ffh,0d7h  ;3ah  - :
        db      0ffh,0ffh,079h,0f7h,069h,0ffh,0ffh,0d7h  ;3bh  - ;
        db      0ffh,0efh,0f5h,03fh,0fah,0dfh,0ffh,0bfh  ;3ch  - <
        db      0fah,0ffh,0fah,0ffh,0fah,0ffh,0fah,0ffh  ;3dh  - =
        db      0ffh,0dfh,0fah,03fh,0f5h,0efh,0ffh,0fbh  ;3eh  - >
        db      0bdh,0feh,0dfh,06bh,0ffh,0ffh,0bdh,0abh  ;3fh  - ?
        db      098h,06fh,0ffh,04ah,0ffh,0efh,010h,0abh  ;40h  - @
        db      042h,0bfh,0f9h,0ffh,0f9h,0bfh,042h,0efh  ;41h  - A
        db      030h,0dfh,0efh,0dfh,0efh,010h,0efh,0d5h  ;42h  - B
        db      0f5h,0efh,0ffh,0efh,0ffh,0efh,010h,0abh  ;43h  - C
        db      01ah,0f5h,0efh,0ffh,0efh,010h,0efh,0d5h  ;44h  - D
        db      0e5h,0dfh,0efh,0dfh,0efh,010h,0efh,055h  ;45h  - E
        db      0fdh,0dfh,0ffh,0dfh,0efh,010h,0efh,055h  ;46h  - F
        db      041h,0ffh,0d7h,0efh,0ffh,0efh,010h,0abh  ;47h  - G
        db      000h,0ffh,0dfh,0ffh,0dfh,0ffh,000h,07dh  ;48h  - H
        db      0ffh,0efh,0ffh,000h,0ffh,0efh,0ffh,0abh  ;49h  - I
        db      0ffh,0ffh,010h,0efh,0ffh,0efh,0f7h,057h  ;4ah  - J
        db      0efh,0f5h,03fh,0fah,0dfh,0ffh,000h,07dh  ;4bh  - K
        db      0e7h,0ffh,0efh,0ffh,0efh,0ffh,000h,0fdh  ;4ch  - L
        db      000h,0ffh,0fdh,09eh,0fdh,0ffh,000h,07dh  ;4dh  - M
        db      080h,07fh,0fbh,0dfh,0feh,0bfh,040h,07dh  ;4eh  - N
        db      010h,0efh,0ffh,0efh,0ffh,0efh,010h,0abh  ;4fh  - O
        db      0bch,0ffh,0dfh,0ffh,0dfh,0ffh,000h,0d5h  ;50h  - P
        db      010h,0efh,0f7h,06bh,0ffh,0efh,010h,0abh  ;51h  - Q
        db      0a4h,07fh,0dbh,0ffh,0dfh,0ffh,000h,0d5h  ;52h  - R
        db      071h,0dfh,0efh,0dfh,0efh,0dfh,0b4h,0d7h  ;53h  - S
        db      0ffh,0ffh,0ffh,000h,0ffh,0ffh,0ffh,055h  ;54h  - T
        db      010h,0efh,0ffh,0efh,0ffh,0efh,010h,07dh  ;55h  - U
        db      098h,07fh,0f7h,0efh,0f7h,07fh,098h,07dh  ;56h  - V
        db      000h,0ffh,0f7h,05bh,0f7h,0ffh,000h,07dh  ;57h  - W
        db      0e5h,03fh,0fah,0dfh,0fah,03fh,0e5h,07dh  ;58h  - X
        db      0fdh,0bfh,0eeh,053h,0eeh,0bfh,0fdh,07dh  ;59h  - Y
        db      0e5h,0bfh,0eeh,0dfh,0ebh,07fh,0e5h,055h  ;5ah  - Z
        db      0ffh,0ffh,0efh,0ffh,0efh,0ffh,000h,0d5h  ;5bh  - [
        db      0e7h,07fh,0fbh,0dfh,0feh,0bfh,0fdh,0fdh  ;5ch  - \
        db      000h,0ffh,0efh,0ffh,0efh,0ffh,0ffh,057h  ;5dh  - ]
        db      0feh,0bfh,0fdh,0ffh,0fdh,0bfh,0feh,0efh  ;5eh  - ^
        db      0efh,0ffh,0efh,0ffh,0efh,0ffh,0efh,0ffh  ;5fh  - _
        db      0ffh,0dah,0ffh,0dah,0ffh,0dah,0ffh,0ffh  ;60h  - .
        db      0efh,053h,0feh,0ebh,0feh,0ebh,077h,0ffh  ;61h  - a
        db      073h,0ffh,0cfh,0ffh,0cfh,0ffh,000h,0fdh  ;62h  - b
        db      0cfh,0ffh,0cfh,0ffh,0cfh,0ffh,073h,0ffh  ;63h  - c
        db      000h,0ffh,0cfh,0ffh,0cfh,0ffh,073h,07fh  ;64h  - d
        db      07bh,0cfh,07fh,0cfh,07fh,0cfh,073h,0ffh  ;65h  - e
        db      0feh,0ffh,0feh,001h,0feh,0ffh,0feh,05fh  ;66h  _ f
        db      053h,0eeh,07fh,0eeh,07fh,0eeh,05bh,0ffh  ;67h  - g
        db      063h,0dfh,0ffh,0dfh,0fbh,0ffh,000h,0fdh  ;68h  - h
        db      0ffh,0ffh,0efh,013h,0efh,0ffh,0ffh,0ffh  ;69h  - i
        db      0ffh,0ffh,012h,0efh,0ffh,0efh,0f7h,0dfh  ;6ah  - j
        db      0ffh,0eeh,0f7h,05fh,0fbh,0ffh,000h,0fdh  ;6bh  - k
        db      0ffh,0ffh,0efh,010h,0efh,0fdh,0ffh,0efh  ;6ch  _ l
        db      063h,0dfh,0ffh,063h,0dfh,0ffh,043h,0ffh  ;6dh  - m
        db      063h,0dfh,0ffh,0dfh,0fbh,0ffh,043h,0ffh  ;6eh  - n
        db      073h,0cfh,0ffh,0cfh,0ffh,0cfh,073h,0ffh  ;6fh  - o
        db      0dbh,0ffh,07eh,0ffh,07eh,0ffh,042h,0ffh  ;70h  - p
        db      042h,0ffh,07eh,0ffh,07eh,0ffh,0dbh,0ffh  ;71h  - q
        db      0ffh,0dfh,0ffh,0dfh,0fbh,0ffh,043h,0ffh  ;72h  _ r
        db      0d7h,07fh,0cfh,07fh,0cfh,07fh,0ebh,0ffh  ;73h  - s
        db      0eeh,0ffh,0eeh,011h,0feh,0ffh,0feh,0efh  ;74h  - t
        db      043h,0ffh,0f7h,0efh,0ffh,0efh,053h,0ffh  ;75h  - u
        db      0dbh,07fh,0f7h,0efh,0f7h,07fh,0dbh,0ffh  ;76h  - v
        db      053h,0efh,0ffh,073h,0ffh,0efh,053h,0ffh  ;77h  - w
        db      0cfh,0f3h,0ffh,07fh,0ffh,0f3h,0cfh,0ffh  ;78h  _ x
        db      052h,0efh,0fbh,0efh,0fbh,0efh,0dah,0ffh  ;79h  - y
        db      0cfh,0fbh,0cfh,07fh,0cfh,0f7h,0cfh,0ffh  ;7ah  - z
        db      0cfh,0f3h,0ffh,03ch,0ffh,0f3h,0cfh,055h  ;7bh  - Tx
        db      000h,0ffh,000h,0ffh,000h,0ffh,000h,055h  ;7ch  - 
        db      0dfh,0ffh,0dfh,0ffh,01fh,0fah,0dfh,0ffh  ;7dh  - <-
        db      07fh,0f7h,0ffh,000h,0ffh,0f7h,07fh,0efh  ;7eh  - \|/
        db      0bfh,0fdh,0ffh,000h,0ffh,0fdh,0bfh,0efh  ;7fh  - /|\
        db      0d7h,06fh,0dbh,0efh,0dfh,0efh,0b4h,057h  ;80h  - 
        db      073h,0aeh,0ffh,0efh,0ffh,0aeh,073h,0ffh  ;81h  - 
        db      07bh,0cfh,07dh,08fh,07fh,0cfh,073h,0ffh  ;82h  - 
        db      0efh,051h,0feh,0ebh,0feh,0e9h,077h,0d7h  ;83h  - 
        db      0efh,051h,0feh,0ebh,0feh,0e9h,077h,0bbh  ;84h  - 
        db      0efh,053h,0feh,0e9h,0feh,0ebh,077h,0f7h  ;85h  - 
        db      0efh,053h,0fch,0ebh,0fch,0ebh,077h,0d7h  ;86h  - 
        db      0b3h,06fh,0bbh,0efh,0bbh,0efh,0d6h,0ffh  ;87h  - 
        db      07bh,08fh,07dh,0cfh,07dh,08fh,073h,0ffh  ;88h  - 
        db      07bh,08dh,07fh,0cfh,07fh,08dh,073h,0ffh  ;89h  - 
        db      07bh,0cfh,03fh,0cdh,07fh,0cfh,073h,0ffh  ;8ah  - 
        db      0ffh,0bdh,0efh,053h,0efh,0bdh,0ffh,0ffh  ;8bh  - 
        db      0ffh,0bfh,0edh,053h,0edh,0bfh,0ffh,0ffh  ;8ch  - 
        db      0ffh,0ffh,0afh,051h,0efh,0ffh,0ffh,0ffh  ;8dh  - 
        db      063h,0ddh,07eh,0ffh,07eh,0ddh,063h,0bbh  ;8eh  - 
        db      063h,0dfh,07ch,0ffh,07ch,0dfh,063h,0d7h  ;8fh  - 
        db      04fh,0ffh,04dh,0bfh,04fh,0ffh,043h,0ffh  ;90h  _ 
        db      0cbh,07fh,0cfh,073h,0cfh,07fh,0c7h,0ffh  ;91h  - 
        db      0afh,0fbh,0afh,052h,0bfh,07eh,0c3h,0ffh  ;92h  - 
        db      077h,0abh,0fdh,0ebh,0fdh,0abh,077h,0ffh  ;93h  - 
        db      077h,0a9h,0ffh,0ebh,0ffh,0a9h,077h,0ffh  ;94h  - 
        db      077h,0ebh,0bfh,0e9h,0ffh,0ebh,077h,0ffh  ;95h  - 
        db      073h,0eeh,0bfh,0efh,0bfh,0eeh,073h,0ffh  ;96h  - 
        db      073h,0efh,0feh,0afh,0ffh,0efh,073h,0ffh  ;97h  - 
        db      053h,0adh,07fh,0efh,07fh,0adh,05bh,0ffh  ;98h  - 
        db      073h,0cdh,0ffh,0cfh,0ffh,0cdh,073h,0bbh  ;99h  - 
        db      053h,0adh,0ffh,0efh,0ffh,0adh,053h,0ffh  ;9ah  - 
        db      0fah,03fh,0ffh,000h,0ffh,03fh,0dah,0efh  ;9bh  - 
        db      0efh,0bfh,0cdh,0ffh,0cdh,032h,0cfh,0ffh  ;9ch  - 
        db      0ddh,0bfh,0deh,063h,0deh,0bfh,0ddh,0ffh  ;9dh  - 
        db      07fh,0e3h,07fh,0feh,09fh,0ffh,002h,0ffh  ;9eh  - 
        db      0feh,0ffh,0bbh,056h,0ebh,0ffh,0f7h,0ffh  ;9fh  - 
        db      0efh,053h,0feh,0e9h,0feh,0ebh,077h,0dfh  ;a0h  - 
        db      0ffh,0ffh,0edh,013h,0efh,0ffh,0ffh,0ffh  ;a1h  - 
        db      077h,0ebh,0ffh,0e9h,0bfh,0ebh,077h,0ffh  ;a2h  - 
        db      073h,0efh,0ffh,0afh,0feh,0efh,073h,0ffh  ;a3h  - 
        db      061h,09fh,0ffh,09fh,0f9h,0ffh,003h,0ffh  ;a4h  - 
        db      041h,0bfh,0f7h,03fh,0f9h,0ffh,003h,0ffh  ;a5h  - 
        db      0ffh,090h,0ffh,0f0h,0ffh,0d3h,0ffh,0ffh  ;a6h  - 
        db      0ffh,07eh,09fh,07fh,09fh,07eh,0ffh,0ffh  ;a7h  - 
        db      077h,0efh,0ffh,0aeh,0dfh,0ebh,077h,0efh  ;a8h  - 
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;a9h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;aah  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;abh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;ach  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;adh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;aeh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;afh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b0h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b1h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b2h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b3h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b4h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b5h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b6h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b7h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b8h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;b9h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;bah  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;bbh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;bch  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;bdh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;beh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;bfh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c0h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c1h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c2h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c3h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c4h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c5h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c6h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c7h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c8h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;c9h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;cah  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;cbh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;cch  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;cdh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;ceh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;cfh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d0h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d1h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d2h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d3h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d4h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d5h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d6h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d7h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d8h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;d9h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;dah  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;dbh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;dch  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;ddh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;deh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;dfh  ------
        db      0eeh,05bh,0f7h,0cfh,0ffh,0cfh,073h,0ffh  ;e0h  - 
        db      03ah,0d5h,0ffh,0d5h,0bfh,052h,0efh,0ffh  ;e1h  - 
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;e2h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;e3h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;e4h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;e5h  ------
        db      05bh,0ffh,0f7h,07bh,0f7h,0ffh,043h,0ffh  ;e6h  - 
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;e7h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;e8h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;e9h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;eah  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;ebh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;ech  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;edh  ------
        db      0eeh,0ffh,0eah,0ffh,0f0h,01fh,0fah,05fh  ;eeh  - 
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;efh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f0h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f1h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f2h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f3h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f4h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f5h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f6h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f7h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f8h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;f9h  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;fah  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;fbh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;fch  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;fdh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;feh  ------
        db      0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh,0ffh  ;ffh  ------
        db      0cfh,0f3h,0ffh,03ch,0ffh,0f3h,0cfh,055h  ;??h  - T
        db      0ffh,0fbh,04fh,0bch,0c7h,0ffh,0ebh,055h  ;??h  -
        db      0ffh,07fh,0cfh,03ch,0cfh,0ffh,0f3h,055h  ;??h  -
        db      0ffh,0ffh,0cdh,033h,0cfh,0ffh,0ffh,0ffh  ;??h  _ I
        db      053h,0efh,0fdh,0afh,0ffh,0efh,053h,0ffh  ;??h  - U
        db      0ffh
        db      0ffh
        db      0ffh
                ;
rtc_read:     clr        ie.1                   ;display
              clr        ie.2                   ;
                                                ;
              mov        a,#08h                 ;enable and bank 0 select
              lcall      rtc_conv1              ;
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;
              ;                                 ;
              mov        dptr,#rtc_1sec         ;1 sec
              movx       a,@dptr                ;
              lcall      rtc_conv2              ;
              mov        r1,a                   ;
              mov        dptr,#rtc_10sec        ;10 sec
              movx       a,@dptr                ;
              lcall      rtc_conv2              ;
              cjne       a,#05h,rtcread         ;
              cjne       r1,#09h,rtcread        ;59 sec
                                                ;
              mov        a,#0h                  ;
              mov        dptr,#rtc_test         ;test
              movx       @dptr,a                ;rtc stop
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;
              ;                                 ;
rtcread:      mov        r1,#0h                 ;
              mov        dptr,#rtcb_flg         ;rtc buffer 13ea(+1 dummy)
              mov        r3,dph                 ;
              mov        r4,dpl                 ;
readrp:       mov        a,r1                   ;
              mov        dptr,#rtc_base_add     ;rtc_1sec point
              movc       a,@a+dptr              ;fetch low address
              mov        dptr,#rtc_add          ;FF40h
              mov        dpl,a                  ;
              movx       a,@dptr                ;
              lcall      rtc_conv2              ;
              mov        dph,r3                 ;
              mov        dpl,r4                 ;
              movx       @dptr,a                ;
              inc        r4                     ;point inc
              inc        r1                     ;point inc
              mov        a,r1                   ;
              cjne       a,#0dh,readrp          ;read until year10 13ea
              ;                                 ;
              mov        a,#08h                 ;
              lcall      rtc_conv1              ;
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;rtc enable
              setb       ie.1                   ;
              setb       ie.2                   ;
rtcerr:
              LJMP    ?X_RET_L18
              ;---------------------------------;
rtc_base_add: db         040h   ;0000-  0000    ;sec
              db         050h   ;0001-  1000    ;
rtc_min_base: db         048h   ;0010-  0100    ;min
              db         058h   ;0011-  1100    ;
              db         044h   ;0100-  0010    ;hour
              db         054h   ;0101-  1010    ;
rtc_wek_base: db         04Ch   ;0110-  0110    ;week
              db         05Ch   ;0111-  1110    ;dd
              db         042h   ;1000-  0001    ;
              db         052h   ;1001-  1001    ;mm
              db         04Ah   ;1010-  0101    ;
              db         05Ah   ;1011-  1101    ;yy
              db         046h   ;1100-  0011    ;
              db         000h
;***********************************************;
;***           RTC WRITE ROUTINE             ***;
;***********************************************;
rtc_write:    mov        dptr,#rtcb_flg+7       ;
              movx       a,@dptr                ;
              cjne       a,#04h,datechk         ;
              sjmp       timepgm                ;time program
datechk:      cjne       a,#07h,rtcerr          ;
              ljmp       datepgm                ;date program
              ;*********************************;
timepgm:      clr        ie.1                   ;
              clr        ie.2                   ;
;;;           clr        ie.3                   ;
              mov        a,#0h                  ;test rest
              mov        dptr,#rtc_test         ;
              movx       @dptr,a                ;
              ;---------------------------------;mode set
              mov        a,#01h                 ;
              lcall      rtc_conv1              ;
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;bank 1 select & rtc stop
              mov        dptr,#rtc_10mon        ;
              movx       @dptr,a                ;24 base
              ;                                 ;
              mov        a,#0h                  ;
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;bank 0 select
              ;---------------------------------;data set
              mov        a,#0h                  ;
              mov        dptr,#rtc_1sec         ;
              movx       @dptr,a                ;sec 1
              mov        dptr,#rtc_10sec        ;
              movx       @dptr,a                ;sec 10
              ;                                 ;
              mov        r1,#0h                 ;Time 4 pgm
              mov        dptr,#rtcb_flg         ;
              mov        r3,dph                 ;
              mov        r4,dpl                 ;
              ;                                 ;
writerp:      mov        dph,r3                 ;
              mov        dpl,r4                 ;
              movx       a,@dptr                ;
              lcall      rtc_conv1              ;
              mov        r2,a                   ;save temp
              mov        a,r1                   ;
              mov        dptr,#rtc_min_base     ;rtc_1sec point
              movc       a,@a+dptr              ;fetch low address
              mov        dptr,#rtc_add          ;
              mov        dpl,a                  ;
              mov        a,r2                   ;retrive temp save data
              movx       @dptr,a                ;
              inc        r1                     ;point inc
              inc        r4                     ;point inc
              mov        a,r1                   ;
              cjne       a,#04h,writerp         ;
              ljmp       rtcpgmend              ;
              ;*********************************;
datepgm:      clr        ie.1                   ;
              clr        ie.2                   ;
;;;           clr        ie.3                   ;
              mov        a,#0h                  ;test rest
              mov        dptr,#rtc_test         ;
              movx       @dptr,a                ;
              ;---------------------------------;mode set
              mov        a,#01h                 ;
              lcall      rtc_conv1              ;
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;bank 1 select & rtc stop
              mov        dptr,#rtcb_flg+8       ;leap year insert
              movx       a,@dptr                ;
              lcall      rtc_conv1              ;
              mov        dptr,#rtc_1year        ;
              movx       @dptr,a                ;
              ;                                 ;
              mov        a,#0h                  ;
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;bank 0 select
              ;---------------------------------;data set
              mov        r1,#0h                 ;Date 7 pgm
              mov        dptr,#rtcb_flg         ;
              mov        r3,dph                 ;
              mov        r4,dpl                 ;
              ;                                 ;
writerpp:     mov        dph,r3                 ;
              mov        dpl,r4                 ;
              movx       a,@dptr                ;
              lcall      rtc_conv1              ;
              mov        r2,a                   ;save temp
              mov        a,r1                   ;
              mov        dptr,#rtc_wek_base     ;week point
              movc       a,@a+dptr              ;fetch low address
              mov        dptr,#rtc_add          ;
              mov        dpl,a                  ;
              mov        a,r2                   ;retrive temp save data
              movx       @dptr,a                ;
              inc        r1                     ;point inc
              inc        r4                     ;point inc
              mov        a,r1                   ;
              cjne       a,#07h,writerpp        ;
              ;                                 ;
rtcpgmend:    mov        a,#08h                 ;
              lcall      rtc_conv1              ;
              mov        dptr,#rtc_mode         ;
              movx       @dptr,a                ;timer enable
              setb       ie.1                   ;
              setb       ie.2                   ;
;;;           setb       ie.3                   ;
              LJMP    ?X_RET_L18
                ;                              ;
;***********************************************;
;***               MODE KEY CHECK            ***;
;***********************************************;
modescan:
                clr     ie.1                    ;
                clr     ie.2                    ;
                mov     dptr,#kmod_addr         ;f87eh
                clr     p1.0                    ;
                movx    a,@dptr                 ;output rt data
                nop                             ;
                setb    p1.0                    ;
                nop                             ;
                xrl     a,#0ffh                 ;read data conversion
                anl     a,#7fh
                jz      mk_skip                 ;
                mov     r1,a                    ;
                clr     c                       ;skip multi return data
rrc_c:          rrc     a                       ;rotate right
                jnc     rrc_c                   ;until carry
                jnz     mk_skip                 ;multi
                mov     a,r1                    ;
                mov     dptr,#mode_id           ;
                movx    @dptr,a                 ;
                ;                               ;
                jmp     no_change               ; PKR0624
;                jb      acc.1,chg_chk           ;MMODE
;                jb      acc.2,chg_chk           ;PMODE
;                mov     a,rom_flg               ;
;                jnb     acc.0,no_change         ;
;                mov     rom_flg,#0h             ;
;                clr     p1.2                    ;
;                nop                             ;
;                nop                             ;
;                nop                             ;
;                nop                             ;
;                sjmp    rom_chg                 ;
;                ;                               ;
;chg_chk:        mov     a,rom_flg               ;rom change !!!
;                jb      acc.0,no_change         ;
;                mov     rom_flg,#01h            ;
;                setb    p1.2                    ;rom change !!!
;                nop                             ;
;                nop                             ;
;                nop                             ;
;                nop                             ;
;rom_chg:        ;;;;;;; STACK POINT CLEAR ;;;;;;;
;                mov     sp,#stack_begin         ;stack initial 30H -
;                mov     dptr,#main              ;
;                mov     a,dpl                   ;
;                push    acc                     ;
;                mov     a,dph                   ;
;                push    acc                     ;
;                ;                               ;
no_change:      nop                             ;
                nop                             ;
                nop                             ;
                nop                             ;
mk_skip:        setb    ie.1                    ;
                setb    ie.2                    ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                ;;  Test 12/10
                ;;setb    ie.0                    ;
                ;;setb    ie.7                    ;
                ;;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                LJMP    ?X_RET_L18
                ;
;-----------------------------------------------;
;            display init of OMODE              ;
;-----------------------------------------------;
init_omode:     mov     dptr,#flg_dis_txtmp     ;
                mov     r0,#0ah                 ;
                mov     a,#022d                 ;
                lcall   fill_da                 ;
                mov     dptr,#decp_buf          ;
                mov     r0,#0ah                 ;
                mov     a,#0h                   ;
                lcall   fill_da                 ;
                lcall   outdtx                  ;
                LJMP    ?X_RET_L18
                ;
;-----------------------------------------------;
;             error on buzzer service           ;
;-----------------------------------------------;
erroron:
IF 0
;;; insert for printer disconnection error 96.9.4
                mov     a,jam_flg
                cjne    a,00h,e_wait1
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   inidtx                  ;
                clr     kdec_bit                ;
                mov     dptr,#errmsg            ;
                movx    a,@dptr                 ;
                jnz     chk_msg                 ;
                mov     a,#01h                  ;
                sjmp    out_msg                 ;
chk_msg:        cjne    a,#03h,out_msg          ;
                sjmp    e_wait                  ;

out_msg:        clr     c                       ;
                cjne    a,#10d,ck_msg           ;
ck_msg:         jc      out_msg1                ;
                subb    a,#10d
                mov     dptr,#flg_dis_txtmp+7   ;10 over
                movx    @dptr,a                 ;
                mov     a,#01h                  ;
out_msg1:       mov     dptr,#flg_dis_txtmp+8   ;
                movx    @dptr,a                 ;
                inc     dptr                    ;
                mov     a,#0eh                  ;
                movx    @dptr,a                 ;
                lcall   outdtx                  ;
ENDIF
e_wait:         jnb     pover_bit,e_wait        ;
e_wait1:
                mov     buzz_cnt,#0h            ;
                mov     dptr,#SYS_OPT+1         ;SYS_OPT.OPT2_1
                movx    a,@dptr                 ;
                jnb     acc.0,buz_skip2
                clr     p1.4                    ;buzzer on
buz_skip2:
                LJMP    ?X_RET_L18
                ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;   TRANS SLIP ROUTINE   ;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
chk_runover:    clr     c                       ;
                mov     a,siotm_cnt1            ;
                cjne    a,#010h,run             ;about 10 sec
run:            jc      run_ret                 ;buffer full waiting time
                setb    err_bit                 ;
run_ret:        ret
                ;
com_trans:;PKR0515      clr     ie.4                    ;
wait_dtr:       mov     dptr,#ptr_read          ;
                movx    a,@dptr                 ;
                jb      acc.5,ok_dtr            ;DTR check
                lcall   chk_runover             ;
                jb      err_bit,slip_err        ;
                sjmp    wait_dtr                ;time_out check = later !!!
slip_err:       mov     comm_err,#09h           ;time over
                ret                             ;
                ;                               ;
ok_dtr:         mov     dptr,#comm_buff         ;
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                jnc     t_cho                   ;
                inc     dph                     ;
t_cho:          mov     dpl,a                   ;
                movx    a,@dptr                 ;
                clr     ie.7                    ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                setb    ie.7                    ;
                inc     io_cnt                  ;
                mov     a,io_cnt                ;
                mov     siotm_cnt0,#0h          ;runtime out counter
                mov     siotm_cnt1,#0h          ;
                cjne    a,trx_buf_cnt,wait_dtr  ;
                ret                             ;
                ;                               ;
slip_trans:     jnb     pover_bit,slip_trans
                mov     s_out_flg,#00h          ;trans int active flg
                mov     comm_err,#0h            ;time over
                mov     siotm_cnt0,#0h          ;runtime out counter
                mov     siotm_cnt1,#0h          ;
                mov     io_cnt,#0h              ;
                lcall   com_trans               ;
                ;
;                mov     dptr,#prt_buffer        ;with space = blank
;                mov     r0,#0100d               ;
;                mov     a,#' '                  ;
;fill_0:         movx    @dptr,a                 ;
;                inc     dptr                    ;
;                djnz    r0,fill_0               ;
                ;
                LJMP    ?X_RET_L18
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
modem_trans:    jnb     pover_bit,modem_trans
                mov     s_out_flg,#00h          ;trans int active flg
                mov     comm_err,#0h            ;time over
                mov     siotm_cnt0,#0h          ;runtime out counter
                mov     siotm_cnt1,#0h          ;
                mov     io_cnt,#0h              ;
                ;
;PKR0515                clr     ie.4                    ;
t_cho0:         mov     dptr,#comm_buff         ;
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                jnc     t_cho1                  ;
                inc     dph                     ;
t_cho1:         mov     dpl,a                   ;
                movx    a,@dptr                 ;
                clr     ie.7                    ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                setb    ie.7                    ;
                inc     io_cnt                  ;
                mov     a,io_cnt                ;
                mov     siotm_cnt0,#0h          ;runtime out counter
                mov     siotm_cnt1,#0h          ;
                cjne    a,trx_buf_cnt,t_cho0    ;
                ;
                LJMP    ?X_RET_L18
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;   TRANS SCALE ROUTINE   ;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
scale_trans:    jnb     pover_bit,scale_trans
                clr     ie.7                    ; PKR0515
                mov     s_out_flg,#0h           ;trans int active flg
                mov     comm_err,#0h            ;time over
                mov     a,#SCALE_CMD1           ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                mov     a,#SCALE_CMD2           ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                ;
;                setb    ie.4                    ;PKR0515
                setb    ie.7                    ;
                mov     s_in_flg,#01h           ;recev int active flg
                mov     rend_flg,#0h            ;receive ending flg
                mov     comm_kind,#02h          ;comm_kind = 2 : SCALE
                mov     io_cnt,#0h              ;
                mov     siotm_cnt0,#0h          ;runtime out counter
                mov     siotm_cnt1,#0h          ;
                ;                               ;
wait_read:      mov     a,rend_flg              ;
                ;TIMER OUT CHECK ;;;;;;;;;;;;;;;;
                cjne    a,#01h,chk_tmout        ;
scale_ret:;PKR0515      clr     ie.4                    ;sio int disable
                mov     s_in_flg,#0h            ;
                LJMP    ?X_RET_L18
chk_tmout:      clr     c                       ;
                mov     a,siotm_cnt1            ;
                cjne    a,#010h,tmmm            ;about 5 sec
tmmm:           jc      wait_read               ;
                setb    err_bit                 ;
                mov     comm_err,#09h           ;time over
                sjmp    scale_ret               ;
                ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;test_chk:       jnb     pover_bit,test_chk
;                clr     ie.7                    ; PKR0515
;                clr     scon.0                  ;
;                jnb     scon.0,$                ;
;                clr     scon.0                  ;
;                setb    ie.7                    ; PKR0515
;                LJMP    ?X_RET_L18
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;; RECEIVE LOOP ROUTINE  ;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
chk_clrkey:     mov     r1,#CLSCAN_LINE         ;Clear (e0)
                lcall   fky_scan                ;high key chk
                cjne    a,#CLRETN_DATA,w_r      ;column mult chk
                mov     a,#0h                   ;
                mov     dptr,#flg_key_pend      ;
                movx    @dptr,a                 ;
                lcall   rflg_init               ;
                mov     rend_flg,#03h           ;
                mov     comm_status,#01h        ;
;PKR0515                clr     ie.4                    ;sio int disable
                LJMP    ?X_RET_L18
                jmp     w_r
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
sio_rvlp:       mov     rend_flg,#0h            ;receive ending flg
                lcall   rflg_init               ;receive flag initial
                mov     s_in_flg,#01h           ;recev int active flg
                setb    ie.4                    ;sio int enable
                ;                               ;
                mov     io_cnt,#0h              ;
w_r:            mov     a,rend_flg              ;
                cjne    a,#02h,chk_clrkey       ;
                mov     s_in_flg,#0h            ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                call   rvd_vcheck               ;receive data valid check
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                nop                             ;
                mov     a,r4                    ;
                cjne    a,#01h,send_ackok       ;
                mov     comm_status,#01h        ;receive comm fail !
                lcall   send_nack               ;
                sjmp    set_iocnt               ;
                ;                               ;
send_ackok:     lcall   send_ack                ;
                mov     comm_status,#0h         ;receive comm success !
set_iocnt:      mov     a,io_cnt                ;
                mov     trx_buf_cnt,a           ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                lcall   rflg_init               ;receive flag initial
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
                sjmp    sio_end                 ;
                ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;sio_trans:      mov     s_out_flg,#01h          ;trans int active flg
;;;                setb    ie.4                    ;sio int enable
;;;                ;                               ;
;;;                mov     tend_flg,#0h            ;
;;;                mov     io_cnt,#01h             ;
;;;                mov     dptr,#comm_buff         ;
;;;                movx    a,@dptr                 ;
;;;                mov     sbuf,a                  ;
;;;w_tt:           mov     a,tend_flg              ;
;;;                cjne    a,#01h,w_tt             ;
;;;                mov     s_out_flg,#00h          ;trans int active flg
;;;                ; ack / nack recv               ;
;;;                lcall   rflg_init               ;receive flag initial
;;;                ;                               ;
;;;chk_tack:       mov     a,ack_flg               ;
;;;                cjne    a,#01h,chk_tnack        ;
;;;                mov     comm_status,#0h         ;
;;;                sjmp    sio_end                 ;
;;;chk_tnack:      mov     a,nack_flg              ;
;;;                cjne    a,#01h,chk_tack         ;
;;;                mov     comm_status,#01h        ;
;;;                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;sio_end:        clr     ie.4                    ;sio int disable
;;;                LJMP    ?X_RET_L18
;;;                ;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
chk_clrkey1:    mov     r1,#CLSCAN_LINE         ;Clear (e0)
                lcall   fky_scan                ;high key chk
                cjne    a,#CLRETN_DATA,chk_tack ;column mult chk
                mov     a,#0h                   ;
                mov     dptr,#flg_key_pend      ;
                movx    @dptr,a                 ;
                lcall   rflg_init               ;
                mov     rend_flg,#03h           ;
                mov     comm_status,#01h        ;
;PKR0515                clr     ie.4                    ;sio int disable
                LJMP    ?X_RET_L18
                jmp     chk_tack
                ;                               ;
sio_trans:      jnb     pover_bit,sio_trans     ;trans int active flg
                mov     s_out_flg,#0h           ;trans int active flg
                mov     tend_flg,#0h            ;
                mov     io_cnt,#0h              ;
;PKR0515                clr     ie.4                    ;
pc_send:        mov     dptr,#comm_buff         ;
                mov     a,dpl                   ;
                clr     c                       ;
                add     a,io_cnt                ;
                jnc     t_choo                  ;
                inc     dph                     ;
t_choo:         mov     dpl,a                   ;
                movx    a,@dptr                 ;
                clr     ie.7                    ;
                mov     sbuf,a                  ;
                jnb     scon.1,$                ;
                clr     scon.1                  ;
                setb    ie.7                    ;
                inc     io_cnt                  ;
                mov     a,io_cnt                ;
                cjne    a,trx_buf_cnt,pc_send   ;
                ; ack / nack recv               ;
                setb    ie.4                    ;receive flag initial
                ;                               ;
chk_tack:       mov     a,ack_flg               ;
                cjne    a,#01h,chk_tnack        ;
                mov     comm_status,#0h         ;
                sjmp    sio_end                 ;
chk_tnack:      mov     a,nack_flg              ;
                cjne    a,#01h,chk_clrkey1      ;
                mov     comm_status,#01h        ;
                ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
sio_end:;PKR0515        clr     ie.4                    ;sio int disable
                LJMP    ?X_RET_L18
;---------------------------------------------;
        end        startup                    ;
;---------------------------------------------;
